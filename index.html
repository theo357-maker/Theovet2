 <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hybrilink - Gestion de Commerce</title>
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Ajoutez après les autres scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Dans la section <head>, ajoutez cette ligne après les autres scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --primary-light: #ebf5fb;
      --secondary: #2c3e50;
      --secondary-light: #34495e;
      --success: #27ae60;
      --success-dark: #219653;
      --success-light: #d5f4e6;
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --danger-light: #fde8e6;
      --warning: #f39c12;
      --warning-dark: #e67e22;
      --warning-light: #fef5e7;
      --info: #17a2b8;
      --info-dark: #138496;
      --info-light: #e3f2fd;
      --light: #ecf0f1;
      --light-dark: #bdc3c7;
      --dark: #2c3e50;
      --gray: #95a5a6;
      --gray-light: #ecf0f1;
      --gray-dark: #7f8c8d;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15);
      --radius: 8px;
      --radius-sm: 4px;
      --radius-lg: 12px;
      --transition: all 0.3s ease;
      --transition-fast: all 0.15s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      font-size: 14px;
    }
    
    /* Container d'authentification */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .auth-form {
      background: var(--white);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 450px;
      border-top: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }
    
    .auth-form::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
    }

/* Ajoutez ce code dans votre section <style> */

/* Style pour le tableau des statistiques */
#statsTable {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--light-dark);
}

#statsTable thead {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
    color: white;
}

/* Amélioration du sélecteur de type */
#statsType {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid var(--primary-light);
    border-radius: var(--radius);
    padding: 12px 15px;
    font-size: 1rem;
    color: var(--secondary);
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.1);
}

#statsType:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    outline: none;
    background: #ffffff;
}

/* Style pour les dates */
#statsStartDate, #statsEndDate {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid var(--primary-light);
    border-radius: var(--radius);
    padding: 12px 15px;
    font-size: 1rem;
    color: var(--secondary);
    transition: all 0.3s ease;
}

#statsStartDate:focus, #statsEndDate:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    outline: none;
    background: #ffffff;
}

#statsTable th {
    background: transparent;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding: 15px 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

#statsTable tbody tr {
    background: rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
}

#statsTable tbody tr:nth-child(even) {
    background: rgba(52, 152, 219, 0.05);
}

#statsTable tbody tr:hover {
    background: rgba(52, 152, 219, 0.1);
    transform: translateX(5px);
}

#statsTable td {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 12px 10px;
    color: var(--secondary);
}

/* Style pour les cartes de statistiques */
.stats-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: var(--radius);
    padding: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, #ffffff 0%, #e9ecef 100%);
}

.stats-card h4 {
    color: var(--secondary);
    margin-bottom: 15px;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.stats-card h4 i {
    color: var(--primary);
    font-size: 1.2rem;
}

.stats-value {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 15px 0;
    background: linear-gradient(135deg, var(--primary), var(--info));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stats-trend {
    font-size: 0.9rem;
    color: var(--gray);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

/* Style pour le conteneur du graphique */
.canvas-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 25px;
    border-radius: var(--radius);
    border: 1px solid var(--light-dark);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.canvas-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--success));
}

/* Style pour la section principale */
#statistics .section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    border: 1px solid var(--light-dark);
    position: relative;
    overflow: hidden;
}

#statistics .section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
}

/* Style pour les boutons d'export */
#statsExportButtons .btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
    color: white;
    border: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

#statsExportButtons .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

#statsExportButtons .btn-warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
}

#statsExportButtons .btn-warning:hover {
    box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
}

#statsExportButtons .btn-success {
    background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
}

#statsExportButtons .btn-success:hover {
    box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
}

/* Style pour le résumé */
#statsSummary {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(46, 204, 113, 0.1) 100%);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid rgba(52, 152, 219, 0.2);
    margin-top: 20px;
}

#statsSummary h4 {
    color: var(--secondary);
    margin-bottom: 15px;
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Style pour l'état vide */
#emptyStats {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
    border-radius: var(--radius);
    padding: 40px;
    border: 2px dashed var(--light-dark);
}

#emptyStats i {
    font-size: 4rem;
    background: linear-gradient(135deg, var(--primary), var(--info));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
}

#emptyStats p {
    color: var(--secondary);
    font-size: 1.1rem;
    font-weight: 600;
}

#emptyStats .text-muted {
    color: var(--gray);
    font-size: 0.9rem;
    font-weight: normal;
}

/* Style pour les cartes de statistiques avancées */
#advancedStatsContent .stats-card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

#advancedStatsContent .stats-card h4 {
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--info-light) 100%);
    padding: 12px;
    margin: -25px -25px 20px -25px;
    border-radius: var(--radius) var(--radius) 0 0;
    color: var(--secondary);
    font-size: 1rem;
}

/* Style pour les images dans les tableaux */
.article-image-stat {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid var(--primary-light);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.article-image-stat:hover {
    transform: scale(1.05);
    border-color: var(--primary);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
}

.article-image-stat-placeholder {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--light) 0%, var(--primary-light) 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    border: 2px solid var(--light-dark);
    font-size: 1.5rem;
}

/* Responsive design pour les statistiques */
@media (max-width: 768px) {
    .stats-card {
        padding: 20px 15px;
    }
    
    .stats-value {
        font-size: 2rem;
    }
    
    #statsTable th,
    #statsTable td {
        padding: 10px 8px;
        font-size: 0.85rem;
    }
    
    .article-image-stat {
        width: 50px;
        height: 50px;
    }
    
    .article-image-stat-placeholder {
        width: 50px;
        height: 50px;
    }
}
    
    .auth-form h2 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--secondary);
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    .auth-logo {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .auth-logo i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Application principale */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 25px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border-top: 4px solid var(--primary);
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
    }
    
    h1 {
      color: var(--secondary);
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      font-weight: 800;
    }
    
    .tagline {
      color: var(--gray);
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--light);
      padding: 10px 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      border: 1px solid var(--light-dark);
    }
    
    .user-role {
      background: var(--primary);
      color: white;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    /* Badges de rôle */
    .badge-vendeur { 
      background: var(--success); 
      color: white; 
    }
    
    .badge-gerant { 
      background: var(--warning); 
      color: var(--dark); 
    }
    
    .badge-admin { 
      background: var(--danger); 
      color: white; 
    }
    
    .badge-super_admin { 
      background: #6f42c1; 
      color: white; 
    }
    
    /* Navigation par onglets */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--light-dark);
    }
    
    .tab-button {
      padding: 15px 20px;
      background: var(--light);
      border: none;
      cursor: pointer;
      font-weight: 600;
      flex-grow: 1;
      text-align: center;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--dark);
      border-right: 1px solid var(--light-dark);
    }
    
    .tab-button:last-child {
      border-right: none;
    }
    
    .tab-button:hover {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .tab-button.active {
      background: var(--primary);
      color: var(--white);
      box-shadow: inset 0 -3px 0 var(--primary-dark);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    /* Styles communs */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      border-left: 4px solid var(--primary);
      border: 1px solid var(--light-dark);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .card:nth-child(1) { border-left-color: var(--primary); }
    .card:nth-child(2) { border-left-color: var(--success); }
    .card:nth-child(3) { border-left-color: var(--warning); }
    .card:nth-child(4) { border-left-color: var(--danger); }
    
    .card h3 {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 600;
    }
    
    .card-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 15px 0;
      color: var(--primary);
    }
    
    .card:nth-child(2) .card-value { color: var(--success); }
    .card:nth-child(3) .card-value { color: var(--warning); }
    .card:nth-child(4) .card-value { color: var(--danger); }
    
    .card-trend {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      color: var(--gray);
    }
    
    .trend-up {
      color: var(--success);
    }
    
    .trend-down {
      color: var(--danger);
    }
    
    .section {
      background: var(--white);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      transition: var(--transition);
      border: 1px solid var(--light-dark);
    }
    
    .section:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .section-title {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      color: var(--secondary);
      border-bottom: 2px solid var(--light);
      padding-bottom: 10px;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .section-title i {
      margin-right: 10px;
      font-size: 1.4rem;
      color: var(--primary);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
      font-size: 0.9rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-dark);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition-fast);
      font-family: inherit;
      background: var(--white);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      background: var(--primary-light);
    }
    
    input:disabled, select:disabled, textarea:disabled {
      background: var(--light);
      color: var(--gray);
      cursor: not-allowed;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 25px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      text-decoration: none;
      border: 1px solid transparent;
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-block {
      display: flex;
      width: 100%;
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: var(--success-dark);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: var(--danger-dark);
    }
    
    .btn-warning {
      background: var(--warning);
    }
    
    .btn-warning:hover {
      background: var(--warning-dark);
    }
    
    .btn-info {
      background: var(--info);
    }
    
    .btn-info:hover {
      background: var(--info-dark);
    }
    
    .btn-light {
      background: var(--light);
      color: var(--dark);
    }
    
    .btn-light:hover {
      background: var(--light-dark);
    }
    
    .btn-sm {
      padding: 8px 12px;
      font-size: 0.85rem;
    }
    
    .btn-lg {
      padding: 15px 30px;
      font-size: 1.1rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: var(--white);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--light-dark);
    }
    
    th {
      background-color: var(--light);
      font-weight: 700;
      color: var(--secondary);
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background-color: var(--primary-light);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: none;
      animation: fadeIn 0.5s;
      border: 1px solid transparent;
    }
    
    .alert.show {
      display: flex;
      align-items: center;
    }
    
    .alert-icon {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    .alert-success {
      background-color: var(--success-light);
      color: var(--success-dark);
      border-color: var(--success);
    }
    
    .alert-danger {
      background-color: var(--danger-light);
      color: var(--danger-dark);
      border-color: var(--danger);
    }
    
    .alert-warning {
      background-color: var(--warning-light);
      color: var(--warning-dark);
      border-color: var(--warning);
    }
    
    .alert-info {
      background-color: var(--info-light);
      color: var(--info-dark);
      border-color: var(--info);
    }
    
    .total-display {
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 20px;
      padding: 15px;
      background-color: var(--light);
      border-radius: var(--radius);
      border: 1px solid var(--light-dark);
    }
    
    .export-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    /* Styles pour l'upload d'image */
    .image-upload-container {
      margin-bottom: 20px;
    }
    
    .image-preview {
      width: 100%;
      max-height: 200px;
      border: 2px dashed var(--light-dark);
      border-radius: var(--radius);
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: var(--light);
      transition: var(--transition);
    }
    
    .image-preview:hover {
      border-color: var(--primary);
    }
    
    .image-preview img {
      max-width: 100%;
      max-height: 180px;
      object-fit: contain;
    }
    
    .image-preview-placeholder {
      padding: 30px;
      text-align: center;
      color: var(--gray);
    }
    
    .image-preview-placeholder i {
      font-size: 3rem;
      margin-bottom: 10px;
      color: var(--light-dark);
    }
    
    .upload-btn {
      display: inline-block;
      padding: 10px 15px;
      background: var(--light);
      color: var(--dark);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      margin-top: 10px;
      text-align: center;
      width: 100%;
      border: 1px solid var(--light-dark);
      font-weight: 600;
    }

/* Ajoutez dans la section <style> */
.article-image-stat {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid var(--light-dark);
}

.article-image-stat-placeholder {
    width: 60px;
    height: 60px;
    background: var(--light);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray);
    border: 1px solid var(--light-dark);
}

/* Amélioration des tableaux avec images */
#statsTable td:first-child {
    padding: 5px;
    text-align: center;
    vertical-align: middle;
}

#statsTable .article-with-image {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Pour les versions mobiles */
@media (max-width: 768px) {
    .article-image-stat {
        width: 40px;
        height: 40px;
    }
    
    .article-image-stat-placeholder {
        width: 40px;
        height: 40px;
    }
    
    #statsTable td:first-child {
        padding: 3px;
    }
}
    
    .upload-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary-dark);
    }
    
    /* Styles pour les articles avec images */
    .article-with-image {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .article-image {
      width: 50px;
      height: 50px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--light-dark);
    }
    
    .article-image-small {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      border: 1px solid var(--light-dark);
    }
    
    .article-image-placeholder {
      width: 50px;
      height: 50px;
      background: var(--light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      border: 1px solid var(--light-dark);
    }
    
    /* Amélioration des sélecteurs */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 40px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Modal de confirmation */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 90%;
      text-align: center;
      border-top: 4px solid var(--primary);
      position: relative;
    }
    
    .modal-content h2 {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 1.5rem;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    /* Styles pour les prix */
    .price-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .price-info {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 5px;
      font-style: italic;
    }

    /* Styles pour paiement partiel */
    .payment-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .payment-status {
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .payment-paid {
      background-color: var(--success-light);
      color: var(--success-dark);
      border: 1px solid var(--success);
    }
    
    .payment-partial {
      background-color: var(--warning-light);
      color: var(--warning-dark);
      border: 1px solid var(--warning);
    }
    
    .payment-reserved {
      background-color: var(--info-light);
      color: var(--info-dark);
      border: 1px solid var(--info);
    }
    
    /* Styles pour la recherche */
    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    
    .search-input {
      padding-left: 40px;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    /* Styles pour les réservations */
    .reservation-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      background-color: var(--light);
      color: var(--gray-dark);
      font-size: 0.8rem;
      margin-left: 10px;
      border: 1px solid var(--light-dark);
    }

    /* Loading spinner */
    .spinner {
      border: 4px solid var(--light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Badge de notification */
    .badge {
      background: var(--danger);
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7rem;
      margin-left: 5px;
      min-width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--light-dark);
    }
    
    .empty-state p {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    
    .empty-state .btn {
      margin-top: 15px;
    }
    
    /* Table responsive */
    .table-responsive {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--light-dark);
    }
    
    .table-responsive table {
      margin: 0;
      min-width: 600px;
    }
    
    /* Status badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .status-active {
      background-color: var(--success-light);
      color: var(--success-dark);
      border: 1px solid var(--success);
    }
    
    .status-inactive {
      background-color: var(--danger-light);
      color: var(--danger-dark);
      border: 1px solid var(--danger);
    }
    
    .status-pending {
      background-color: var(--warning-light);
      color: var(--warning-dark);
      border: 1px solid var(--warning);
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }
    
    .loading-message {
      margin-top: 15px;
      font-weight: 600;
    }
    
    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--light);
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }


/* Styles pour les boutons d'export */
.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
}

.export-buttons .btn {
    flex: 1;
    min-width: 180px;
    max-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 15px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.export-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Responsive */
@media (max-width: 768px) {
    .export-buttons {
        flex-direction: column;
    }
    
    .export-buttons .btn {
        max-width: 100%;
    }
}
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--dark);
      color: var(--white);
      text-align: center;
      border-radius: var(--radius);
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      font-weight: normal;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* Styles pour les abonnements */
    .subscription-plans {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .plan-card {
      background: var(--white);
      border: 2px solid var(--light-dark);
      border-radius: var(--radius-lg);
      padding: 25px;
      text-align: center;
      transition: var(--transition);
      position: relative;
    }

    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .plan-card.featured {
      border-color: var(--primary);
      transform: scale(1.05);
    }

    .plan-badge {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .plan-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light);
    }

    .plan-header h3 {
      color: var(--secondary);
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .plan-price {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
    }

    .plan-features {
      margin: 25px 0;
      text-align: left;
    }

    .plan-features ul {
      list-style: none;
      padding: 0;
    }

    .plan-features li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

/* Styles pour les statistiques */
.canvas-container {
    background: var(--white);
    padding: 20px;
    border-radius: var(--radius);
    border: 1px solid var(--light-dark);
    text-align: center;
}

.stats-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
    text-align: center;
}

.stats-card h4 {
    color: var(--secondary);
    margin-bottom: 15px;
    font-size: 1rem;
    font-weight: 600;
}

.stats-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
    color: var(--primary);
}

.stats-trend {
    font-size: 0.9rem;
    color: var(--gray);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.stats-trend.up {
    color: var(--success);
}

.stats-trend.down {
    color: var(--danger);
}

.percentage-change {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 5px;
}

.percentage-change.positive {
    background: var(--success-light);
    color: var(--success-dark);
}

.percentage-change.negative {
    background: var(--danger-light);
    color: var(--danger-dark);
}

/* Tableau des statistiques */
#statsTable th {
    background: linear-gradient(135deg, var(--primary), var(--info));
    color: white;
}

#statsTable tr:nth-child(even) {
    background-color: var(--primary-light);
}

#statsTable td {
    padding: 10px;
    border-bottom: 1px solid var(--light-dark);
}

.chart-legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.legend-color {
    width: 15px;
    height: 15px;
    border-radius: 3px;
}

/* Responsive pour les graphiques */
@media (max-width: 768px) {
    .canvas-container {
        padding: 10px;
    }
    
    #statsChart {
        height: 250px !important;
    }
    
    .stats-card {
        padding: 15px;
    }
    
    .stats-value {
        font-size: 1.5rem;
    }
}

    .plan-features .fa-check {
      color: var(--success);
    }

    .plan-features .fa-times {
      color: var(--danger);
    }

    .subscription-status {
      padding: 20px;
      border-radius: var(--radius);
      text-align: center;
    }

    .status-active {
      background: var(--success-light);
      border: 1px solid var(--success);
    }

    .status-expired {
      background: var(--danger-light);
      border: 1px solid var(--danger);
    }

    .status-pending {
      background: var(--warning-light);
      border: 1px solid var(--warning);
    }

    .status-loading {
      padding: 30px;
      text-align: center;
    }

    /* Styles pour les paiements */
    .payment-methods {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .payment-method {
      flex: 1;
      min-width: 120px;
      padding: 15px;
      border: 2px solid var(--light-dark);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .payment-method:hover {
      border-color: var(--primary);
    }

    .payment-method.active {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .payment-logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .payment-logo i {
      font-size: 2rem;
    }

    .payment-summary {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      margin: 20px 0;
      border: 1px solid var(--light-dark);
    }

    .summary-details p {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      background: var(--white);
      border-radius: var(--radius);
      border: 1px solid var(--light-dark);
    }

    #qrCode {
      width: 200px;
      height: 200px;
      margin: 0 auto 15px;
      background: var(--light);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
    }

    .payment-instructions {
      background: var(--info-light);
      padding: 20px;
      border-radius: var(--radius);
      margin: 20px 0;
      border: 1px solid var(--info);
    }

    .payment-instructions ol {
      margin: 15px 0;
      padding-left: 20px;
    }

    .payment-instructions li {
      margin: 8px 0;
    }

    .status-timeline {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      position: relative;
    }

    .status-timeline::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: var(--light-dark);
      z-index: 1;
    }

    .status-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .status-step i {
      width: 40px;
      height: 40px;
      background: var(--light);
      border: 2px solid var(--light-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      transition: var(--transition);
    }

    .status-step.active i {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .status-step span {
      font-size: 0.8rem;
      text-align: center;
    }

    .provider-instructions {
      background: #f8f9fa;
      padding: 20px;
      border-radius: var(--radius);
      margin: 20px 0;
      border-left: 4px solid #E60A14;
    }

    .instructions-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--light-dark);
    }

    .step-number {
      background: #E60A14;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .step-text {
      flex: 1;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .container {
        padding: 15px;
      }
      
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .price-container,
      .payment-container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .export-buttons {
        flex-direction: column;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab-button {
        border-right: none;
        border-bottom: 1px solid var(--light-dark);
      }
      
      .tab-button:last-child {
        border-bottom: none;
      }
      
      .user-info {
        position: relative;
        top: auto;
        right: auto;
        justify-content: center;
        margin-bottom: 15px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
      }
      
      header {
        text-align: center;
        padding: 20px 15px;
      }
      
      h1 {
        font-size: 2rem;
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-content {
        padding: 20px;
        margin: 20px;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .auth-form {
        padding: 30px 20px;
      }

      .subscription-plans {
        grid-template-columns: 1fr;
      }
      
      .plan-card.featured {
        transform: none;
      }
      
      .payment-methods {
        flex-direction: column;
      }
      
      .status-timeline {
        flex-direction: column;
        gap: 15px;
      }
      
      .status-timeline::before {
        display: none;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .section {
        padding: 20px 15px;
      }
      
      .card {
        padding: 20px 15px;
      }
      
      .btn {
        padding: 10px 20px;
        font-size: 0.9rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .card-value {
        font-size: 1.8rem;
      }
    }
    
    /* Print styles */
    @media print {
      .tabs,
      .user-info,
      .export-buttons,
      .btn:not(.print-btn) {
        display: none !important;
      }
      
      .tab-content {
        display: block !important;
      }
      
      body {
        background: white;
        color: black;
      }
      
      .section {
        box-shadow: none;
        border: 1px solid #000;
      }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #2c3e50;
        --light-dark: #34495e;
        --white: #1a1a1a;
        --dark: #ecf0f1;
        --gray: #bdc3c7;
      }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--light);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* Focus styles for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .slide-up {
      animation: slideUp 0.5s ease-in-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Utility classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .text-primary { color: var(--primary); }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--gray); }
    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 10px; }
    .mb-2 { margin-bottom: 20px; }
    .mb-3 { margin-bottom: 30px; }
    .mt-1 { margin-top: 10px; }
    .mt-2 { margin-top: 20px; }
    .mt-3 { margin-top: 30px; }
    .p-1 { padding: 10px; }
    .p-2 { padding: 20px; }
    .p-3 { padding: 30px; }
    .d-flex { display: flex; }
    .d-block { display: block; }
    .d-none { display: none; }
    .justify-center { justify-content: center; }
    .align-center { align-items: center; }
    .w-100 { width: 100%; }
    .h-100 { height: 100%; }

    /* Styles pour la vente multiple */
    .cart-items {
      margin-bottom: 20px;
    }
    
    .cart-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--light);
      border-radius: var(--radius);
      margin-bottom: 10px;
      border: 1px solid var(--light-dark);
    }
    
    .cart-item-info {
      flex: 1;
    }
    
    .cart-item-actions {
      display: flex;
      gap: 10px;
    }
    
    .cart-total {
      font-size: 1.2rem;
      font-weight: bold;
      text-align: right;
      padding: 15px;
      background: var(--primary-light);
      border-radius: var(--radius);
      margin-top: 20px;
    }
    
    /* Styles pour la facture */
    .invoice-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
    }
    
    .invoice-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--light);
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .invoice-items {
      margin-bottom: 30px;
    }
    
    .invoice-totals {
      text-align: right;
      font-size: 1.1rem;
    }
    
    .invoice-footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--light);
      color: var(--gray);
    }

    /* Styles pour les commandes */
    .order-status {
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .order-pending {
      background-color: var(--warning-light);
      color: var(--warning-dark);
      border: 1px solid var(--warning);
    }
    
    .order-processing {
      background-color: var(--info-light);
      color: var(--info-dark);
      border: 1px solid var(--info);
    }
    
    .order-completed {
      background-color: var(--success-light);
      color: var(--success-dark);
      border: 1px solid var(--success);
    }
    
    .order-cancelled {
      background-color: var(--danger-light);
      color: var(--danger-dark);
      border: 1px solid var(--danger);
    }
/* Ajoutez ce CSS à la fin de votre section style */
.btn-danger[onclick="logout()"] {
    display: inline-flex !important;
    visibility: visible !important;
}
  </style>
</head>

<body>
  <!-- Container d'authentification -->
  <div id="authContainer" class="auth-container">
    <div class="auth-form">
      <div class="auth-logo">
        <i class="fas fa-tshirt"></i>
        <h2>HybriLink</h2>
      </div>
      <div class="form-group">
        <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="loginEmail" placeholder="votre@email.com">
      </div>
      <div class="form-group">
        <label for="loginPassword"><i class="fas fa-lock"></i> Mot de passe</label>
        <input type="password" id="loginPassword" placeholder="Votre mot de passe">
      </div>
      <button class="btn btn-block" onclick="login()">
        <i class="fas fa-sign-in-alt"></i> Se connecter
      </button>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-info" onclick="showRegisterAccess()" style="background: transparent; color: var(--primary); padding: 5px;">
          <i class="fas fa-user-plus"></i> Créer un compte
        </button>
        <button class="btn btn-info" onclick="showForgotPassword()" style="background: transparent; color: var(--primary); padding: 5px; margin-left: 10px;">
          <i class="fas fa-key"></i> Mot de passe oublié
        </button>
      </div>
    </div>
  </div>

  <!-- Modal d'accès création de compte -->
  <div class="modal" id="registerAccessModal">
    <div class="modal-content">
      <h2><i class="fas fa-shield-alt"></i> Accès Création de Compte</h2>
      <p>Veuillez saisir le mot de passe d'autorisation pour créer un compte</p>
      <div class="form-group">
        <input type="password" id="registerAccessPassword" placeholder="Mot de passe d'autorisation" onkeypress="if(event.key=='Enter') verifyRegisterAccess()">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="verifyRegisterAccess()">
          <i class="fas fa-check"></i> Valider
        </button>
        <button class="btn" onclick="cancelRegisterAccess()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Formulaire d'inscription -->
  <div id="registerContainer" class="auth-container" style="display: none;">
    <div class="auth-form">
      <div class="auth-logo">
        <i class="fas fa-user-plus"></i>
        <h2>Créer un compte</h2>
      </div>
      <div class="form-group">
        <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="registerEmail" placeholder="votre@email.com">
      </div>
      <div class="form-group">
        <label for="registerPassword"><i class="fas fa-lock"></i> Mot de passe</label>
        <input type="password" id="registerPassword" placeholder="Minimum 6 caractères">
      </div>
      <div class="form-group">
        <label for="registerName"><i class="fas fa-user"></i> Nom complet</label>
        <input type="text" id="registerName" placeholder="Votre nom">
      </div>
      <div class="form-group">
        <label for="registerRole"><i class="fas fa-user-tag"></i> Rôle</label>
        <select id="registerRole">
          <option value="vendeur">Vendeur</option>
          <option value="gerant">Gérant</option>
          <option value="admin">Administrateur</option>
        </select>
      </div>
      <button class="btn btn-block" onclick="register()">
        <i class="fas fa-user-plus"></i> Créer le compte
      </button>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-info" onclick="showLogin()" style="background: transparent; color: var(--primary); padding: 5px;">
          <i class="fas fa-arrow-left"></i> Retour à la connexion
        </button>
      </div>
    </div>
  </div>

  <!-- Application principale -->
  <div id="mainApp" class="container" style="display: none;">
    <header>
      <div class="user-info" id="userInfo">
        <img src="R.png" width="40px"><i class="fas fa-user"></i>
        <span id="userName">Utilisateur</span>
        <span class="user-role" id="userRole">Role</span>
        
        <!-- Bouton de déconnexion -->
        <button class="btn btn-sm btn-danger" onclick="logout()" title="Déconnexion">
          <i class="fas fa-sign-out-alt"></i> Déconnexion
        </button>
      </div>
      
      <h1><i class="fas fa-tshirt"></i> hybrilink</h1>
      <p class="tagline">Solution complète de gestion de commerce de vêtements</p>
    </header>
    
    <!-- Navigation par onglets -->
    <div class="tabs">
      <button class="tab-button active" onclick="showTab('dashboard')">
        <i class="fas fa-chart-line"></i> Tableau de bord
      </button>
      <button class="tab-button" onclick="showTab('add-article')">
        <i class="fas fa-plus-circle"></i> Ajouter un article
      </button>
      <button class="tab-button" onclick="showTab('sales')">
        <i class="fas fa-shopping-cart"></i> Ventes
      </button>
      <button class="tab-button" onclick="showTab('reservations')">
        <i class="fas fa-calendar-check"></i> Réservations
      </button>
      <button class="tab-button" onclick="showTab('orders')">
        <i class="fas fa-shopping-bag"></i> Commandes
        <span class="badge" id="ordersBadge" style="display: none;">0</span>
      </button>
      <button class="tab-button" onclick="showTab('stock')">
        <i class="fas fa-warehouse"></i> Stock
      </button>
      <button class="tab-button" onclick="showTab('reports')">
        <i class="fas fa-file-alt"></i> Rapports
      </button>

<!-- Dans la navigation par onglets (cherchez la div avec class="tabs") -->
<button class="tab-button" onclick="showTab('statistics')">
    <i class="fas fa-chart-pie"></i> Statistiques globales
</button>
      <button class="tab-button" onclick="showTab('archives')">
        <i class="fas fa-archive"></i> Archives
      </button>
      <button class="tab-button" onclick="showTab('subscription')">
        <i class="fas fa-crown"></i> Abonnement
      </button>
      <button class="tab-button" onclick="showTab('mobile-money')">
        <i class="fas fa-mobile-alt"></i> Paiement
      </button>
    </div>
    
    <div id="alertBox"></div>
    
    <!-- Onglet Tableau de bord -->
    <div id="dashboard" class="tab-content active">
      <div class="dashboard">
        <div class="card" onclick="showTab('stock')">
          <h3><i class="fas fa-boxes"></i> Valeur du stock</h3>
          <div class="card-value" id="valeurStock">0 FC</div>
          <div class="card-trend" id="stockTrend">
            <i class="fas fa-chart-line"></i> <span>Chargement...</span>
          </div>
        </div>
        <div class="card" onclick="showTab('stock')">
          <h3><i class="fas fa-tshirt"></i> Total articles</h3>
          <div class="card-value" id="totalArticles">0</div>
          <div class="card-trend" id="articlesTrend">
            <i class="fas fa-boxes"></i> <span>En stock</span>
          </div>
        </div>
        <div class="card" onclick="showTab('sales')">
          <h3><i class="fas fa-shopping-cart"></i> Ventes aujourd'hui</h3>
          <div class="card-value" id="ventesAujourdhui">0 FC</div>
          <div class="card-trend" id="salesTrend">
            <i class="fas fa-chart-bar"></i> <span>Chargement...</span>
          </div>
        </div>
        <div class="card" onclick="showTab('orders')">
          <h3><i class="fas fa-shopping-bag"></i> Commandes en attente</h3>
          <div class="card-value" id="pendingOrders">0</div>
          <div class="card-trend" id="ordersTrend">
            <i class="fas fa-clock"></i> <span>En attente</span>
          </div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-receipt"></i> Dernières ventes</h2>
          <div class="table-responsive">
            <table id="tableRecentSales">
              <thead>
                <tr>
                  <th>Article</th>
                  <th>Quantité</th>
                  <th>Total (FC)</th>
                  <th>Date</th>
                  <th>Vendeur</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyRecentSales">
            <i class="fas fa-receipt"></i>
            <p>Aucune vente récente</p>
          </div>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Dépenses récentes</h2>
          <div class="table-responsive">
            <table id="tableRecentExpenses">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Montant (FC)</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyRecentExpenses">
            <i class="fas fa-money-bill"></i>
            <p>Aucune dépense récente</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Onglet Ajouter un article -->
    <div id="add-article" class="tab-content">
      <div class="section">
        <h2 class="section-title"><i class="fas fa-plus-circle"></i> Ajouter un article</h2>
        <div class="form-group">
          <label for="nom"><i class="fas fa-tag"></i> Nom de l'article</label>
          <input type="text" id="nom" placeholder="Ex: Chemise en lin">
        </div>
        <div class="form-group">
          <label for="type"><i class="fas fa-list"></i> Type</label>
          <select id="type">
            <option value="">Sélectionner un type</option>
            <option value="friperie">Friperie</option>
            <option value="magasin">Magasin</option>
            <option value="luxe">Luxe</option>
            <option value="sport">Sport</option>
            <option value="enfant">Enfant</option>
            <option value="femme">Femme</option>
            <option value="homme">Homme</option>
            <option value="accessoire">Accessoire</option>
          </select>
        </div>
        <div class="price-container">
          <div class="form-group">
            <label for="prixAchat"><i class="fas fa-shopping-cart"></i> Prix d'achat (FC)</label>
            <input type="number" id="prixAchat" placeholder="Ex: 3000" min="0" step="100">
            <div class="price-info">Prix d'achat de l'article</div>
          </div>
          <div class="form-group">
            <label for="prixVente"><i class="fas fa-tag"></i> Prix de vente (FC)</label>
            <input type="number" id="prixVente" placeholder="Ex: 5000" min="0" step="100">
            <div class="price-info">Prix de vente définitif de l'article</div>
          </div>
        </div>
        <div class="form-group">
          <label for="quantite"><i class="fas fa-cubes"></i> Quantité</label>
          <input type="number" id="quantite" placeholder="Ex: 10" min="0">
        </div>
        <div class="form-group">
          <label for="description"><i class="fas fa-file-alt"></i> Description (optionnel)</label>
          <textarea id="description" placeholder="Description de l'article..." rows="3"></textarea>
        </div>
        <div class="form-group image-upload-container">
          <label><i class="fas fa-image"></i> Photo de l'article</label>
          <div class="image-preview" id="imagePreview">
            <div class="image-preview-placeholder">
              <i class="fas fa-image"></i>
              <p>Aucune image sélectionnée</p>
            </div>
          </div>
          <input type="file" id="uploadImage" accept="image/*" style="display: none;">
          <label for="uploadImage" class="upload-btn">
            <i class="fas fa-upload"></i> Choisir une image
          </label>
        </div>
        <button class="btn btn-block" onclick="ajouterArticle()" id="addArticleBtn">
          <i class="fas fa-plus"></i> Ajouter l'article
        </button>
      </div>
    </div>
    
    <!-- Onglet Ventes -->
    <div id="sales" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Vente multiple</h2>
          
          <div class="form-group">
            <label for="articleVente"><i class="fas fa-tag"></i> Article</label>
            <select id="articleVente"></select>
          </div>
          <div class="form-group">
            <label for="quantiteVente"><i class="fas fa-cubes"></i> Quantité</label>
            <input type="number" id="quantiteVente" placeholder="Ex: 2" min="1" value="1">
          </div>
          <button class="btn btn-info" onclick="ajouterAuPanier()">
            <i class="fas fa-plus"></i> Ajouter au panier
          </button>
          
          <div class="cart-items" id="cartItems">
            <!-- Les articles ajoutés au panier apparaîtront ici -->
          </div>
          
          <div class="cart-total" id="cartTotal">
            Total: 0 FC
          </div>
          
          <div class="form-group">
            <label for="montantVerse"><i class="fas fa-hand-holding-usd"></i> Montant versé (FC)</label>
            <input type="number" id="montantVerse" placeholder="Ex: 5000" min="0" step="100">
          </div>
          
          <button class="btn btn-success btn-block" onclick="validerPaiement()">
            <i class="fas fa-cash-register"></i> Valider le paiement
          </button>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Enregistrer une dépense</h2>
          <div class="form-group">
            <label for="descriptionDepense"><i class="fas fa-file-alt"></i> Description de la dépense</label>
            <input type="text" id="descriptionDepense" placeholder="Ex: Achat de matériel, Loyer, etc.">
          </div>
          <div class="form-group">
            <label for="montantDepense"><i class="fas fa-money-bill"></i> Montant (FC)</label>
            <input type="number" id="montantDepense" placeholder="Ex: 25000" min="0" step="100">
          </div>
          <button class="btn btn-danger btn-block" onclick="enregistrerDepense()">
            <i class="fas fa-money-bill"></i> Enregistrer la dépense
          </button>
        </div>
      </div>
    </div>
    
    <!-- Onglet Réservations -->
    <div id="reservations" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-calendar-check"></i> Réservations en cours</h2>
          
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchReservation" class="search-input" placeholder="Rechercher une réservation..." onkeyup="filtrerReservations()">
          </div>
          
          <div class="table-responsive">
            <table id="tableReservations">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Téléphone</th>
                  <th>Article</th>
                  <th>Prix total</th>
                  <th>Montant versé</th>
                  <th>Reste à payer</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyReservations">
            <i class="fas fa-calendar-times"></i>
            <p>Aucune réservation en cours</p>
          </div>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-calendar-plus"></i> Nouvelle réservation</h2>
          <div class="form-group">
            <label for="clientReservation"><i class="fas fa-user"></i> Nom du client</label>
            <input type="text" id="clientReservation" placeholder="Ex: Jean Dupont">
          </div>
          <div class="form-group">
            <label for="telephoneReservation"><i class="fas fa-phone"></i> Téléphone</label>
            <input type="text" id="telephoneReservation" placeholder="Ex: 77 123 45 67">
          </div>
          <div class="form-group">
            <label for="articleReservation"><i class="fas fa-tag"></i> Article</label>
            <select id="articleReservation"></select>
          </div>
          <div class="form-group">
            <label for="quantiteReservation"><i class="fas fa-cubes"></i> Quantité</label>
            <input type="number" id="quantiteReservation" placeholder="Ex: 1" value="1" min="1">
          </div>
          <div class="form-group">
            <label for="montantVerseReservation"><i class="fas fa-hand-holding-usd"></i> Montant versé (FC)</label>
            <input type="number" id="montantVerseReservation" placeholder="Ex: 5000" min="0" step="100">
          </div>
          <button class="btn btn-info btn-block" onclick="creerReservation()">
            <i class="fas fa-calendar-plus"></i> Créer la réservation
          </button>
        </div>
      </div>
    </div>
    
    <!-- Onglet Commandes -->
    <div id="orders" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-shopping-bag"></i> Commandes en attente</h2>
          
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchOrders" class="search-input" placeholder="Rechercher une commande..." onkeyup="filtrerCommandes()">
          </div>
          
          <div class="table-responsive">
            <table id="tableOrders">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Téléphone</th>
                  <th>Article</th>
                  <th>Quantité</th>
                  <th>Date</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyOrders">
            <i class="fas fa-shopping-bag"></i>
            <p>Aucune commande en attente</p>
          </div>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-plus-circle"></i> Nouvelle commande</h2>
          <div class="form-group">
            <label for="clientOrder"><i class="fas fa-user"></i> Nom du client</label>
            <input type="text" id="clientOrder" placeholder="Ex: Jean Dupont">
          </div>
          <div class="form-group">
            <label for="telephoneOrder"><i class="fas fa-phone"></i> Téléphone</label>
            <input type="text" id="telephoneOrder" placeholder="Ex: 77 123 45 67">
          </div>
          <div class="form-group">
            <label for="articleOrder"><i class="fas fa-tag"></i> Article commandé</label>
            <input type="text" id="articleOrder" placeholder="Ex: Chemise en lin">
          </div>
          <div class="form-group">
            <label for="quantiteOrder"><i class="fas fa-cubes"></i> Quantité</label>
            <input type="number" id="quantiteOrder" placeholder="Ex: 1" value="1" min="1">
          </div>
          <div class="form-group">
            <label for="notesOrder"><i class="fas fa-sticky-note"></i> Notes (optionnel)</label>
            <textarea id="notesOrder" placeholder="Notes supplémentaires..." rows="3"></textarea>
          </div>
          <button class="btn btn-info btn-block" onclick="creerCommande()">
            <i class="fas fa-shopping-bag"></i> Créer la commande
          </button>
        </div>
      </div>
    </div>
    
    <!-- Onglet Stock -->
    <div id="stock" class="tab-content">
      <div class="section">
        <h2 class="section-title"><i class="fas fa-warehouse"></i> Stock actuel</h2>
        
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchStock" class="search-input" placeholder="Rechercher un article..." onkeyup="filtrerStock()">
        </div>
        
        <div class="table-responsive">
          <table id="tableStock">
            <thead>
              <tr>
                <th>Article</th>
                <th>Type</th>
                <th>Prix d'achat</th>
                <th>Prix de vente</th>
                <th>Quantité</th>
                <th>Valeur</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="emptyStock">
          <i class="fas fa-box-open"></i>
          <p>Aucun article en stock</p>
        </div>
        <div class="total-display">
          Valeur totale du stock: <span id="totalStockValue">0</span> FC
        </div>
        <div class="export-buttons">
          <button class="btn btn-warning" onclick="exporterPDF()">
            <i class="fas fa-file-pdf"></i> Exporter le stock en PDF
          </button>
          <button class="btn btn-danger" onclick="reinitialiserApplication()">
            <i class="fas fa-trash-alt"></i> Réinitialiser l'application
          </button>


        </div>
      </div>
    </div>
    
    <!-- Onglet Rapports -->
    <div id="reports" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-chart-line"></i> Rapport journalier</h2>
          
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchReport" class="search-input" placeholder="Rechercher dans le rapport..." onkeyup="filtrerRapport()">
          </div>
          
          <div class="table-responsive">
            <table id="tableRapport">
              <thead>
                <tr>
                  <th>Article</th>
                  <th>Prix unitaire</th>
                  <th>Quantité vendue</th>
                  <th>Total (FC)</th>
                  <th>Montant versé</th>
                  <th>Reste à payer</th>
                  <th>Heure</th>
                  <th>Vendeur</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyReport">
            <i class="fas fa-receipt"></i>
            <p>Aucune vente aujourd'hui</p>
          </div>
          <div class="total-display">
            Total journalier : <span id="totalJour">0</span> FC | 
            Total perçu : <span id="totalPerçu">0</span> FC | 
            Total en attente : <span id="totalAttente">0</span> FC
          </div>
          
          <!-- Rapport détaillé par article -->
          <div class="section" style="margin-top: 30px;">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Détail par article</h2>
            <div class="table-responsive">
              <table id="tableDetailArticles">
                <thead>
                  <tr>
                    <th>Article</th>
                    <th>Quantité vendue</th>
                    <th>Total ventes</th>
                    <th>Coût d'achat</th>
                    <th>Bénéfice</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="total-display">
              Total ventes: <span id="totalVentes">0</span> FC | 
              Total coût: <span id="totalCout">0</span> FC | 
              Bénéfice net: <span id="beneficeNet">0</span> FC
            </div>
          </div>
          
          <div class="export-buttons">
            <button class="btn btn-warning" onclick="exporterPDF()">
              <i class="fas fa-file-pdf"></i> Exporter en PDF
            </button>
            <button class="btn btn-info" onclick="genererRapportComplet()">
              <i class="fas fa-file-alt"></i> Rapport Complet
            </button>
          </div>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Dépenses du mois</h2>
          
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchExpenses" class="search-input" placeholder="Rechercher une dépense..." onkeyup="filtrerDepenses()">
          </div>
          
          <div class="table-responsive">
            <table id="tableDepenses">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Montant (FC)</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="emptyExpenses">
            <i class="fas fa-money-bill"></i>
            <p>Aucune dépense ce mois-ci</p>
          </div>
          <div class="total-display">
            Total des dépenses: <span id="totalDepenses">0</span> FC
          </div>
          <div class="export-buttons">
            <button class="btn btn-warning" onclick="exporterArchivesPDF()">
              <i class="fas fa-file-pdf"></i> Exporter les dépenses
            </button>
 <!-- AJOUTEZ CES BOUTONS -->

  <button class="btn btn-info" onclick="exporterStockCSV()">
    <i class="fas fa-file-csv"></i> Exporter en CSV
  </button>

  <button class="btn btn-danger" onclick="reinitialiserApplication()">
    <i class="fas fa-trash-alt"></i> Réinitialiser l'application
  </button>

          </div>
        </div>
      </div>
    </div>
    
<!-- Onglet Statistiques globales -->
<div id="statistics" class="tab-content">
    <div class="section">
        <h2 class="section-title"><i class="fas fa-chart-pie"></i> Statistiques Globales</h2>
        
        <div class="grid-2">
            <div class="section">
                <h3 class="section-title"><i class="fas fa-filter"></i> Filtres de période</h3>
                
                <div class="form-group">
                    <label for="statsType"><i class="fas fa-chart-bar"></i> Type de rapport</label>
                    <select id="statsType" onchange="toggleStatsFilters()">
                        <option value="sales">Rapport des ventes</option>
                        <option value="stock">Rapport du stock</option>
                        <option value="revenue">Analyse des revenus</option>
                    </select>
                </div>
                
                <div class="payment-container">
                    <div class="form-group">
                        <label for="statsStartDate"><i class="fas fa-calendar"></i> Date de début</label>
                        <input type="date" id="statsStartDate">
                    </div>
                    <div class="form-group">
                        <label for="statsEndDate"><i class="fas fa-calendar"></i> Date de fin</label>
                        <input type="date" id="statsEndDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="statsCategory"><i class="fas fa-tags"></i> Catégorie (optionnel)</label>
                    <select id="statsCategory">
                        <option value="">Toutes les catégories</option>
                        <option value="friperie">Friperie</option>
                        <option value="magasin">Magasin</option>
                        <option value="luxe">Luxe</option>
                        <option value="sport">Sport</option>
                        <option value="enfant">Enfant</option>
                        <option value="femme">Femme</option>
                        <option value="homme">Homme</option>
                        <option value="accessoire">Accessoire</option>
                    </select>
                </div>
                
                <button class="btn btn-success btn-block" onclick="genererRapportParPeriode()">
                    <i class="fas fa-chart-line"></i> Générer le rapport
                </button>
                
                <div id="statsSummary" style="display: none; margin-top: 20px;">
                    <h4><i class="fas fa-clipboard-list"></i> Résumé</h4>
                    <div id="statsSummaryContent"></div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title"><i class="fas fa-chart-bar"></i> Graphiques</h3>
                
                <div class="canvas-container" style="margin: 20px 0;">
                    <canvas id="statsChart" width="400" height="300" style="max-width: 100%;"></canvas>
                </div>
                
                <div class="table-responsive" id="statsTableContainer" style="display: none;">
                    <table id="statsTable">
                        <thead>
                            <tr id="statsTableHeaders">
                                <!-- Les en-têtes seront générés dynamiquement -->
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <!-- Les données seront générées dynamiquement -->
                        </tbody>
                    </table>
                </div>
                
                <div class="empty-state" id="emptyStats">
                    <i class="fas fa-chart-line"></i>
                    <p>Aucune donnée à afficher</p>
                    <p class="text-muted">Sélectionnez une période et générez un rapport</p>
                </div>
            </div>
        </div>
        
        <div class="section" id="advancedStats" style="display: none;">
            <h3 class="section-title"><i class="fas fa-chart-area"></i> Statistiques avancées</h3>
            
            <div class="grid-3" id="advancedStatsContent">
                <!-- Les statistiques avancées seront générées ici -->
            </div>
        </div>
        
        <div class="export-buttons" id="statsExportButtons" style="display: none;">
            <button class="btn btn-warning" onclick="exporterRapportPDF()">
                <i class="fas fa-file-pdf"></i> Exporter en PDF
            </button>
            <button class="btn btn-success" onclick="exporterRapportExcel()">
                <i class="fas fa-file-excel"></i> Exporter en Excel
            </button>
            <button class="btn btn-info" onclick="imprimerRapport()">
                <i class="fas fa-print"></i> Imprimer
            </button>
        </div>
    </div>
</div>

    <!-- Onglet Archives -->
    <div id="archives" class="tab-content">
      <div class="section">
        <h2 class="section-title"><i class="fas fa-archive"></i> Archives des ventes</h2>
        
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchArchives" class="search-input" placeholder="Rechercher dans les archives..." onkeyup="filtrerArchives()">
        </div>
        
        <div class="payment-container">
          <div class="form-group">
            <label for="dateDebut"><i class="fas fa-calendar"></i> Date de début</label>
            <input type="date" id="dateDebut">
          </div>
          <div class="form-group">
            <label for="dateFin"><i class="fas fa-calendar"></i> Date de fin</label>
            <input type="date" id="dateFin">
          </div>
        </div>
        <button class="btn btn-info" onclick="filtrerParDate()">
          <i class="fas fa-filter"></i> Filtrer par date
        </button>
        
        <div class="table-responsive">
          <table id="tableArchives">
            <thead>
              <tr>
                <th>Date</th>
                <th>Article</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Total</th>
                <th>Vendeur</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="emptyArchives">
          <i class="fas fa-archive"></i>
          <p>Aucune donnée archivée</p>
        </div>
        <div class="export-buttons">
          <button class="btn btn-warning" onclick="exporterArchivesPDF()">
            <i class="fas fa-file-pdf"></i> Exporter les archives en PDF
          </button>


        </div>
      </div>
    </div>

    <!-- Onglet Abonnement -->
    <div id="subscription" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-crown"></i> Plans d'Abonnement</h2>
          
          <div class="subscription-plans">
            <div class="plan-card" data-plan="basic">
              <div class="plan-header">
                <h3>Basic</h3>
                <div class="plan-price">5,000 FC/mois</div>
              </div>
              <div class="plan-features">
                <ul>
                  <li><i class="fas fa-check"></i> Gestion du stock</li>
                  <li><i class="fas fa-check"></i> Ventes de base</li>
                  <li><i class="fas fa-check"></i> Rapports simples</li>
                  <li><i class="fas fa-times"></i> Réservations</li>
                  <li><i class="fas fa-times"></i> Commandes</li>
                  <li><i class="fas fa-times"></i> Support prioritaire</li>
                </ul>
              </div>
              <button class="btn btn-block" onclick="selectPlan('basic')">
                Choisir ce plan
              </button>
            </div>
            
            <div class="plan-card featured" data-plan="pro">
              <div class="plan-badge">Populaire</div>
              <div class="plan-header">
                <h3>Pro</h3>
                <div class="plan-price">15,000 FC/mois</div>
              </div>
              <div class="plan-features">
                <ul>
                  <li><i class="fas fa-check"></i> Toutes fonctionnalités Basic</li>
                  <li><i class="fas fa-check"></i> Réservations</li>
                  <li><i class="fas fa-check"></i> Commandes clients</li>
                  <li><i class="fas fa-check"></i> Rapports avancés</li>
                  <li><i class="fas fa-check"></i> Export PDF</li>
                  <li><i class="fas fa-check"></i> Support prioritaire</li>
                </ul>
              </div>
              <button class="btn btn-success btn-block" onclick="selectPlan('pro')">
                Choisir ce plan
              </button>
            </div>
            
            <div class="plan-card" data-plan="enterprise">
              <div class="plan-header">
                <h3>Enterprise</h3>
                <div class="plan-price">30,000 FC/mois</div>
              </div>
              <div class="plan-features">
                <ul>
                  <li><i class="fas fa-check"></i> Toutes fonctionnalités Pro</li>
                  <li><i class="fas fa-check"></i> Multi-utilisateurs</li>
                  <li><i class="fas fa-check"></i> API d'intégration</li>
                  <li><i class="fas fa-check"></i> Formation personnalisée</li>
                  <li><i class="fas fa-check"></i> Support 24/7</li>
                  <li><i class="fas fa-check"></i> Personnalisation</li>
                </ul>
              </div>
              <button class="btn btn-block" onclick="selectPlan('enterprise')">
                Choisir ce plan
              </button>
            </div>
          </div>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-user-clock"></i> Votre Abonnement</h2>
          <div id="currentSubscription">
            <div class="subscription-status">
              <div class="status-loading">
                <div class="spinner"></div>
                <p>Chargement de votre statut d'abonnement...</p>
              </div>
            </div>
          </div>
          
          <div class="section" style="margin-top: 30px;">
            <h2 class="section-title"><i class="fas fa-history"></i> Historique des Paiements</h2>
            <div class="table-responsive">
              <table id="tablePaymentHistory">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Méthode</th>
                    <th>Statut</th>
                    <th>Plan</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="empty-state" id="emptyPaymentHistory">
              <i class="fas fa-receipt"></i>
              <p>Aucun historique de paiement</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Paiement Mobile Money -->
    <div id="mobile-money" class="tab-content">
      <div class="grid-2">
        <div class="section">
          <h2 class="section-title"><i class="fas fa-mobile-alt"></i> Paiement Mobile Money</h2>
          
          <div class="payment-methods">
            <div class="payment-method active" data-provider="airtel">
              <div class="payment-logo">
                <i class="fas fa-mobile-alt" style="color: #E60A14;"></i>
                <span>Airtel Money</span>
              </div>
            </div>
            <div class="payment-method" data-provider="orange">
              <div class="payment-logo">
                <i class="fas fa-mobile-alt" style="color: #FF6600;"></i>
                <span>Orange Money</span>
              </div>
            </div>
            <div class="payment-method" data-provider="mtn">
              <div class="payment-logo">
                <i class="fas fa-mobile-alt" style="color: #FFCC00;"></i>
                <span>MTN Money</span>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="phoneNumber"><i class="fas fa-phone"></i> Numéro de téléphone</label>
            <input type="tel" id="phoneNumber" placeholder="Ex: 77 123 45 67">
          </div>
          
          <div class="form-group">
            <label for="paymentAmount"><i class="fas fa-money-bill-wave"></i> Montant (FC)</label>
            <input type="number" id="paymentAmount" placeholder="Ex: 5000" min="100" step="100">
          </div>
          
          <div class="form-group">
            <label for="paymentType"><i class="fas fa-tags"></i> Type de paiement</label>
            <select id="paymentType">
              <option value="subscription">Abonnement</option>
              <option value="feature">Fonctionnalité</option>
              <option value="credit">Crédit</option>
            </select>
          </div>
          
          <div class="payment-summary" id="paymentSummary" style="display: none;">
            <h4>Résumé du paiement</h4>
            <div class="summary-details">
              <p>Opérateur: <span id="summaryProvider">-</span></p>
              <p>Numéro: <span id="summaryPhone">-</span></p>
              <p>Montant: <span id="summaryAmount">-</span> FC</p>
              <p>Frais: <span id="summaryFees">-</span> FC</p>
              <p><strong>Total: <span id="summaryTotal">-</span> FC</strong></p>
            </div>
          </div>

          <div class="provider-instructions" id="airtelInstructions" style="display: block;">
            <h4><i class="fas fa-info-circle" style="color: #E60A14;"></i> Instructions Airtel Money:</h4>
            <div class="instructions-steps">
              <div class="step">
                <span class="step-number">1</span>
                <span class="step-text">Composez <strong>*144#</strong> sur votre téléphone</span>
              </div>
              <div class="step">
                <span class="step-number">2</span>
                <span class="step-text">Sélectionnez <strong>"Paiement de factures"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">3</span>
                <span class="step-text">Choisissez <strong>"Paiement marchand"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">4</span>
                <span class="step-text">Entrez le code marchand: <strong>hybrilink</strong></span>
              </div>
              <div class="step">
                <span class="step-number">5</span>
                <span class="step-text">Confirmez le montant et validez avec votre PIN</span>
              </div>
            </div>
          </div>

          <div class="provider-instructions" id="orangeInstructions" style="display: none;">
            <h4><i class="fas fa-info-circle" style="color: #FF6600;"></i> Instructions Orange Money:</h4>
            <div class="instructions-steps">
              <div class="step">
                <span class="step-number">1</span>
                <span class="step-text">Composez <strong>*144#</strong> sur votre téléphone</span>
              </div>
              <div class="step">
                <span class="step-number">2</span>
                <span class="step-text">Sélectionnez <strong>"Paiement de factures"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">3</span>
                <span class="step-text">Choisissez <strong>"Paiement marchand"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">4</span>
                <span class="step-text">Entrez le code marchand: <strong>THEOVET</strong></span>
              </div>
              <div class="step">
                <span class="step-number">5</span>
                <span class="step-text">Confirmez le montant et validez avec votre PIN</span>
              </div>
            </div>
          </div>

          <div class="provider-instructions" id="mtnInstructions" style="display: none;">
            <h4><i class="fas fa-info-circle" style="color: #FFCC00;"></i> Instructions MTN Money:</h4>
            <div class="instructions-steps">
              <div class="step">
                <span class="step-number">1</span>
                <span class="step-text">Composez <strong>*126#</strong> sur votre téléphone</span>
              </div>
              <div class="step">
                <span class="step-number">2</span>
                <span class="step-text">Sélectionnez <strong>"Paiement de factures"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">3</span>
                <span class="step-text">Choisissez <strong>"Paiement marchand"</strong></span>
              </div>
              <div class="step">
                <span class="step-number">4</span>
                <span class="step-text">Entrez le code marchand: <strong>THEOVET</strong></span>
              </div>
              <div class="step">
                <span class="step-number">5</span>
                <span class="step-text">Confirmez le montant et validez avec votre PIN</span>
              </div>
            </div>
          </div>
          
          <button class="btn btn-success btn-block" onclick="initiatePayment()" id="payButton">
            <i class="fas fa-lock"></i> Payer maintenant
          </button>
        </div>
        
        <div class="section">
          <h2 class="section-title"><i class="fas fa-qrcode"></i> Paiement par QR Code</h2>
          
          <div class="qr-container">
            <div id="qrCode">
              <div class="empty-state">
                <i class="fas fa-qrcode"></i>
                <p>QR Code généré après sélection du montant</p>
              </div>
            </div>
            <p class="text-center">Scannez pour payer avec votre application mobile</p>
          </div>
          
          <div class="payment-instructions">
            <h4>Instructions de paiement:</h4>
            <ol>
              <li>Ouvrez votre application mobile money</li>
              <li>Allez dans la section "Paiement"</li>
              <li>Scannez le QR code ci-dessus</li>
              <li>Confirmez le montant et validez</li>
              <li>Attendez la confirmation</li>
            </ol>
          </div>
          
          <div class="transaction-status" id="transactionStatus" style="display: none;">
            <h4>Statut de la transaction</h4>
            <div class="status-timeline">
              <div class="status-step active">
                <i class="fas fa-clock"></i>
                <span>En attente</span>
              </div>
              <div class="status-step">
                <i class="fas fa-sync-alt"></i>
                <span>En traitement</span>
              </div>
              <div class="status-step">
                <i class="fas fa-check"></i>
                <span>Confirmé</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de sécurité pour les ventes -->
  <div class="modal" id="salesModal">
    <div class="modal-content">
      <h2><i class="fas fa-lock"></i> Accès sécurisé</h2>
      <p>Veuillez saisir votre matricule pour consulter les ventes d'aujourd'hui</p>
      <div class="form-group">
        <input type="password" id="salesMatricule" placeholder="Matricule" onkeypress="if(event.key=='Enter') verifierMatriculeVentes()">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="verifierMatriculeVentes()">
          <i class="fas fa-check"></i> Valider
        </button>
        <button class="btn" onclick="annulerAccesVentes()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de réinitialisation -->
  <div class="modal" id="resetModal">
    <div class="modal-content">
      <h2><i class="fas fa-exclamation-triangle"></i> Réinitialisation sécurisée</h2>
      <p>Êtes-vous sûr de vouloir réinitialiser complètement l'application ?</p>
      <p><strong>Cette action supprimera tous les articles et l'historique des ventes. Cette opération est irréversible.</strong></p>
      <div class="form-group">
        <input type="password" id="resetMatricule" placeholder="Matricule de confirmation" onkeypress="if(event.key=='Enter') verifierMatriculeReinitialisation()">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-danger" onclick="verifierMatriculeReinitialisation()">
          <i class="fas fa-check"></i> Confirmer
        </button>
        <button class="btn" onclick="annulerReinitialisation()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de finalisation de réservation -->
  <div class="modal" id="finalizeReservationModal">
    <div class="modal-content">
      <h2><i class="fas fa-check-circle"></i> Finaliser la réservation</h2>
      <p>Voulez-vous finaliser cette réservation et l'archiver ?</p>
      <div id="reservationDetails"></div>
      <div class="form-group">
        <label for="montantFinalReservation">Montant final versé (FC)</label>
        <input type="number" id="montantFinalReservation" placeholder="Montant total" min="0" step="100">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="finaliserReservation()">
          <i class="fas fa-check"></i> Finaliser
        </button>
        <button class="btn" onclick="annulerFinalisation()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de gestion des commandes -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <h2><i class="fas fa-shopping-bag"></i> Gestion de commande</h2>
      <div id="orderDetails"></div>
      <div class="form-group">
        <label for="orderStatus">Statut de la commande</label>
        <select id="orderStatus">
          <option value="pending">En attente</option>
          <option value="processing">En traitement</option>
          <option value="completed">Terminée</option>
          <option value="cancelled">Annulée</option>
        </select>
      </div>
      <div class="form-group">
        <label for="orderNotes">Notes (optionnel)</label>
        <textarea id="orderNotes" placeholder="Notes supplémentaires..." rows="3"></textarea>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="updateOrder()">
          <i class="fas fa-check"></i> Mettre à jour
        </button>
        <button class="btn" onclick="document.getElementById('orderModal').style.display = 'none'">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de notification des commandes -->
  <div class="modal" id="orderNotificationModal">
    <div class="modal-content">
      <h2><i class="fas fa-bell"></i> Notifications de commandes</h2>
      <p>Des clients ont commandé cet article :</p>
      <div id="orderNotificationList"></div>
      <div class="modal-buttons">
        <button class="btn btn-info" onclick="document.getElementById('orderNotificationModal').style.display = 'none'">
          <i class="fas fa-check"></i> Compris
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de gestion des utilisateurs (admin) -->
  <div class="modal" id="usersModal">
    <div class="modal-content">
      <h2><i class="fas fa-users"></i> Gestion des utilisateurs</h2>
      <div id="usersList"></div>
      <div class="modal-buttons">
        <button class="btn btn-info" onclick="manageUsers()">
          <i class="fas fa-sync"></i> Actualiser
        </button>
        <button class="btn" onclick="document.getElementById('usersModal').style.display = 'none'">
          <i class="fas fa-times"></i> Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de facture -->
  <div class="modal" id="invoiceModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="invoice-container" id="invoiceContent">
        <!-- Le contenu de la facture sera généré ici -->
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="btn btn-warning" onclick="imprimerFacture()">
          <i class="fas fa-print"></i> Imprimer
        </button>
        <button class="btn btn-info" onclick="telechargerFacture()">
          <i class="fas fa-download"></i> Télécharger
        </button>
        <button class="btn" onclick="document.getElementById('invoiceModal').style.display = 'none'">
          <i class="fas fa-times"></i> Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Script JavaScript Principal -->
  <script>
    const { jsPDF } = window.jspdf;

// REMPLACER l'ancienne configuration par celle-ci :
const firebaseConfig = {
  apiKey: "AIzaSyCXoNwKYj9GNgTSZr5wTWqIna6Cou33a98",
  authDomain: "theovet-8323d.firebaseapp.com",
  projectId: "theovet-8323d",
  storageBucket: "theovet-8323d.firebasestorage.app",
  messagingSenderId: "1007742031625",
  appId: "1:1007742031625:web:3749c2ab333e7772c1a5d8"
};

// Configuration Cloudinary
    const CLOUDINARY_CONFIG = {
      cloudName: 'diwn8sxtn',
      uploadPreset: 'cs_lacolombe'
    };



// Initialiser Firebase
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        
        // Activer la persistance offline
        firebase.firestore().enablePersistence()
            .then(() => {
                console.log('Firebase: Persistance offline activée');
            })
            .catch((err) => {
                console.log('Firebase: Erreur persistance', err);
            });
    }
} catch (error) {
    console.error('Erreur initialisation Firebase:', error);
}

const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

// Variables globales

// Ajoutez après les autres variables globales
let currentStatsData = null;
let statsChart = null;
let statsPeriod = null;
let articles = [];
let ventes = [];
let depenses = [];
let reservations = [];
let archives = [];
let orders = [];
let today = new Date().toLocaleDateString('fr-FR');
let currentMonth = new Date().getMonth() + 1 + '-' + new Date().getFullYear();
let selectedImage = null;
let currentReservationId = null;
let currentOrderId = null;
let currentUser = null;
let userRole = null;
let userData = null;
let userPermissions = [];
let panier = []; // Panier pour les ventes multiples
let currentInvoice = null; // Facture actuelle

// Variables pour le système d'abonnement et paiement
let currentPlan = null;
let currentProvider = 'airtel';
let subscriptionData = null;

// Configuration des plans d'abonnement
const SUBSCRIPTION_PLANS = {
    'basic': {
        name: 'Basic',
        price: 5000,
        duration: 30, // jours
        features: ['stock', 'sales_basic', 'reports_simple']
    },
    'pro': {
        name: 'Pro', 
        price: 15000,
        duration: 30,
        features: ['stock', 'sales_advanced', 'reservations', 'orders', 'reports_advanced', 'export_pdf']
    },
    'enterprise': {
        name: 'Enterprise',
        price: 30000, 
        duration: 30,
        features: ['all_features', 'multi_user', 'api', 'training', 'support_24_7', 'customization']
    }
};

// Frais par opérateur (en pourcentage)
const PROVIDER_FEES = {
    'airtel': 1.2,
    'orange': 1.5,
    'mtn': 2.0
};

// Configuration Airtel Money
const AIRTEL_CONFIG = {
    useSimulation: true, // Passer à false quand vous avez les vraies clés
    environment: 'sandbox',
    country: 'SN',
    currency: 'XOF'
};

// Rôles et permissions hiérarchiques
const ROLES = {
    VENDEUR: 'vendeur',
    GERANT: 'gerant', 
    ADMIN: 'admin',
    SUPER_ADMIN: 'super_admin'
};

// Permissions détaillées par rôle
const PERMISSIONS = {
    [ROLES.VENDEUR]: [
        'view_dashboard',
        'view_profile',
        'add_sales',
        'view_own_sales',
        'view_stock',
        'view_products',
        'print_invoice',
        'view_orders',
        'create_orders',
        'manage_reservations' // AJOUTEZ CETTE LIGNE
    ],
    
    [ROLES.GERANT]: [
        'view_dashboard',
        'view_profile', 
        'add_sales',
        'view_all_sales',
        'view_stock',
        'view_products',
        'add_articles',
        'edit_articles',
        'delete_articles',
        'manage_reservations',
        'view_reports',
        'export_reports',
        'manage_expenses',
        'print_invoice',
        'view_orders',
        'create_orders',
        'manage_orders'
    ],
    
    [ROLES.ADMIN]: [
        'view_dashboard',
        'view_profile',
        'add_sales',
        'view_all_sales', 
        'view_stock',
        'view_products',
        'add_articles',
        'edit_articles',
        'delete_articles',
        'manage_reservations',
        'view_reports',
        'export_reports',
        'manage_expenses',
        'view_archives',
        'manage_users',
        'view_audit_logs',
        'system_settings',
        'print_invoice',
        'view_orders',
        'create_orders',
        'manage_orders'
    ],
    
    [ROLES.SUPER_ADMIN]: [
        'view_dashboard',
        'view_profile',
        'add_sales',
        'view_all_sales',
        'view_stock', 
        'view_products',
        'add_articles',
        'edit_articles',
        'delete_articles',
        'manage_reservations',
        'view_reports',
        'export_reports',
        'manage_expenses',
        'view_archives',
        'manage_users',
        'view_audit_logs',
        'system_settings',
        'reset_app',
        'manage_roles',
        'view_system_logs',
        'print_invoice',
        'view_orders',
        'create_orders',
        'manage_orders'
    ]
};

// Matricules de sécurité
const MATRICULES = {
    [ROLES.VENDEUR]: "2024V",
    [ROLES.GERANT]: "2024G", 
    [ROLES.ADMIN]: "2024A",
    [ROLES.SUPER_ADMIN]: "2024S"
};

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initialisation TheoVêt...');
    initializeAuth();
    setupEventListeners();
    checkPreviousSession();
    initializePaymentSystem();
});
// Ajoutez dans la fonction setupEventListeners() ou dans showTab('statistics')
function setupStatsDates() {
    const today = new Date();
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);
    
    // Formater les dates YYYY-MM-DD
    const formatDate = (date) => date.toISOString().split('T')[0];
    
    document.getElementById('statsStartDate').value = formatDate(oneMonthAgo);
    document.getElementById('statsEndDate').value = formatDate(today);
}

// Modifiez la fonction showTab pour initialiser les dates
function showTab(tabId) {
    // ... code existant ...
    
    switch(tabId) {
        // ... autres cas existants ...
        case 'statistics':
            setupStatsDates();
            break;
    }
}

function initializeAuth() {
  auth.onAuthStateChanged(async (user) => {
    console.log('🔐 État auth changé:', user ? user.email : 'Déconnecté');
    
    if (user) {
      console.log('✅ Utilisateur authentifié:', user.email);
      currentUser = user;
      
      try {
        await loadUserData(user.uid);
      } catch (error) {
        console.error('❌ Erreur post-authentification:', error);
        showAlert('Erreur lors du chargement des données', 'danger');
      }
    } else {
      console.log('👤 Aucun utilisateur connecté');
      currentUser = null;
      userData = null;
      userRole = null;
      showLogin();
    }
  });
}

function setupEventListeners() {
    // Upload d'image
    const uploadImage = document.getElementById('uploadImage');
    if (uploadImage) {
        uploadImage.addEventListener('change', handleImageUpload);
    }
    
    // Auto-remplissage des prix
    setupAutoPriceFill();
    
    // Touche Entrée pour les formulaires
    setupEnterKeyListeners();
    
    // Gestionnaire hors ligne
    setupOnlineOfflineHandler();
    
    // Fermeture des modals
    setupModalCloseHandlers();
}

function initializePaymentSystem() {
    setupPaymentEventListeners();
    loadUserSubscription();
}

function setupPaymentEventListeners() {
    // Sélection des méthodes de paiement
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
            currentProvider = this.dataset.provider;
            
            // Afficher les instructions spécifiques
            document.querySelectorAll('.provider-instructions').forEach(instructions => {
                instructions.style.display = 'none';
            });
            document.getElementById(currentProvider + 'Instructions').style.display = 'block';
            
            updatePaymentSummary();
        });
    });
    
    // Mise à jour du résumé de paiement
    document.getElementById('paymentAmount').addEventListener('input', updatePaymentSummary);
    document.getElementById('phoneNumber').addEventListener('input', updatePaymentSummary);
}

function setupAutoPriceFill() {
    // Auto-remplissage du prix de vente
    const articleVente = document.getElementById('articleVente');
    if (articleVente) {
        articleVente.addEventListener('change', function() {
            if (this.value !== '') {
                const prix = this.options[this.selectedIndex].getAttribute('data-prix');
                document.getElementById('montantVerse').value = prix;
            }
        });
    }
    
    // Auto-remplissage du prix de réservation
    const articleReservation = document.getElementById('articleReservation');
    if (articleReservation) {
        articleReservation.addEventListener('change', function() {
            if (this.value !== '') {
                const prix = this.options[this.selectedIndex].getAttribute('data-prix');
                document.getElementById('montantVerseReservation').value = 0;
            }
        });
    }
}

function setupEnterKeyListeners() {
    const setupEnter = (element, action) => {
        if (element) {
            element.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') action();
            });
        }
    };
    
    setupEnter(document.getElementById('loginEmail'), login);
    setupEnter(document.getElementById('loginPassword'), login);
    setupEnter(document.getElementById('registerEmail'), register);
    setupEnter(document.getElementById('registerPassword'), register);
}

function setupOnlineOfflineHandler() {
    window.addEventListener('online', () => {
        showAlert('✅ Connexion rétablie', 'success');
        if (currentUser) loadAllData();
    });
    
    window.addEventListener('offline', () => {
        showAlert('⚠️ Mode hors ligne - Les données peuvent ne pas être à jour', 'warning');
    });
}



function setupModalCloseHandlers() {
    // Fermer les modals en cliquant à l'extérieur
    window.addEventListener('click', (e) => {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Fermer avec la touche Échap
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
}

function checkPreviousSession() {
    const session = localStorage.getItem('theovet_session');
    if (session) {
        console.log('📁 Session précédente trouvée');
        try {
            const sessionData = JSON.parse(session);
            if (Date.now() - sessionData.timestamp < 24 * 60 * 60 * 1000) { // 24 heures
                document.getElementById('loginEmail').value = sessionData.email;
            }
        } catch (e) {
            console.log('Session invalide');
        }
    }
}

function handleImageUpload(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert("Image trop volumineuse (max 5MB)", "danger");
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            showAlert("Veuillez sélectionner une image valide", "danger");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedImage = e.target.result;
            document.getElementById('imagePreview').innerHTML = `
                <img src="${e.target.result}" alt="Aperçu" style="max-width: 100%; max-height: 180px; border-radius: 4px;">
                <div style="position: absolute; top: 5px; right: 5px;">
                    <button class="btn btn-sm btn-danger" onclick="removeImage()" style="padding: 2px 6px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        };
        reader.onerror = function() {
            showAlert("Erreur lors de la lecture de l'image", "danger");
        };
        reader.readAsDataURL(file);
    }
}

function removeImage() {
    selectedImage = null;
    document.getElementById('imagePreview').innerHTML = `
        <div class="image-preview-placeholder">
            <i class="fas fa-image"></i>
            <p>Aucune image sélectionnée</p>
        </div>
    `;
    document.getElementById('uploadImage').value = '';
}



// ==================== AUTHENTIFICATION ====================
function showLogin() {
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('registerContainer').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    resetAuthFields();
}

function showRegisterAccess() {
    document.getElementById('registerAccessModal').style.display = 'flex';
    document.getElementById('registerAccessPassword').value = '';
    document.getElementById('registerAccessPassword').focus();
}

function verifyRegisterAccess() {
    const accessPassword = document.getElementById('registerAccessPassword').value;
    const validPassword = "Mpiana33"; // Mot de passe d'autorisation
    
    if (accessPassword === validPassword) {
        document.getElementById('registerAccessModal').style.display = 'none';
        showRegister();
    } else {
        showAlert("❌ Mot de passe d'autorisation incorrect", "danger");
        document.getElementById('registerAccessPassword').value = '';
        document.getElementById('registerAccessPassword').focus();
    }
}

function cancelRegisterAccess() {
    document.getElementById('registerAccessModal').style.display = 'none';
    showLogin();
}

function showRegister() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('registerContainer').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('registerAccessModal').style.display = 'none';
}

function showForgotPassword() {
    const email = prompt('📧 Entrez votre email pour réinitialiser le mot de passe:');
    if (email && validateEmail(email)) {
        sendPasswordReset(email);
    } else if (email) {
        showAlert('Email invalide', 'danger');
    }
}

async function sendPasswordReset(email) {
    try {
        await auth.sendPasswordResetEmail(email);
        showAlert('📧 Email de réinitialisation envoyé! Vérifiez votre boîte de réception.', 'success');
    } catch (error) {
        handleAuthError(error);
    }
}

async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!validateLoginForm(email, password)) return;

    try {
        showLoading(true, 'Connexion en cours...');
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        
        // Sauvegarder la session
        localStorage.setItem('theovet_session', JSON.stringify({
            email: userCredential.user.email,
            timestamp: Date.now()
        }));
        
        await logSecurityEvent('connexion_reussie', email);
        showAlert('✅ Connexion réussie! Chargement des données...', 'success');
        
        // Charger les données utilisateur et afficher l'interface
        currentUser = userCredential.user;
        await loadUserData(currentUser.uid);
        
    } catch (error) {
        await logSecurityEvent('connexion_echouee', email);
        handleAuthError(error);
    } finally {
        showLoading(false);
    }
}

// Fonction de diagnostic à appeler dans la console navigateur
async function diagnoseAuth() {
  const user = auth.currentUser;
  console.log('🔍 Diagnostic Auth:');
  console.log('- Utilisateur courant:', user);
  
  if (user) {
    console.log('- UID:', user.uid);
    console.log('- Email:', user.email);
    
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      console.log('- Document Firestore:', userDoc.exists ? 'EXISTE' : 'NON TROUVÉ');
      if (userDoc.exists) {
        console.log('- Données:', userDoc.data());
      }
    } catch (error) {
      console.log('- Erreur Firestore:', error);
    }
  }
}

// Appelez diagnoseAuth() dans la console du navigateur pour voir ce qui se passe

async function register() {
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const name = document.getElementById('registerName').value.trim();
    const role = document.getElementById('registerRole').value;

    if (!validateRegisterForm(email, password, name)) return;

    try {
        showLoading(true, 'Création du compte...');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Créer le document utilisateur dans Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            role: role,
            isActive: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            loginCount: 1
        });

        await logSecurityEvent('compte_cree', `${email} (${role})`);
        showAlert('✅ Compte créé avec succès! Vous pouvez maintenant vous connecter.', 'success');
        
        // Rediriger vers la page de connexion
        showLogin();
        
    } catch (error) {
        await logSecurityEvent('erreur_creation_compte', email);
        handleAuthError(error);
    } finally {
        showLoading(false);
    }
}

async function logout() {
    try {
        if (currentUser) {
            await logSecurityEvent('deconnexion', currentUser.email);
        }
        await auth.signOut();
        localStorage.removeItem('theovet_session');
        currentUser = null;
        userData = null;
        userRole = null;
        showAlert('👋 Déconnexion réussie', 'success');
        showLogin();
    } catch (error) {
        console.error('Erreur déconnexion:', error);
        showAlert('Erreur lors de la déconnexion', 'danger');
    }
}

function validateLoginForm(email, password) {
    if (!email || !password) {
        showAlert('Veuillez remplir tous les champs', 'warning');
        return false;
    }
    if (!validateEmail(email)) {
        showAlert('Format d\'email invalide', 'danger');
        return false;
    }
    return true;
}

function validateRegisterForm(email, password, name) {
    if (!email || !password || !name) {
        showAlert('Tous les champs sont requis', 'warning');
        return false;
    }
    if (!validateEmail(email)) {
        showAlert('Format d\'email invalide', 'danger');
        return false;
    }
    if (password.length < 6) {
        showAlert('Le mot de passe doit contenir au moins 6 caractères', 'danger');
        return false;
    }
    if (name.length < 2) {
        showAlert('Le nom doit contenir au moins 2 caractères', 'danger');
        return false;
    }
    return true;
}

function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function resetAuthFields() {
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

async function loadUserData(uid) {
  try {
    console.log('🔄 Chargement des données utilisateur...');
    showLoading(true, 'Chargement du profil...');
    
    const userDoc = await db.collection('users').doc(uid).get();
    
    if (!userDoc.exists) {
      throw new Error('Profil non trouvé dans Firestore');
    }
    
    userData = userDoc.data();
    userRole = userData.role;
    userPermissions = PERMISSIONS[userRole] || [];
    
    console.log('👤 Utilisateur chargé:', userData.name, 'Rôle:', userRole);
    
    if (userData.isActive === false) {
      showAlert('❌ Compte désactivé. Contactez l\'administrateur.', 'danger');
      await logout();
      return;
    }
    
    // Mettre à jour les infos de connexion
    await db.collection('users').doc(uid).update({
      lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      loginCount: firebase.firestore.FieldValue.increment(1)
    });
    
    // Configurer l'interface utilisateur
    setupUserInterface();
    
    // Charger les données
    await loadAllData();
    
    showAlert(`✅ Bienvenue ${userData.name} !`, 'success');
    
  } catch (error) {
    console.error('❌ Erreur chargement utilisateur:', error);
    showAlert('❌ Erreur lors du chargement du profil: ' + error.message, 'danger');
    
    // Déconnexion en cas d'erreur
    try {
      await auth.signOut();
    } catch (logoutError) {
      console.error('Erreur déconnexion:', logoutError);
    }
    
    showLogin();
  } finally {
    showLoading(false);
  }
}
async function updateUserLoginInfo(uid) {
    try {
        await db.collection('users').doc(uid).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            loginCount: firebase.firestore.FieldValue.increment(1)
        });
    } catch (error) {
        console.error('Erreur mise à jour info connexion:', error);
    }
}

   // Fonction upload Cloudinary
    async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
      if (!file) return null;
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            formData.append('folder', folder);
            
            const response = await fetch(
              `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
              { 
                method: 'POST', 
                body: formData 
              }
            );
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            resolve(data.secure_url);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
        reader.readAsDataURL(file);
      });
    }

function setupUserInterface() {
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRole').textContent = userRole;
    
    // Ajouter la classe de badge
    const roleElement = document.getElementById('userRole');
    roleElement.className = `user-role badge-${userRole}`;
    
    showMainApp();
    setupPermissions();
}

function showMainApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('registerContainer').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    // Initialiser le premier onglet
    showTab('dashboard');
}

// ==================== PERMISSIONS ====================
function setupPermissions() {
    if (!userRole) return;
    
    setupTabPermissions();
    setupButtonPermissions();
    setupActionPermissions();
    updateUIWithPermissions();
}

function setupTabPermissions() {
    const tabPermissions = {
        'dashboard': 'view_dashboard',
        'add-article': 'add_articles',
        'sales': 'add_sales',
        'reservations': 'manage_reservations',
        'orders': 'view_orders',
        'stock': 'view_stock',
        'reports': 'view_reports',
        'archives': 'view_archives',
        'subscription': 'view_dashboard',
        'mobile-money': 'view_dashboard'
    };

    Object.entries(tabPermissions).forEach(([tabId, permission]) => {
        const tabButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
        if (tabButton) {
            if (hasPermission(permission)) {
                tabButton.style.display = 'flex';
            } else {
                tabButton.style.display = 'none';
            }
        }
    });
}

function setupButtonPermissions() {
    const buttonPermissions = {
        'reinitialiserApplication': 'reset_app',
        'manageUsers': 'manage_users',
        'viewAuditLogs': 'view_audit_logs'
    };

    Object.entries(buttonPermissions).forEach(([buttonId, permission]) => {
        const button = document.querySelector(`[onclick="${buttonId}()"]`);
        if (button) {
            button.style.display = hasPermission(permission) ? 'block' : 'none';
        }
    });
}

function setupActionPermissions() {
    // Les actions seront masquées dynamiquement lors de l'affichage des données
}

function updateUIWithPermissions() {
    // Masquer/montrer les éléments en fonction des permissions
    const elementsToCheck = [
        { selector: '#addArticleBtn', permission: 'add_articles' },
        { selector: '.btn-danger', permission: 'delete_articles' },
        { selector: '[onclick*="finaliserReservation"]', permission: 'manage_reservations' },
        { selector: '[onclick*="annulerReservation"]', permission: 'manage_reservations' },
        { selector: '[onclick*="manageOrder"]', permission: 'manage_orders' },
        { selector: '[onclick*="updateOrder"]', permission: 'manage_orders' }
    ];

    elementsToCheck.forEach(item => {
        const elements = document.querySelectorAll(item.selector);
        elements.forEach(element => {
            if (!hasPermission(item.permission)) {
                element.style.display = 'none';
            }
        });
    });
}



function hasPermission(permission) {
    return userPermissions.includes(permission);
}

function hasPermissionForAction(action) {
    if (!action) return true;
    
    if (action.includes('supprimerArticle') && !hasPermission('delete_articles')) return false;
    if (action.includes('finaliserReservation') && !hasPermission('manage_reservations')) return false;
    if (action.includes('annulerReservation') && !hasPermission('manage_reservations')) return false;
    if (action.includes('reinitialiserApplication') && !hasPermission('reset_app')) return false;
    if (action.includes('manageOrder') && !hasPermission('manage_orders')) return false;
    if (action.includes('updateOrder') && !hasPermission('manage_orders')) return false;
    
    return true;
}

function checkPermission(permission, actionName = 'cette action') {
    if (!hasPermission(permission)) {
        showAlert(`❌ Permission refusée pour ${actionName}`, 'danger');
        return false;
    }
    return true;
}

// ==================== GESTION DES DONNÉES ====================
async function loadAllData() {
    try {
        showLoading(true, 'Chargement des données...');
        
        await Promise.all([
            loadArticles(),
            loadVentes(),
            loadDepenses(),
            loadReservations(),
            loadOrders(),
            loadArchives()
        ]);

        updateInterface();
        showAlert('✅ Données chargées avec succès', 'success');

    } catch (error) {
        console.error('Erreur chargement données:', error);
        showAlert('❌ Erreur lors du chargement des données', 'danger');
    } finally {
        showLoading(false);
    }
}

async function loadArticles() {
    try {
        const articlesSnapshot = await db.collection('articles')
            .orderBy('createdAt', 'desc')
            .get();
        articles = articlesSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            // Assurer que les nombres sont bien des nombres
            prixAchat: Number(doc.data().prixAchat) || 0,
            prixVente: Number(doc.data().prixVente) || 0,
            quantite: Number(doc.data().quantite) || 0
        }));
    } catch (error) {
        console.error('Erreur chargement articles:', error);
        throw error;
    }
}

async function loadVentes() {
    try {
        // Créer la date d'aujourd'hui (début de journée)
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        
        // Créer la date de fin d'aujourd'hui
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);
        
        // Formater la date d'aujourd'hui pour la comparaison avec les ventes
        const todayFormatted = today.toLocaleDateString('fr-FR');
        
        // Option 1: Si vos ventes utilisent un timestamp Firestore
        const ventesSnapshot = await db.collection('ventes')
            .where('timestamp', '>=', todayStart)
            .where('timestamp', '<=', todayEnd)
            .orderBy('timestamp', 'desc')
            .get();
        
        // Option 2: Si vos ventes utilisent une chaîne de date
        // Vous devrez d'abord charger toutes les ventes et filtrer côté client
        /*
        const ventesSnapshot = await db.collection('ventes')
            .orderBy('timestamp', 'desc')
            .get();
        */
        
        ventes = [];
        
        ventesSnapshot.docs.forEach(doc => {
            const data = doc.data();
            
            // Vérifier si la vente est d'aujourd'hui
            let isToday = false;
            
            // Méthode 1: Vérifier via le timestamp
            if (data.timestamp) {
                const ventedate = data.timestamp.toDate ? 
                                 data.timestamp.toDate() : 
                                 new Date(data.timestamp);
                isToday = ventedate >= todayStart && ventedate <= todayEnd;
            }
            
            // Méthode 2: Vérifier via le champ date (si c'est une chaîne)
            if (data.date) {
                // Convertir "15/01/2024" en objet Date
                const dateParts = data.date.split('/');
                if (dateParts.length === 3) {
                    const ventedate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    isToday = ventedate.toLocaleDateString('fr-FR') === todayFormatted;
                }
            }
            
            if (isToday) {
                ventes.push({ 
                    id: doc.id, 
                    ...data,
                    quantite: Number(data.quantite) || 0,
                    prixUnitaire: Number(data.prixUnitaire) || 0,
                    total: Number(data.total) || 0,
                    montantVerse: Number(data.montantVerse) || 0,
                    resteAPayer: Number(data.resteAPayer) || 0
                });
            }
        });
        
        console.log(`📊 ${ventes.length} ventes chargées pour aujourd'hui (${todayFormatted})`);
        
    } catch (error) {
        console.error('Erreur chargement ventes:', error);
        // En cas d'erreur, essayer une méthode alternative
        await loadVentesFallback();
    }
}

// Méthode de secours si la requête Firestore échoue
async function loadVentesFallback() {
    try {
        const ventesSnapshot = await db.collection('ventes')
            .orderBy('timestamp', 'desc')
            .limit(100)
            .get();
        
        const todayFormatted = today.toLocaleDateString('fr-FR');
        
        ventes = ventesSnapshot.docs
            .map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                quantite: Number(doc.data().quantite) || 0,
                prixUnitaire: Number(doc.data().prixUnitaire) || 0,
                total: Number(doc.data().total) || 0,
                montantVerse: Number(doc.data().montantVerse) || 0,
                resteAPayer: Number(doc.data().resteAPayer) || 0
            }))
            .filter(vente => {
                // Filtrer pour garder uniquement les ventes d'aujourd'hui
                if (vente.date) {
                    return vente.date === todayFormatted;
                }
                return false;
            });
            
        console.log(`📊 ${ventes.length} ventes chargées (méthode fallback)`);
        
    } catch (error) {
        console.error('Erreur méthode fallback:', error);
        ventes = [];
    }
}


async function debugVentesData() {
    try {
        console.log('🔍 Debug des données de ventes:');
        
        const snapshot = await db.collection('ventes')
            .limit(5)
            .get();
            
        snapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            console.log(`Vente ${index + 1}:`, {
                id: doc.id,
                date: data.date,
                timestamp: data.timestamp,
                nom: data.nom,
                total: data.total
            });
        });
        
    } catch (error) {
        console.error('Erreur debug:', error);
    }
}

// Appelez cette fonction dans la console pour voir la structure de vos données
// debugVentesData();

async function loadDepenses() {
    try {
        const monthStart = new Date();
        monthStart.setDate(1);
        monthStart.setHours(0, 0, 0, 0);
        
        const depensesSnapshot = await db.collection('depenses')
            .where('timestamp', '>=', monthStart)
            .orderBy('timestamp', 'desc')
            .get();
        depenses = depensesSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            montant: Number(doc.data().montant) || 0
        }));
    } catch (error) {
        console.error('Erreur chargement dépenses:', error);
        throw error;
    }
}

async function loadReservations() {
    try {
        const reservationsSnapshot = await db.collection('reservations')
            .orderBy('timestamp', 'desc')
            .get();
        reservations = reservationsSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            quantite: Number(doc.data().quantite) || 0,
            prixUnitaire: Number(doc.data().prixUnitaire) || 0,
            total: Number(doc.data().total) || 0,
            montantVerse: Number(doc.data().montantVerse) || 0,
            resteAPayer: Number(doc.data().resteAPayer) || 0
        }));
    } catch (error) {
        console.error('Erreur chargement réservations:', error);
        throw error;
    }
}

async function loadOrders() {
    try {
        const ordersSnapshot = await db.collection('orders')
            .orderBy('timestamp', 'desc')
            .get();
        orders = ordersSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            quantite: Number(doc.data().quantite) || 0
        }));
        
        // Mettre à jour le badge de notification
        const pendingOrders = orders.filter(order => order.status === 'pending').length;
        const ordersBadge = document.getElementById('ordersBadge');
        if (ordersBadge) {
            if (pendingOrders > 0) {
                ordersBadge.textContent = pendingOrders;
                ordersBadge.style.display = 'inline-flex';
            } else {
                ordersBadge.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Erreur chargement commandes:', error);
        throw error;
    }
}

async function loadArchives() {
    try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const archivesSnapshot = await db.collection('archives')
            .where('timestamp', '>=', thirtyDaysAgo)
            .orderBy('timestamp', 'desc')
            .get();
        archives = archivesSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            quantite: Number(doc.data().quantite) || 0,
            prixUnitaire: Number(doc.data().prixUnitaire) || 0,
            total: Number(doc.data().total) || 0,
            montantVerse: Number(doc.data().montantVerse) || 0
        }));
    } catch (error) {
        console.error('Erreur chargement archives:', error);
        throw error;
    }
}

function updateInterface() {
    updateDashboard();
    afficherStock();
    remplirSelecteurs();
    afficherRapport();
    afficherDepenses();
    afficherVentesRecentes();
    afficherDepensesRecentes();
    afficherReservations();
    afficherCommandes();
    afficherArchives();
}

function updateDashboard() {
    // Calcul de la valeur du stock
    const valeurStock = articles.reduce((total, article) => {
        const prix = article.prixVente || 0;
        const quantite = article.quantite || 0;
        return total + (prix * quantite);
    }, 0);
    
    // Calcul du total des articles
    const totalArticles = articles.reduce((total, article) => {
        return total + (article.quantite || 0);
    }, 0);
    
    // Calcul des ventes d'aujourd'hui
    const ventesAujourdhui = ventes.reduce((total, vente) => {
        return total + (vente.montantVerse || 0);
    }, 0);
    
    // Calcul du nombre de commandes en attente
    const pendingOrders = orders.filter(order => order.status === 'pending').length;
    
    console.log('📊 Dashboard calculs:', {
        valeurStock,
        totalArticles,
        ventesAujourdhui,
        pendingOrders
    });

    // Mise à jour des éléments du tableau de bord
    document.getElementById('valeurStock').textContent = formatCurrency(valeurStock);
    document.getElementById('totalArticles').textContent = totalArticles.toLocaleString();
    document.getElementById('ventesAujourdhui').textContent = formatCurrency(ventesAujourdhui);
    document.getElementById('pendingOrders').textContent = pendingOrders;
    
    // Mise à jour des tendances
    updateDashboardTrends();
}

function updateDashboardTrends() {
    // Calculer les tendances par rapport à hier
    const hierVentes = ventes.length > 5 ? ventes.reduce((total, vente, index) => {
        return index < 5 ? total + vente.montantVerse : total;
    }, 0) : 0;
    
    const aujourdhuiVentes = ventes.reduce((total, vente) => total + vente.montantVerse, 0);
    
    const trendVentes = aujourdhuiVentes > hierVentes ? 'up' : 'down';
    const trendTextVentes = aujourdhuiVentes > hierVentes ? 'En hausse' : 'En baisse';
    
    document.getElementById('salesTrend').innerHTML = `
        <i class="fas fa-chart-bar trend-${trendVentes}"></i> 
        <span>${trendTextVentes}</span>
    `;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'xof',
        minimumFractionDigits: 0
    }).format(amount);
}

// ==================== GESTION ARTICLES ====================
async function ajouterArticle() {
    if (!checkPermission('add_articles', 'ajouter un article')) return;

    const nom = document.getElementById("nom").value.trim();
    const type = document.getElementById("type").value;
    const prixAchat = parseFloat(document.getElementById("prixAchat").value);
    const prixVente = parseFloat(document.getElementById("prixVente").value);
    const quantite = parseInt(document.getElementById("quantite").value);
    const description = document.getElementById("description").value.trim();

    if (!validateArticleForm(nom, type, prixAchat, prixVente, quantite)) return;

    try {
        showLoading(true, 'Ajout de l\'article...');

        // Vérifier si l'article existe déjà
        const existingArticle = articles.find(article => 
            article.nom.toLowerCase() === nom.toLowerCase() && 
            article.type === type
        );

        let imageUrl = null;
        if (selectedImage) {
            imageUrl = await uploadImage(selectedImage, `articles/${Date.now()}_${nom.replace(/\s+/g, '_')}`);
        }

        if (existingArticle) {
            // Mettre à jour la quantité de l'article existant
            const newQuantite = existingArticle.quantite + quantite;
            await db.collection('articles').doc(existingArticle.id).update({
                quantite: newQuantite,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await logOperation('article_mis_a_jour', `Quantité mise à jour: ${nom}`, {
                ancienneQuantite: existingArticle.quantite,
                nouvelleQuantite: newQuantite,
                quantiteAjoutee: quantite
            });
            
            showAlert(`✅ Quantité de "${nom}" mise à jour: ${existingArticle.quantite} → ${newQuantite}`, 'success');
        } else {
            // Créer un nouvel article
            const articleData = {
                nom, 
                type, 
                prixAchat, 
                prixVente, 
                quantite, 
                description, 
                image: imageUrl,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid,
                createdByName: userData.name,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('articles').add(articleData);
            await logOperation('ajout_article', `Ajout: ${nom}`, articleData);
            
            showAlert(`✅ Article "${nom}" ajouté avec succès`, 'success');
        }

        // Vérifier si des clients ont commandé cet article
        await checkOrdersForArticle(nom);
        
        resetArticleForm();
        await loadAllData();

    } catch (error) {
        console.error('Erreur ajout article:', error);
        showAlert('❌ Erreur lors de l\'ajout de l\'article', 'danger');
    } finally {
        showLoading(false);
    }
}

async function checkOrdersForArticle(articleName) {
    try {
        // Vérifier les commandes en attente pour cet article
        const pendingOrders = orders.filter(order => 
            order.article.toLowerCase().includes(articleName.toLowerCase()) && 
            order.status === 'pending'
        );
        
        if (pendingOrders.length > 0) {
            // Afficher la notification
            showOrderNotification(articleName, pendingOrders);
        }
    } catch (error) {
        console.error('Erreur vérification commandes:', error);
    }
}

function showOrderNotification(articleName, pendingOrders) {
    const notificationList = document.getElementById('orderNotificationList');
    let html = `<p><strong>${articleName}</strong> a été ajouté au stock.</p>`;
    html += `<p>Il y a ${pendingOrders.length} commande(s) en attente pour cet article :</p>`;
    html += '<ul style="text-align: left; margin: 15px 0;">';
    
    pendingOrders.forEach(order => {
        html += `<li>${order.client} (${order.telephone}) - ${order.quantite} unité(s)</li>`;
    });
    
    html += '</ul>';
    html += '<p>Vous pouvez maintenant traiter ces commandes.</p>';
    
    notificationList.innerHTML = html;
    document.getElementById('orderNotificationModal').style.display = 'flex';
}

function validateArticleForm(nom, type, prixAchat, prixVente, quantite) {
    if (!nom) {
        showAlert("Le nom de l'article est requis", "danger");
        return false;
    }
    
    if (!type) {
        showAlert("Veuillez sélectionner un type", "danger");
        return false;
    }
    
    if (isNaN(prixAchat) || prixAchat <= 0) {
        showAlert("Le prix d'achat doit être un nombre positif", "danger");
        return false;
    }
    
    if (isNaN(prixVente) || prixVente <= 0) {
        showAlert("Le prix de vente doit être un nombre positif", "danger");
        return false;
    }
    
    if (prixVente < prixAchat) {
        showAlert("Le prix de vente ne peut pas être inférieur au prix d'achat", "danger");
        return false;
    }
    
    if (isNaN(quantite) || quantite < 0) {
        showAlert("La quantité doit être un nombre positif", "danger");
        return false;
    }
    
    return true;
}

function resetArticleForm() {
    document.getElementById("nom").value = "";
    document.getElementById("type").value = "";
    document.getElementById("prixAchat").value = "";
    document.getElementById("prixVente").value = "";
    document.getElementById("quantite").value = "";
    document.getElementById("description").value = "";
    removeImage();
}

function afficherStock() {
    const tbody = document.querySelector("#tableStock tbody");
    const emptyState = document.getElementById('emptyStock');
    
    if (!tbody) return;
    
    if (articles.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        if (document.getElementById('totalStockValue')) {
            document.getElementById('totalStockValue').textContent = '0';
        }
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";
    
    let totalStockValue = 0;
    
    articles.forEach((article) => {
        const prixVente = article.prixVente;
        const valeurArticle = prixVente * article.quantite;
        totalStockValue += valeurArticle;
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                <div class="article-with-image">
                    ${article.image ? 
                        `<img src="${article.image}" alt="${article.nom}" class="article-image-small" onerror="this.style.display='none'">` : 
                        `<div class="article-image-placeholder"><i class="fas fa-tshirt"></i></div>`
                    }
                    <div>
                        <div style="font-weight:600;">${article.nom}</div>
                        ${article.description ? `<div style="font-size:0.8rem; color:#95a5a6;">${article.description}</div>` : ''}
                    </div>
                </div>
            </td>
            <td>${article.type}</td>
            <td>${formatCurrency(article.prixAchat)}</td>
            <td>
                ${formatCurrency(prixVente)}
                ${hasPermission('edit_articles') ? `
                    <button class="btn btn-sm btn-warning" onclick="modifierPrix('${article.id}')" style="margin-left: 5px; padding: 2px 6px;">
                        <i class="fas fa-edit"></i>
                    </button>
                ` : ''}
            </td>
            <td>
                <span class="${article.quantite < 10 ? 'text-danger' : article.quantite < 20 ? 'text-warning' : ''}">
                    ${article.quantite}
                </span>
            </td>
            <td>${formatCurrency(valeurArticle)}</td>
            <td class="action-buttons">
                ${hasPermission('delete_articles') ? `
                    <button class="btn btn-sm btn-danger" onclick="supprimerArticle('${article.id}')">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (document.getElementById('totalStockValue')) {
        document.getElementById('totalStockValue').textContent = formatCurrency(totalStockValue);
    }
}

async function modifierPrix(articleId) {
    if (!checkPermission('edit_articles', 'modifier le prix')) return;
    
    const article = articles.find(a => a.id === articleId);
    if (!article) {
        showAlert('Article non trouvé', 'danger');
        return;
    }

    const nouveauPrix = prompt(`Modifier le prix de vente de "${article.nom}" (ancien prix: ${formatCurrency(article.prixVente)})`, article.prixVente);
    
    if (nouveauPrix === null) return; // Annulé
    
    const prixNum = parseFloat(nouveauPrix);
    if (isNaN(prixNum) || prixNum <= 0) {
        showAlert('Prix invalide', 'danger');
        return;
    }

    if (prixNum < article.prixAchat) {
        showAlert('Le prix de vente ne peut pas être inférieur au prix d\'achat', 'danger');
        return;
    }

    try {
        showLoading(true, 'Modification du prix...');
        await db.collection('articles').doc(articleId).update({
            prixVente: prixNum,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await logOperation('prix_modifie', `Prix modifié: ${article.nom}`, {
            ancienPrix: article.prixVente,
            nouveauPrix: prixNum
        });
        
        showAlert(`✅ Prix de "${article.nom}" modifié avec succès`, 'success');
        await loadAllData();
    } catch (error) {
        console.error('Erreur modification prix:', error);
        showAlert('❌ Erreur lors de la modification du prix', 'danger');
    } finally {
        showLoading(false);
    }
}

async function supprimerArticle(articleId) {
    if (!checkPermission('delete_articles', 'supprimer un article')) return;
    
    const article = articles.find(a => a.id === articleId);
    if (!article) {
        showAlert('Article non trouvé', 'danger');
        return;
    }

    if (!confirm(`Êtes-vous sûr de vouloir supprimer l'article "${article.nom}" ? Cette action est irréversible.`)) {
        return;
    }

    try {
        showLoading(true, 'Suppression en cours...');
        await db.collection('articles').doc(articleId).delete();
        await logOperation('suppression_article', `Suppression: ${article.nom}`, article);
        showAlert('✅ Article supprimé avec succès', 'success');
        await loadAllData();
    } catch (error) {
        console.error('Erreur suppression:', error);
        showAlert('❌ Erreur lors de la suppression de l\'article', 'danger');
    } finally {
        showLoading(false);
    }
}

function filtrerStock() {
    filterTable('searchStock', 'tableStock');
}

// ==================== COMMANDES ====================
async function creerCommande() {
    if (!checkPermission('create_orders', 'créer une commande')) return;

    const client = document.getElementById("clientOrder").value.trim();
    const telephone = document.getElementById("telephoneOrder").value.trim();
    const article = document.getElementById("articleOrder").value.trim();
    const quantite = parseInt(document.getElementById("quantiteOrder").value);
    const notes = document.getElementById("notesOrder").value.trim();
    
    if (!validateOrderForm(client, telephone, article, quantite)) return;

    try {
        showLoading(true, 'Création de la commande...');

        const orderData = {
            client, 
            telephone,
            article, 
            quantite, 
            notes,
            status: 'pending',
            dateCommande: today,
            heureCommande: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            user: currentUser.uid,
            userName: userData.name
        };

        await db.collection('orders').add(orderData);
        await logOperation('commande', `Commande: ${client}`, orderData);

        showAlert(`✅ Commande créée pour ${client}`, 'success');
        resetOrderForm();
        await loadAllData();

    } catch (error) {
        console.error('Erreur création commande:', error);
        showAlert('❌ Erreur lors de la création de la commande', 'danger');
    } finally {
        showLoading(false);
    }
}

function validateOrderForm(client, telephone, article, quantite) {
    if (!client) {
        showAlert("Le nom du client est requis", "danger");
        return false;
    }
    
    if (!telephone) {
        showAlert("Le numéro de téléphone est requis", "danger");
        return false;
    }
    
    if (!article) {
        showAlert("L'article commandé est requis", "danger");
        return false;
    }
    
    if (isNaN(quantite) || quantite <= 0) {
        showAlert("La quantité doit être un nombre positif", "danger");
        return false;
    }

    return true;
}

function resetOrderForm() {
    document.getElementById("clientOrder").value = "";
    document.getElementById("telephoneOrder").value = "";
    document.getElementById("articleOrder").value = "";
    document.getElementById("quantiteOrder").value = "1";
    document.getElementById("notesOrder").value = "";
}

function afficherCommandes() {
    const tbody = document.querySelector("#tableOrders tbody");
    const emptyState = document.getElementById('emptyOrders');
    
    if (!tbody) return;
    
    if (orders.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";
    
    orders.forEach((order) => {
        const canManage = hasPermission('manage_orders');
        const statusClass = getOrderStatusClass(order.status);
        const statusText = getOrderStatusText(order.status);
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${order.client}</td>
            <td>${order.telephone}</td>
            <td>${order.article}</td>
            <td>${order.quantite}</td>
            <td>${order.dateCommande}</td>
            <td>
                <span class="order-status ${statusClass}">${statusText}</span>
            </td>
            <td class="action-buttons">
                ${canManage ? `
                    <button class="btn btn-sm btn-info" onclick="manageOrder('${order.id}')">
                        <i class="fas fa-edit"></i> Gérer
                    </button>
                ` : '<span class="text-muted">Actions non autorisées</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function getOrderStatusClass(status) {
    switch(status) {
        case 'pending': return 'order-pending';
        case 'processing': return 'order-processing';
        case 'completed': return 'order-completed';
        case 'cancelled': return 'order-cancelled';
        default: return 'order-pending';
    }
}

function getOrderStatusText(status) {
    switch(status) {
        case 'pending': return 'En attente';
        case 'processing': return 'En traitement';
        case 'completed': return 'Terminée';
        case 'cancelled': return 'Annulée';
        default: return 'En attente';
    }
}

function manageOrder(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
        showAlert('Commande non trouvée', 'danger');
        return;
    }
    
    currentOrderId = orderId;
    document.getElementById('orderDetails').innerHTML = `
        <div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <p><strong>Client:</strong> ${order.client}</p>
            <p><strong>Téléphone:</strong> ${order.telephone}</p>
            <p><strong>Article:</strong> ${order.article}</p>
            <p><strong>Quantité:</strong> ${order.quantite}</p>
            <p><strong>Date:</strong> ${order.dateCommande}</p>
            <p><strong>Notes:</strong> ${order.notes || 'Aucune'}</p>
        </div>
    `;
    
    document.getElementById('orderStatus').value = order.status;
    document.getElementById('orderNotes').value = order.notes || '';
    document.getElementById('orderModal').style.display = 'flex';
}

async function updateOrder() {
    if (!currentOrderId) return;
    
    const status = document.getElementById('orderStatus').value;
    const notes = document.getElementById('orderNotes').value.trim();
    const order = orders.find(o => o.id === currentOrderId);
    
    if (!order) {
        showAlert("Commande non trouvée", "danger");
        return;
    }

    try {
        showLoading(true, 'Mise à jour de la commande...');
        
        await db.collection('orders').doc(currentOrderId).update({
            status: status,
            notes: notes,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid,
            updatedByName: userData.name
        });

        await logOperation('commande_mise_a_jour', `Commande mise à jour: ${order.client}`, {
            ancienStatut: order.status,
            nouveauStatut: status
        });

        showAlert("✅ Commande mise à jour avec succès", 'success');
        document.getElementById('orderModal').style.display = 'none';
        currentOrderId = null;
        await loadAllData();

    } catch (error) {
        console.error('Erreur mise à jour commande:', error);
        showAlert('❌ Erreur lors de la mise à jour de la commande', 'danger');
    } finally {
        showLoading(false);
    }
}

function filtrerCommandes() {
    filterTable('searchOrders', 'tableOrders');
}

// ==================== VENTES MULTIPLES ====================
function ajouterAuPanier() {
    const index = document.getElementById("articleVente").value;
    const quantiteVendue = parseInt(document.getElementById("quantiteVente").value);
    
    if (index === '') {
        showAlert("Veuillez sélectionner un article", "danger");
        return;
    }
    
    if (isNaN(quantiteVendue) || quantiteVendue <= 0) {
        showAlert("La quantité doit être un nombre positif", "danger");
        return;
    }
    
    const article = articles[index];
    
    if (quantiteVendue > article.quantite) {
        showAlert(`❌ Stock insuffisant. ${article.quantite} unité(s) disponible(s)`, "danger");
        return;
    }

    // Vérifier si l'article est déjà dans le panier
    const existingItemIndex = panier.findIndex(item => item.articleId === article.id);
    
    if (existingItemIndex !== -1) {
        // Mettre à jour la quantité
        panier[existingItemIndex].quantite += quantiteVendue;
        panier[existingItemIndex].total = panier[existingItemIndex].quantite * panier[existingItemIndex].prixUnitaire;
    } else {
        // Ajouter un nouvel article au panier
        panier.push({
            articleId: article.id,
            nom: article.nom,
            prixUnitaire: article.prixVente,
            quantite: quantiteVendue,
            total: article.prixVente * quantiteVendue
        });
    }

    afficherPanier();
    document.getElementById("quantiteVente").value = "1";
}

function afficherPanier() {
    const cartItems = document.getElementById("cartItems");
    const cartTotal = document.getElementById("cartTotal");
    
    if (panier.length === 0) {
        cartItems.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Panier vide</p>';
        cartTotal.textContent = "Total: 0 FC";
        return;
    }
    
    let html = '';
    let totalGeneral = 0;
    
    panier.forEach((item, index) => {
        totalGeneral += item.total;
        html += `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div style="font-weight: 600;">${item.nom}</div>
                    <div style="font-size: 0.9rem; color: var(--gray);">
                        ${formatCurrency(item.prixUnitaire)} x ${item.quantite} = ${formatCurrency(item.total)}
                    </div>
                </div>
                <div class="cart-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="retirerDuPanier(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    cartTotal.textContent = `Total: ${formatCurrency(totalGeneral)}`;
    
    // Mettre à jour le montant versé par défaut
    document.getElementById("montantVerse").value = totalGeneral;
}

function retirerDuPanier(index) {
    panier.splice(index, 1);
    afficherPanier();
}

async function validerPaiement() {
    if (!checkAuth()) return;

    const montantVerse = parseFloat(document.getElementById("montantVerse").value);
    
    if (panier.length === 0) {
        showAlert("Le panier est vide", "danger");
        return;
    }
    
    if (isNaN(montantVerse) || montantVerse < 0) {
        showAlert("Le montant versé doit être un nombre positif", "danger");
        return;
    }

    const totalGeneral = panier.reduce((total, item) => total + item.total, 0);
    
    if (montantVerse > totalGeneral) {
        showAlert("Le montant versé ne peut pas être supérieur au total", "danger");
        return;
    }

    try {
        showLoading(true, 'Validation du paiement...');

        // Vérifier le stock pour tous les articles
        for (const item of panier) {
            const articleRef = db.collection('articles').doc(item.articleId);
            const articleDoc = await articleRef.get();
            const currentStock = articleDoc.data().quantite;

            if (item.quantite > currentStock) {
                showAlert(`❌ Stock insuffisant pour "${item.nom}". Il ne reste que ${currentStock} unité(s) disponible(s).`, 'danger');
                return;
            }
        }

        // Mettre à jour le stock et enregistrer les ventes
        const venteIds = [];
        const heure = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        for (const item of panier) {
            // Mettre à jour stock
            const articleRef = db.collection('articles').doc(item.articleId);
            await articleRef.update({
                quantite: firebase.firestore.FieldValue.increment(-item.quantite)
            });

            // Enregistrer la vente
            const venteData = {
                nom: item.nom,
                quantite: item.quantite,
                prixUnitaire: item.prixUnitaire,
                total: item.total,
                montantVerse: 0, // Seront calculés globalement
                resteAPayer: 0,
                vendeur: userData.name,
                date: today,
                heure: heure,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                user: currentUser.uid,
                userName: userData.name,
                articleId: item.articleId
            };

            const venteRef = await db.collection('ventes').add(venteData);
            venteIds.push(venteRef.id);
            
            await logOperation('vente', `Vente: ${item.quantite} ${item.nom}`, venteData);
        }

        // Calculer les montants globaux
        const resteAPayer = totalGeneral - montantVerse;
        
        // Créer une vente globale pour la facture
        const venteGlobale = {
            id: 'global_' + Date.now(),
            articles: [...panier],
            totalGeneral: totalGeneral,
            montantVerse: montantVerse,
            resteAPayer: resteAPayer,
            vendeur: userData.name,
            date: today,
            heure: heure,
            venteIds: venteIds
        };

        // Archiver les ventes
        for (const item of panier) {
            const archiveData = {
                nom: item.nom,
                quantite: item.quantite,
                prixUnitaire: item.prixUnitaire,
                total: item.total,
                montantVerse: (montantVerse * (item.total / totalGeneral)), // Proportionnel
                vendeur: userData.name,
                date: today,
                heure: heure,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                user: currentUser.uid,
                type: 'vente'
            };
            await db.collection('archives').add(archiveData);
        }

        // Générer la facture
        genererFacture(venteGlobale);
        
        showAlert(`✅ Vente enregistrée: ${formatCurrency(totalGeneral)}`, 'success');
        resetVenteForm();
        await loadAllData();

    } catch (error) {
        console.error('Erreur vente:', error);
        showAlert('❌ Erreur lors de l\'enregistrement de la vente', 'danger');
    } finally {
        showLoading(false);
    }
}


// ==================== EXPORT STOCK AVANCÉ ====================

function exporterStockExcel() {
    if (articles.length === 0) {
        showAlert("❌ Aucun article en stock à exporter", "warning");
        return;
    }

    try {
        showLoading(true, 'Génération du fichier Excel...');
        
        // Préparer les données
        const data = articles.map((article, index) => ({
            'N°': index + 1,
            'Article': article.nom,
            'Type': article.type,
            'Description': article.description || '',
            'Prix d\'Achat (FC)': article.prixAchat,
            'Prix de Vente (FC)': article.prixVente,
            'Quantité': article.quantite,
            'Valeur Stock (FC)': article.prixVente * article.quantite,
            'Marge (FC)': article.prixVente - article.prixAchat,
            'Marge (%)': article.prixAchat > 0 ? 
                (((article.prixVente - article.prixAchat) / article.prixAchat) * 100).toFixed(2) + '%' : 'N/A',
            'Statut': article.quantite < 5 ? 'CRITIQUE' : 
                     article.quantite < 15 ? 'FAIBLE' : 'NORMAL',
            'Dernière Mise à jour': article.lastUpdated ? 
                article.lastUpdated.toDate().toLocaleDateString('fr-FR') : 'N/A'
        }));

        // Calculer les totaux
        const totalValeur = articles.reduce((sum, article) => 
            sum + (article.prixVente * article.quantite), 0);
        const totalQuantite = articles.reduce((sum, article) => 
            sum + article.quantite, 0);
        const totalInvestissement = articles.reduce((sum, article) => 
            sum + (article.prixAchat * article.quantite), 0);
        const beneficePotentiel = totalValeur - totalInvestissement;

        // Créer le workbook
        const wb = XLSX.utils.book_new();
        
        // Feuille de données principales
        const ws_data = [
            // En-tête
            ['RAPPORT DU STOCK - TheoVêt'],
            [`Date de génération: ${new Date().toLocaleString('fr-FR')}`],
            [`Généré par: ${userData.name} (${userRole})`],
            [], // Ligne vide
            // En-têtes du tableau
            Object.keys(data[0])
        ];

        // Ajouter les données
        data.forEach(row => {
            ws_data.push(Object.values(row));
        });

        // Ajouter les totaux
        ws_data.push([]); // Ligne vide
        ws_data.push(['TOTAUX', '', '', '', '', '', '', '', '', '', '', '']);
        ws_data.push([
            'Total Articles:', articles.length,
            'Total Quantité:', totalQuantite,
            'Valeur Totale:', formatCurrency(totalValeur),
            'Investissement:', formatCurrency(totalInvestissement),
            'Bénéfice Potentiel:', formatCurrency(beneficePotentiel),
            'Moyenne Marge:', article.prixAchat > 0 ? 
                ((beneficePotentiel / totalInvestissement) * 100).toFixed(2) + '%' : 'N/A'
        ]);

        // Créer la feuille de calcul
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // Ajuster la largeur des colonnes
        const colWidths = [
            { wch: 5 },   // N°
            { wch: 30 },  // Article
            { wch: 15 },  // Type
            { wch: 40 },  // Description
            { wch: 15 },  // Prix Achat
            { wch: 15 },  // Prix Vente
            { wch: 10 },  // Quantité
            { wch: 15 },  // Valeur Stock
            { wch: 12 },  // Marge
            { wch: 12 },  // Marge %
            { wch: 12 },  // Statut
            { wch: 20 }   // Dernière Mise à jour
        ];
        ws['!cols'] = colWidths;

        // Ajouter la feuille au workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Stock');

        // Feuille 2 : Analyse par type
        const types = {};
        articles.forEach(article => {
            if (!types[article.type]) {
                types[article.type] = {
                    count: 0,
                    quantity: 0,
                    value: 0,
                    investment: 0
                };
            }
            types[article.type].count++;
            types[article.type].quantity += article.quantite;
            types[article.type].value += article.prixVente * article.quantite;
            types[article.type].investment += article.prixAchat * article.quantite;
        });

        const typeData = Object.entries(types).map(([type, stats]) => [
            type,
            stats.count,
            stats.quantity,
            formatCurrency(stats.value),
            formatCurrency(stats.investment),
            formatCurrency(stats.value - stats.investment),
            stats.investment > 0 ? 
                (((stats.value - stats.investment) / stats.investment) * 100).toFixed(2) + '%' : 'N/A'
        ]);

        const ws2_data = [
            ['ANALYSE PAR TYPE DE PRODUIT'],
            [],
            ['Type', 'Nombre Articles', 'Quantité Totale', 'Valeur Totale', 'Investissement', 'Bénéfice Potentiel', 'Marge %'],
            ...typeData
        ];

        const ws2 = XLSX.utils.aoa_to_sheet(ws2_data);
        const colWidths2 = [
            { wch: 20 },
            { wch: 15 },
            { wch: 15 },
            { wch: 15 },
            { wch: 15 },
            { wch: 20 },
            { wch: 12 }
        ];
        ws2['!cols'] = colWidths2;
        XLSX.utils.book_append_sheet(wb, ws2, 'Analyse par Type');

        // Générer et télécharger le fichier
        const fileName = `stock_theovet_${today.replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showAlert(`✅ Rapport Excel exporté: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erreur export Excel:', error);
        showAlert('❌ Erreur lors de l\'export Excel', 'danger');
    } finally {
        showLoading(false);
    }
}

function exporterStockCSV() {
    if (articles.length === 0) {
        showAlert("❌ Aucun article en stock à exporter", "warning");
        return;
    }

    try {
        showLoading(true, 'Génération du fichier CSV...');
        
        // En-têtes CSV
        const headers = [
            'Article',
            'Type',
            'Description',
            'Prix Achat (FC)',
            'Prix Vente (FC)',
            'Quantité',
            'Valeur Stock (FC)',
            'Marge (FC)',
            'Marge (%)',
            'Statut Stock',
            'Date Ajout'
        ];

        // Données
        const rows = articles.map(article => [
            `"${article.nom}"`,
            `"${article.type}"`,
            `"${article.description || ''}"`,
            article.prixAchat,
            article.prixVente,
            article.quantite,
            article.prixVente * article.quantite,
            article.prixVente - article.prixAchat,
            article.prixAchat > 0 ? 
                (((article.prixVente - article.prixAchat) / article.prixAchat) * 100).toFixed(2) + '%' : 'N/A',
            article.quantite < 5 ? 'CRITIQUE' : 
            article.quantite < 15 ? 'FAIBLE' : 'NORMAL',
            article.createdAt ? 
                article.createdAt.toDate().toLocaleDateString('fr-FR') : 'N/A'
        ]);

        // Calculer les totaux
        const totalValeur = articles.reduce((sum, article) => 
            sum + (article.prixVente * article.quantite), 0);
        const totalQuantite = articles.reduce((sum, article) => 
            sum + article.quantite, 0);

        // Créer le contenu CSV
        let csvContent = headers.join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.join(',') + '\n';
        });

        // Ajouter les totaux
        csvContent += '\n';
        csvContent += `Total Articles,${articles.length}\n`;
        csvContent += `Total Quantité,${totalQuantite}\n`;
        csvContent += `Valeur Totale du Stock,${totalValeur} FC\n`;
        csvContent += `Date d'export,${new Date().toLocaleString('fr-FR')}\n`;
        csvContent += `Exporté par,${userData.name}\n`;

        // Créer et télécharger le fichier
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `stock_theovet_${today.replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert(`✅ Fichier CSV exporté avec succès`, 'success');
        
    } catch (error) {
        console.error('Erreur export CSV:', error);
        showAlert('❌ Erreur lors de l\'export CSV', 'danger');
    } finally {
        showLoading(false);
    }
}

async function genererRapportStockComplet() {
    if (articles.length === 0) {
        showAlert("❌ Aucun article en stock pour générer un rapport", "warning");
        return;
    }

    try {
        showLoading(true, 'Génération du rapport détaillé...');
        
        // Créer le PDF
        const doc = new jsPDF('landscape');
        
        // ===== PAGE 1 : RAPPORT DÉTAILLÉ =====
        // En-tête
        doc.setFontSize(24);
        doc.setTextColor(52, 152, 219);
        doc.text("📊 RAPPORT COMPLET DU STOCK", 148, 20, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Date: ${today} | Généré par: ${userData.name} | Rôle: ${userRole}`, 148, 28, { align: "center" });
        
        // Statistiques générales
        const totalValeur = articles.reduce((sum, article) => 
            sum + (article.prixVente * article.quantite), 0);
        const totalQuantite = articles.reduce((sum, article) => 
            sum + article.quantite, 0);
        const totalInvestissement = articles.reduce((sum, article) => 
            sum + (article.prixAchat * article.quantite), 0);
        const beneficePotentiel = totalValeur - totalInvestissement;
        const margeMoyenne = totalInvestissement > 0 ? 
            (beneficePotentiel / totalInvestissement * 100).toFixed(2) : 0;
        
        // Boîte de statistiques
        doc.setFillColor(240, 248, 255);
        doc.rect(10, 35, 276, 25, 'F');
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        
        const stats = [
            `Articles: ${articles.length}`,
            `Quantité totale: ${totalQuantite}`,
            `Valeur stock: ${formatCurrency(totalValeur)}`,
            `Investissement: ${formatCurrency(totalInvestissement)}`,
            `Bénéfice potentiel: ${formatCurrency(beneficePotentiel)}`,
            `Marge moyenne: ${margeMoyenne}%`
        ];
        
        stats.forEach((stat, i) => {
            const x = 15 + (i % 3) * 90;
            const y = 45 + Math.floor(i / 3) * 8;
            doc.text(stat, x, y);
        });
        
        // Tableau principal
        const tableData = articles.map((article, index) => [
            (index + 1).toString(),
            article.nom.length > 20 ? article.nom.substring(0, 17) + '...' : article.nom,
            article.type,
            formatCurrency(article.prixAchat),
            formatCurrency(article.prixVente),
            article.quantite.toString(),
            formatCurrency(article.prixVente * article.quantite),
            formatCurrency(article.prixVente - article.prixAchat),
            article.prixAchat > 0 ? 
                (((article.prixVente - article.prixAchat) / article.prixAchat) * 100).toFixed(2) + '%' : 'N/A',
            getStockStatus(article.quantite)
        ]);
        
        doc.autoTable({
            startY: 65,
            head: [['#', 'Article', 'Type', 'Prix Achat', 'Prix Vente', 'Qty', 'Valeur', 'Marge', 'Marge %', 'Statut']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [52, 152, 219], 
                textColor: 255, 
                fontStyle: 'bold',
                fontSize: 9
            },
            styles: { 
                fontSize: 8,
                cellPadding: 3,
                overflow: 'linebreak'
            },
            columnStyles: {
                0: { cellWidth: 10 },
                1: { cellWidth: 40 },
                2: { cellWidth: 25 },
                3: { cellWidth: 25 },
                4: { cellWidth: 25 },
                5: { cellWidth: 15 },
                6: { cellWidth: 25 },
                7: { cellWidth: 25 },
                8: { cellWidth: 20 },
                9: { cellWidth: 20 }
            },
            didParseCell: function(data) {
                // Colorier les lignes selon le statut du stock
                if (data.row.index >= 0) {
                    const quantite = articles[data.row.index].quantite;
                    if (quantite < 5) {
                        data.cell.styles.fillColor = [255, 235, 238]; // Rouge clair
                    } else if (quantite < 15) {
                        data.cell.styles.fillColor = [255, 249, 196]; // Jaune clair
                    }
                }
            }
        });
        
        // ===== PAGE 2 : ANALYSE PAR TYPE =====
        doc.addPage('landscape');
        
        doc.setFontSize(20);
        doc.setTextColor(46, 204, 113);
        doc.text("📈 ANALYSE PAR TYPE DE PRODUIT", 148, 20, { align: "center" });
        
        // Grouper par type
        const types = {};
        articles.forEach(article => {
            if (!types[article.type]) {
                types[article.type] = {
                    count: 0,
                    quantity: 0,
                    value: 0,
                    investment: 0,
                    articles: []
                };
            }
            types[article.type].count++;
            types[article.type].quantity += article.quantite;
            types[article.type].value += article.prixVente * article.quantite;
            types[article.type].investment += article.prixAchat * article.quantite;
            types[article.type].articles.push(article.nom);
        });
        
        // Tableau d'analyse
        const analysisData = Object.entries(types).map(([type, stats]) => [
            type,
            stats.count.toString(),
            stats.quantity.toString(),
            formatCurrency(stats.value),
            formatCurrency(stats.investment),
            formatCurrency(stats.value - stats.investment),
            stats.investment > 0 ? 
                (((stats.value - stats.investment) / stats.investment) * 100).toFixed(2) + '%' : 'N/A',
            (stats.value / totalValeur * 100).toFixed(1) + '%'
        ]);
        
        doc.autoTable({
            startY: 30,
            head: [['Type', 'Articles', 'Quantité', 'Valeur', 'Investissement', 'Bénéfice', 'Marge %', '% Total']],
            body: analysisData,
            theme: 'grid',
            headStyles: { 
                fillColor: [46, 204, 113], 
                textColor: 255, 
                fontStyle: 'bold' 
            },
            styles: { 
                fontSize: 9,
                cellPadding: 4
            },
            columnStyles: {
                7: { halign: 'center' }
            }
        });
        
        // Diagramme circulaire (simulé)
        const pieY = doc.lastAutoTable.finalY + 20;
        doc.setFontSize(14);
        doc.setTextColor(52, 73, 94);
        doc.text("📊 Répartition de la valeur par type", 20, pieY);
        
        // Dessiner un diagramme circulaire simple
        drawPieChart(doc, types, totalValeur, pieY + 10);
        
        // ===== PAGE 3 : ALERTES ET RECOMMANDATIONS =====
        doc.addPage('landscape');
        
        doc.setFontSize(20);
        doc.setTextColor(231, 76, 60);
        doc.text("⚠️ ALERTES ET RECOMMANDATIONS", 148, 20, { align: "center" });
        
        // Articles à faible stock
        const lowStock = articles.filter(a => a.quantite < 15);
        const criticalStock = articles.filter(a => a.quantite < 5);
        
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        let yPos = 35;
        
        if (criticalStock.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.setTextColor(231, 76, 60);
            doc.text("🚨 STOCK CRITIQUE (< 5 unités)", 20, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 8;
            
            criticalStock.forEach((article, i) => {
                doc.text(`• ${article.nom}: ${article.quantite} unités restantes`, 25, yPos);
                yPos += 7;
            });
            yPos += 5;
        }
        
        if (lowStock.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.setTextColor(243, 156, 18);
            doc.text("⚠️ STOCK FAIBLE (5-15 unités)", 20, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 8;
            
            lowStock.forEach((article, i) => {
                doc.text(`• ${article.nom}: ${article.quantite} unités restantes`, 25, yPos);
                yPos += 7;
            });
            yPos += 5;
        }
        
        // Articles les plus rentables
        const profitable = [...articles]
            .sort((a, b) => {
                const margeA = a.prixVente - a.prixAchat;
                const margeB = b.prixVente - b.prixAchat;
                return margeB - margeA;
            })
            .slice(0, 5);
        
        doc.setFont(undefined, 'bold');
        doc.setTextColor(39, 174, 96);
        doc.text("🏆 TOP 5 ARTICLES LES PLUS RENTABLES", 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;
        
        profitable.forEach((article, i) => {
            const marge = article.prixVente - article.prixAchat;
            const margePourcentage = article.prixAchat > 0 ? 
                (marge / article.prixAchat * 100).toFixed(1) : 0;
            
            doc.text(`${i + 1}. ${article.nom}: ${formatCurrency(marge)} (${margePourcentage}%)`, 25, yPos);
            yPos += 7;
        });
        
        // Recommandations
        yPos += 10;
        doc.setFont(undefined, 'bold');
        doc.setTextColor(52, 152, 219);
        doc.text("💡 RECOMMANDATIONS", 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;
        
        const recommendations = [
            `Réapprovisionner ${criticalStock.length} article(s) en stock critique`,
            `Surveiller ${lowStock.length} article(s) en stock faible`,
            `Promouvoir les articles à forte marge`,
            `Réviser les prix des articles à faible rotation`,
            `Considérer des promotions pour écouler le vieux stock`
        ];
        
        recommendations.forEach((rec, i) => {
            doc.text(`• ${rec}`, 25, yPos);
            yPos += 7;
        });
        
        // Pied de page
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Rapport généré le ${new Date().toLocaleString('fr-FR')}`, 148, 190, { align: "center" });
        doc.text("TheoVêt - Gestion de Stock Intelligente", 148, 195, { align: "center" });
        
        // Sauvegarder le PDF
        const fileName = `rapport_stock_complet_${today.replace(/\//g, '-')}.pdf`;
        doc.save(fileName);
        
        showAlert(`✅ Rapport complet exporté: ${fileName}`, 'success');
        
        // Journaliser l'action
        await logOperation('rapport_stock', `Rapport stock complet exporté`, {
            nombreArticles: articles.length,
            valeurTotale: totalValeur,
            nomFichier: fileName
        });
        
    } catch (error) {
        console.error('Erreur rapport complet:', error);
        showAlert('❌ Erreur lors de la génération du rapport', 'danger');
    } finally {
        showLoading(false);
    }
}

// Fonction utilitaire pour le statut du stock
function getStockStatus(quantity) {
    if (quantity === 0) return 'RUPTURE';
    if (quantity < 5) return 'CRITIQUE';
    if (quantity < 15) return 'FAIBLE';
    if (quantity < 30) return 'MOYEN';
    return 'BON';
}

// Fonction pour dessiner un diagramme circulaire simple
function drawPieChart(doc, types, totalValue, startY) {
    const centerX = 80;
    const centerY = startY + 40;
    const radius = 35;
    
    let currentAngle = 0;
    const colors = [
        [52, 152, 219],   // Bleu
        [46, 204, 113],   // Vert
        [155, 89, 182],   // Violet
        [241, 196, 15],   // Jaune
        [230, 126, 34],   // Orange
        [231, 76, 60],    // Rouge
        [149, 165, 166],  // Gris
        [22, 160, 133]    // Turquoise
    ];
    
    // Trier les types par valeur décroissante
    const sortedTypes = Object.entries(types)
        .sort((a, b) => b[1].value - a[1].value);
    
    // Dessiner les sections
    sortedTypes.forEach(([type, data], index) => {
        const percentage = (data.value / totalValue);
        const angle = percentage * 2 * Math.PI;
        
        // Couleur
        const color = colors[index % colors.length];
        doc.setFillColor(color[0], color[1], color[2]);
        
        // Dessiner la section
        doc.ellipse(centerX, centerY, radius, radius, 0, 
                   currentAngle, currentAngle + angle, 'F');
        
        currentAngle += angle;
    });
    
    // Dessiner le centre
    doc.setFillColor(255, 255, 255);
    doc.circle(centerX, centerY, radius * 0.4, 'F');
    
    // Légende
    const legendX = 130;
    let legendY = startY;
    
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);
    
    sortedTypes.forEach(([type, data], index) => {
        const color = colors[index % colors.length];
        const percentage = ((data.value / totalValue) * 100).toFixed(1);
        
        // Carré de couleur
        doc.setFillColor(color[0], color[1], color[2]);
        doc.rect(legendX, legendY, 5, 5, 'F');
        
        // Texte
        doc.text(`${type}: ${percentage}% (${formatCurrency(data.value)})`, 
                legendX + 8, legendY + 4);
        
        legendY += 8;
    });
}

// Fonction améliorée pour exporter le stock en PDF
function exporterPDF() {
    if (articles.length === 0) {
        showAlert("❌ Aucun article en stock à exporter", "warning");
        return;
    }

    try {
        const doc = new jsPDF('landscape');
        
        // En-tête
        doc.setFontSize(22);
        doc.setTextColor(52, 152, 219);
        doc.text("📦 RAPPORT DU STOCK - TheoVêt", 148, 20, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Date: ${today} | Généré par: ${userData.name} | Total: ${articles.length} articles`, 148, 28, { align: "center" });
        
        // Statistiques rapides
        const totalValeur = articles.reduce((sum, article) => 
            sum + (article.prixVente * article.quantite), 0);
        const totalQuantite = articles.reduce((sum, article) => 
            sum + article.quantite, 0);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        doc.text(`Valeur totale du stock: ${formatCurrency(totalValeur)}`, 20, 40);
        doc.text(`Quantité totale: ${totalQuantite} unités`, 20, 47);
        
        // Tableau des articles
        const tableData = articles.map((article, index) => [
            (index + 1).toString(),
            article.nom.length > 25 ? article.nom.substring(0, 22) + '...' : article.nom,
            article.type,
            formatCurrency(article.prixAchat),
            formatCurrency(article.prixVente),
            article.quantite.toString(),
            formatCurrency(article.prixVente * article.quantite),
            article.quantite < 5 ? 'CRITIQUE' : 
            article.quantite < 15 ? 'FAIBLE' : 'NORMAL'
        ]);
        
        doc.autoTable({
            startY: 55,
            head: [['#', 'Article', 'Type', 'Prix Achat', 'Prix Vente', 'Quantité', 'Valeur', 'Statut']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [52, 152, 219], 
                textColor: 255, 
                fontStyle: 'bold',
                fontSize: 10
            },
            styles: { 
                fontSize: 9,
                cellPadding: 4
            },
            columnStyles: {
                1: { cellWidth: 50 },
                7: { halign: 'center' }
            },
            didParseCell: function(data) {
                // Colorier les lignes selon le statut du stock
                if (data.column.index === 7 && data.cell.raw === 'CRITIQUE') {
                    data.cell.styles.textColor = [231, 76, 60];
                    data.cell.styles.fontStyle = 'bold';
                } else if (data.column.index === 7 && data.cell.raw === 'FAIBLE') {
                    data.cell.styles.textColor = [243, 156, 18];
                    data.cell.styles.fontStyle = 'bold';
                }
            },
            willDrawCell: function(data) {
                // Surligner les lignes avec stock critique
                if (data.row.index >= 0) {
                    const quantite = articles[data.row.index].quantite;
                    if (quantite < 5) {
                        doc.setFillColor(255, 235, 238);
                        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                    }
                }
            }
        });
        
        // Pied de page
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Document généré le ${new Date().toLocaleString('fr-FR')}`, 148, finalY, { align: "center" });
        doc.text("TheoVêt - Solution de gestion de commerce", 148, finalY + 5, { align: "center" });
        
        doc.save(`stock_theovet_${today.replace(/\//g, '-')}.pdf`);
        showAlert("✅ Rapport PDF exporté avec succès", 'success');
    } catch (error) {
        console.error('Erreur export PDF:', error);
        showAlert('❌ Erreur lors de l\'export PDF', 'danger');
    }
}

function genererFacture(vente) {
    currentInvoice = vente;
    
    const invoiceContent = document.getElementById('invoiceContent');
    let articlesHTML = '';
    
    vente.articles.forEach(item => {
        articlesHTML += `
            <tr>
                <td>${item.nom}</td>
                <td>${formatCurrency(item.prixUnitaire)}</td>
                <td>${item.quantite}</td>
                <td>${formatCurrency(item.total)}</td>
            </tr>
        `;
    });
    
    invoiceContent.innerHTML = `
        <div class="invoice-header">
            <h1 style="color: var(--primary); margin-bottom: 10px;">TheoVêt</h1>
            <p style="margin: 0;">Facture de vente</p>
            <p style="margin: 5px 0; font-size: 0.9rem;">${vente.date} - ${vente.heure}</p>
        </div>
        
        <div class="invoice-details">
            <div>
                <h3>Vendeur</h3>
                <p>${vente.vendeur}</p>
            </div>
            <div>
                <h3>Informations</h3>
                <p>Date: ${vente.date}</p>
                <p>Heure: ${vente.heure}</p>
            </div>
        </div>
        
        <div class="invoice-items">
            <h3>Articles vendus</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background: var(--light);">
                        <th style="padding: 10px; text-align: left;">Article</th>
                        <th style="padding: 10px; text-align: right;">Prix unitaire</th>
                        <th style="padding: 10px; text-align: center;">Quantité</th>
                        <th style="padding: 10px; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${articlesHTML}
                </tbody>
            </table>
        </div>
        
        <div class="invoice-totals">
            <p><strong>Total: ${formatCurrency(vente.totalGeneral)}</strong></p>
            <p>Montant versé: ${formatCurrency(vente.montantVerse)}</p>
            <p>Reste à payer: ${formatCurrency(vente.resteAPayer)}</p>
        </div>
        
        <div class="invoice-footer">
            <p>Merci pour votre achat !</p>
            <p>TheoVêt - Votre partenaire mode</p>
        </div>
    `;
    
    document.getElementById('invoiceModal').style.display = 'flex';
}

function imprimerFacture() {
    const printContent = document.getElementById('invoiceContent').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // Recharger l'interface
    showTab('sales');
}

function telechargerFacture() {
    if (!currentInvoice) return;
    
    const doc = new jsPDF();
    
    // En-tête
    doc.setFontSize(20);
    doc.setTextColor(52, 152, 219);
    doc.text("TheoVêt - Facture", 105, 20, { align: "center" });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Date: ${currentInvoice.date} | Heure: ${currentInvoice.heure} | Vendeur: ${currentInvoice.vendeur}`, 105, 30, { align: "center" });
    
    // Articles
    const tableData = currentInvoice.articles.map(item => [
        item.nom,
        formatCurrency(item.prixUnitaire),
        item.quantite.toString(),
        formatCurrency(item.total)
    ]);
    
    doc.autoTable({
        startY: 40,
        head: [['Article', 'Prix unitaire', 'Quantité', 'Total']],
        body: tableData,
        theme: 'grid'
    });
    
    // Totaux
    const finalY = doc.lastAutoTable.finalY + 15;
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    
    doc.text("Total général:", 20, finalY);
    doc.text(formatCurrency(currentInvoice.totalGeneral), 80, finalY);
    
    doc.text("Montant versé:", 20, finalY + 8);
    doc.text(formatCurrency(currentInvoice.montantVerse), 80, finalY + 8);
    
    doc.text("Reste à payer:", 20, finalY + 16);
    doc.text(formatCurrency(currentInvoice.resteAPayer), 80, finalY + 16);
    
    // Pied de page
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text("Merci pour votre achat ! - TheoVêt", 105, 280, { align: "center" });
    
    doc.save(`facture_theovet_${currentInvoice.date.replace(/\//g, '-')}.pdf`);
}

function resetVenteForm() {
    panier = [];
    afficherPanier();
    document.getElementById("montantVerse").value = "";
    remplirSelecteurVente();
}

// ==================== RÉSERVATIONS ====================
async function creerReservation() {
    if (!checkPermission('manage_reservations', 'créer une réservation')) return;

    const client = document.getElementById("clientReservation").value.trim();
    const telephone = document.getElementById("telephoneReservation").value.trim();
    const index = document.getElementById("articleReservation").value;
    const quantite = parseInt(document.getElementById("quantiteReservation").value);
    const montantVerse = parseFloat(document.getElementById("montantVerseReservation").value);
    
    if (!validateReservation(client, telephone, index, quantite, montantVerse)) return;

    const article = articles[index];
    const prix = article.prixVente; // Utiliser le prix défini
    const total = quantite * prix;
    const resteAPayer = total - montantVerse;

    try {
        showLoading(true, 'Création de la réservation...');

        // Vérifier à nouveau le stock
        const articleRef = db.collection('articles').doc(article.id);
        const articleDoc = await articleRef.get();
        const currentStock = articleDoc.data().quantite;

        if (quantite > currentStock) {
            showAlert(`❌ Stock insuffisant. ${currentStock} unité(s) disponible(s)`, "danger");
            return;
        }

        // Réserver le stock
        await articleRef.update({
            quantite: currentStock - quantite
        });

        const reservationData = {
            client, 
            telephone,
            article: article.nom,
            articleId: article.id,
            quantite, 
            prixUnitaire: prix, 
            total, 
            montantVerse, 
            resteAPayer,
            dateReservation: today,
            heureReservation: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            user: currentUser.uid,
            userName: userData.name,
            status: 'active'
        };

        await db.collection('reservations').add(reservationData);
        await logOperation('reservation', `Réservation: ${client}`, reservationData);

        showAlert(`✅ Réservation créée pour ${client}`, 'success');
        resetReservationForm();
        await loadAllData();

    } catch (error) {
        console.error('Erreur réservation:', error);
        showAlert('❌ Erreur lors de la création de la réservation', 'danger');
    } finally {
        showLoading(false);
    }
}

function validateReservation(client, telephone, index, quantite, montantVerse) {
    if (!client) {
        showAlert("Le nom du client est requis", "danger");
        return false;
    }
    
    if (!telephone) {
        showAlert("Le numéro de téléphone est requis", "danger");
        return false;
    }
    
    if (index === '') {
        showAlert("Veuillez sélectionner un article", "danger");
        return false;
    }
    
    const article = articles[index];
    
    if (isNaN(quantite) || quantite <= 0) {
        showAlert("La quantité doit être un nombre positif", "danger");
        return false;
    }
    
    if (quantite > article.quantite) {
        showAlert(`❌ Stock insuffisant. ${article.quantite} unité(s) disponible(s)`, "danger");
        return false;
    }

    if (isNaN(montantVerse) || montantVerse < 0) {
        showAlert("Le montant versé doit être un nombre positif", "danger");
        return false;
    }

    const total = quantite * article.prixVente;
    if (montantVerse > total) {
        showAlert("Le montant versé ne peut pas être supérieur au total", "danger");
        return false;
    }

    return true;
}

function resetReservationForm() {
    document.getElementById("clientReservation").value = "";
    document.getElementById("telephoneReservation").value = "";
    document.getElementById("quantiteReservation").value = "1";
    document.getElementById("montantVerseReservation").value = "0";
    remplirSelecteurReservation();
}

function afficherReservations() {
    const tbody = document.querySelector("#tableReservations tbody");
    const emptyState = document.getElementById('emptyReservations');
    
    if (!tbody) return;
    
    if (reservations.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";
    
    reservations.forEach((reservation) => {
        const canManage = hasPermission('manage_reservations');
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${reservation.client}</td>
            <td>${reservation.telephone}</td>
            <td>${reservation.article} (x${reservation.quantite})</td>
            <td>${formatCurrency(reservation.total)}</td>
            <td>${formatCurrency(reservation.montantVerse)}</td>
            <td>${formatCurrency(reservation.resteAPayer)}</td>
            <td>${reservation.dateReservation}</td>
            <td class="action-buttons">
                ${canManage ? `
                    <button class="btn btn-sm btn-success" onclick="finaliserReservationModal('${reservation.id}')">
                        <i class="fas fa-check"></i> Finaliser
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="annulerReservation('${reservation.id}')">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                ` : '<span class="text-muted">Actions non autorisées</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function finaliserReservationModal(reservationId) {
    const reservation = reservations.find(r => r.id === reservationId);
    if (!reservation) {
        showAlert('Réservation non trouvée', 'danger');
        return;
    }
    
    currentReservationId = reservationId;
    document.getElementById('reservationDetails').innerHTML = `
        <div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <p><strong>Client:</strong> ${reservation.client}</p>
            <p><strong>Téléphone:</strong> ${reservation.telephone}</p>
            <p><strong>Article:</strong> ${reservation.article} (x${reservation.quantite})</p>
            <p><strong>Prix unitaire:</strong> ${formatCurrency(reservation.prixUnitaire)}</p>
            <p><strong>Total:</strong> ${formatCurrency(reservation.total)}</p>
            <p><strong>Déjà versé:</strong> ${formatCurrency(reservation.montantVerse)}</p>
            <p><strong>Reste à payer:</strong> ${formatCurrency(reservation.resteAPayer)}</p>
        </div>
    `;
    
    document.getElementById('montantFinalReservation').value = reservation.total;
    document.getElementById('finalizeReservationModal').style.display = 'flex';
}

async function finaliserReservation() {
    if (!currentReservationId) return;
    
    const montantFinal = parseFloat(document.getElementById('montantFinalReservation').value);
    const reservation = reservations.find(r => r.id === currentReservationId);
    
    if (!reservation) {
        showAlert("Réservation non trouvée", "danger");
        return;
    }

    if (isNaN(montantFinal) || montantFinal < reservation.montantVerse) {
        showAlert("Le montant final doit être au moins égal au montant déjà versé", "danger");
        return;
    }

    try {
        showLoading(true, 'Finalisation de la réservation...');
        
        // Archiver la réservation
        const archiveData = {
            type: "réservation_finalisee",
            client: reservation.client,
            telephone: reservation.telephone,
            article: reservation.article,
            articleId: reservation.articleId,
            quantite: reservation.quantite,
            prixUnitaire: reservation.prixUnitaire,
            total: reservation.total,
            montantVerse: montantFinal,
            vendeur: userData.name,
            date: today,
            heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            user: currentUser.uid
        };

        await db.collection('archives').add(archiveData);
        
        // Supprimer la réservation
        await db.collection('reservations').doc(reservation.id).delete();
        
        await logOperation('reservation_finalisee', `Réservation finalisée: ${reservation.client}`, reservation);

        showAlert("✅ Réservation finalisée avec succès", 'success');
        document.getElementById('finalizeReservationModal').style.display = 'none';
        currentReservationId = null;
        await loadAllData();

    } catch (error) {
        console.error('Erreur finalisation:', error);
        showAlert('❌ Erreur lors de la finalisation de la réservation', 'danger');
    } finally {
        showLoading(false);
    }
}

async function annulerReservation(reservationId) {
    const reservation = reservations.find(r => r.id === reservationId);
    if (!reservation) {
        showAlert('Réservation non trouvée', 'danger');
        return;
    }
    
    if (!confirm(`Êtes-vous sûr de vouloir annuler la réservation de ${reservation.client} ? Cette action est irréversible.`)) return;

    try {
        showLoading(true, 'Annulation de la réservation...');

        // Remettre en stock
        if (reservation.articleId) {
            const articleRef = db.collection('articles').doc(reservation.articleId);
            await articleRef.update({
                quantite: firebase.firestore.FieldValue.increment(reservation.quantite)
            });
        }
        
        await db.collection('reservations').doc(reservationId).delete();
        await logOperation('reservation_annulee', `Réservation annulée: ${reservation.client}`, reservation);

        showAlert("✅ Réservation annulée avec succès", 'success');
        await loadAllData();
    } catch (error) {
        console.error('Erreur annulation:', error);
        showAlert('❌ Erreur lors de l\'annulation de la réservation', 'danger');
    } finally {
        showLoading(false);
    }
}

function annulerFinalisation() {
    document.getElementById('finalizeReservationModal').style.display = 'none';
    currentReservationId = null;
}

function filtrerReservations() {
    filterTable('searchReservation', 'tableReservations');
}

// ==================== DÉPENSES ====================
async function enregistrerDepense() {
    if (!checkAuth()) return;

    const description = document.getElementById("descriptionDepense").value.trim();
    const montant = parseFloat(document.getElementById("montantDepense").value);
    
    if (!description) {
        showAlert("La description de la dépense est requise", "danger");
        return;
    }
    
    if (isNaN(montant) || montant <= 0) {
        showAlert("Le montant doit être un nombre positif", "danger");
        return;
    }
    
    try {
        showLoading(true, 'Enregistrement de la dépense...');

        const depenseData = {
            description, 
            montant,
            date: today,
            mois: currentMonth,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            user: currentUser.uid,
            userName: userData.name
        };

        await db.collection('depenses').add(depenseData);
        await logOperation('depense', `Dépense: ${description}`, depenseData);

        showAlert("✅ Dépense enregistrée avec succès", 'success');
        document.getElementById("descriptionDepense").value = "";
        document.getElementById("montantDepense").value = "";
        await loadAllData();

    } catch (error) {
        console.error('Erreur dépense:', error);
        showAlert('❌ Erreur lors de l\'enregistrement de la dépense', 'danger');
    } finally {
        showLoading(false);
    }
}

// ==================== RAPPORTS ====================
function afficherRapport() {
    const tbody = document.querySelector("#tableRapport tbody");
    const emptyState = document.getElementById('emptyReport');
    
    if (!tbody) return;
    
    if (ventes.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        resetRapportTotals();
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";

    let totalGeneral = 0, totalPerçu = 0, totalAttente = 0;

    ventes.forEach(vente => {
        const statutPaiement = vente.resteAPayer > 0 ? 
            `<span class="payment-status payment-partial">Partiel</span>` : 
            `<span class="payment-status payment-paid">Complet</span>`;
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${vente.nom}</td>
            <td>${formatCurrency(vente.prixUnitaire)}</td>
            <td>${vente.quantite}</td>
            <td>${formatCurrency(vente.total)}</td>
            <td>${formatCurrency(vente.montantVerse)}</td>
            <td>${formatCurrency(vente.resteAPayer)}</td>
            <td>${vente.heure}</td>
            <td>${vente.vendeur}</td>
            <td>${statutPaiement}</td>
        `;
        
        totalGeneral += vente.total;
        totalPerçu += vente.montantVerse;
        totalAttente += vente.resteAPayer;
        
        tbody.appendChild(tr);
    });

    if (document.getElementById("totalJour")) {
        document.getElementById("totalJour").textContent = formatCurrency(totalGeneral);
    }
    if (document.getElementById("totalPerçu")) {
        document.getElementById("totalPerçu").textContent = formatCurrency(totalPerçu);
    }
    if (document.getElementById("totalAttente")) {
        document.getElementById("totalAttente").textContent = formatCurrency(totalAttente);
    }
    
    // Afficher le détail par article
    afficherDetailArticles();
}

function afficherDetailArticles() {
    const tbody = document.querySelector("#tableDetailArticles tbody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    // Regrouper les ventes par article
    const ventesParArticle = {};
    
    ventes.forEach(vente => {
        if (!ventesParArticle[vente.nom]) {
            ventesParArticle[vente.nom] = {
                quantite: 0,
                totalVentes: 0,
                coutAchat: 0
            };
        }
        
        ventesParArticle[vente.nom].quantite += vente.quantite;
        ventesParArticle[vente.nom].totalVentes += vente.total;
        
        // Trouver l'article correspondant pour le coût d'achat
        const article = articles.find(a => a.nom === vente.nom);
        if (article) {
            ventesParArticle[vente.nom].coutAchat += vente.quantite * article.prixAchat;
        }
    });
    
    let totalVentes = 0;
    let totalCout = 0;
    let beneficeNet = 0;
    
    Object.entries(ventesParArticle).forEach(([nom, data]) => {
        const benefice = data.totalVentes - data.coutAchat;
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${nom}</td>
            <td>${data.quantite}</td>
            <td>${formatCurrency(data.totalVentes)}</td>
            <td>${formatCurrency(data.coutAchat)}</td>
            <td class="${benefice >= 0 ? 'text-success' : 'text-danger'}">
                ${formatCurrency(benefice)}
            </td>
        `;
        
        totalVentes += data.totalVentes;
        totalCout += data.coutAchat;
        beneficeNet += benefice;
        
        tbody.appendChild(tr);
    });
    
    document.getElementById("totalVentes").textContent = formatCurrency(totalVentes);
    document.getElementById("totalCout").textContent = formatCurrency(totalCout);
    document.getElementById("beneficeNet").textContent = formatCurrency(beneficeNet);
}

function resetRapportTotals() {
    const elements = ["totalJour", "totalPerçu", "totalAttente"];
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = formatCurrency(0);
        }
    });
}

function afficherDepenses() {
    const tbody = document.querySelector("#tableDepenses tbody");
    const emptyState = document.getElementById('emptyExpenses');
    
    if (!tbody) return;
    
    if (depenses.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        if (document.getElementById('totalDepenses')) {
            document.getElementById('totalDepenses').textContent = formatCurrency(0);
        }
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";

    let total = 0;
    depenses.forEach(depense => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${depense.description}</td>
            <td>${formatCurrency(depense.montant)}</td>
            <td>${depense.date}</td>
        `;
        total += depense.montant;
        tbody.appendChild(tr);
    });

    if (document.getElementById("totalDepenses")) {
        document.getElementById("totalDepenses").textContent = formatCurrency(total);
    }
}

function afficherVentesRecentes() {
    displayRecentData(ventes.slice(0, 5), 'tableRecentSales', 'emptyRecentSales');
}

function afficherDepensesRecentes() {
    displayRecentData(depenses.slice(0, 5), 'tableRecentExpenses', 'emptyRecentExpenses');
}

function displayRecentData(data, tableId, emptyId) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    const emptyState = document.getElementById(emptyId);
    
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    if (data.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    data.forEach(item => {
        const tr = document.createElement("tr");
        if (tableId === 'tableRecentSales') {
            tr.innerHTML = `
                <td>${item.nom}</td>
                <td>${item.quantite}</td>
                <td>${formatCurrency(item.total)}</td>
                <td>${item.date}</td>
                <td>${item.vendeur}</td>
            `;
        } else {
            tr.innerHTML = `
                <td>${item.description}</td>
                <td>${formatCurrency(item.montant)}</td>
                <td>${item.date}</td>
            `;
        }
        tbody.appendChild(tr);
    });
}

// ==================== ARCHIVES ====================
function afficherArchives() {
    const tbody = document.querySelector("#tableArchives tbody");
    const emptyState = document.getElementById('emptyArchives');
    
    if (!tbody) return;
    
    if (archives.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";
    
    archives.forEach(archive => {
        const tr = document.createElement("tr");
        let content = '';
        
        if (archive.type === 'réservation_finalisee') {
            content = `
                <td>${archive.date}</td>
                <td>${archive.article}</td>
                <td>${archive.quantite}</td>
                <td>${formatCurrency(archive.prixUnitaire || 0)}</td>
                <td>${formatCurrency(archive.total || 0)}</td>
                <td>${archive.vendeur}</td>
                <td><span class="status-badge status-active">Réservation</span></td>
            `;
        } else {
            content = `
                <td>${archive.date}</td>
                <td>${archive.article}</td>
                <td>${archive.quantite}</td>
                <td>${formatCurrency(archive.prixUnitaire || 0)}</td>
                <td>${formatCurrency(archive.total || 0)}</td>
                <td>${archive.vendeur}</td>
                <td><span class="status-badge status-inactive">${archive.type || 'vente'}</span></td>
            `;
        }
        
        tr.innerHTML = content;
        tbody.appendChild(tr);
    });
}

function filtrerArchives() {
    filterTable('searchArchives', 'tableArchives');
}

function filtrerParDate() {
    const dateDebut = document.getElementById('dateDebut').value;
    const dateFin = document.getElementById('dateFin').value;
    
    if (!dateDebut || !dateFin) {
        showAlert('Veuillez sélectionner une période de dates', 'warning');
        return;
    }
    
    const debut = new Date(dateDebut);
    const fin = new Date(dateFin);
    fin.setHours(23, 59, 59, 999); // Fin de journée
    
    const archivesFiltrees = archives.filter(archive => {
        const archiveDate = archive.timestamp ? 
            new Date(archive.timestamp.toDate()) : 
            new Date(archive.date.split('/').reverse().join('-'));
        
        return archiveDate >= debut && archiveDate <= fin;
    });
    
    // Afficher les archives filtrées
    const tbody = document.querySelector("#tableArchives tbody");
    const emptyState = document.getElementById('emptyArchives');
    
    if (!tbody) return;
    
    if (archivesFiltrees.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    tbody.innerHTML = "";
    
    archivesFiltrees.forEach(archive => {
        const tr = document.createElement("tr");
        let content = '';
        
        if (archive.type === 'réservation_finalisee') {
            content = `
                <td>${archive.date}</td>
                <td>${archive.article}</td>
                <td>${archive.quantite}</td>
                <td>${formatCurrency(archive.prixUnitaire || 0)}</td>
                <td>${formatCurrency(archive.total || 0)}</td>
                <td>${archive.vendeur}</td>
                <td><span class="status-badge status-active">Réservation</span></td>
            `;
        } else {
            content = `
                <td>${archive.date}</td>
                <td>${archive.article}</td>
                <td>${archive.quantite}</td>
                <td>${formatCurrency(archive.prixUnitaire || 0)}</td>
                <td>${formatCurrency(archive.total || 0)}</td>
                <td>${archive.vendeur}</td>
                <td><span class="status-badge status-inactive">${archive.type || 'vente'}</span></td>
            `;
        }
        
        tr.innerHTML = content;
        tbody.appendChild(tr);
    });
}

// ==================== SYSTÈME D'ABONNEMENT ====================
async function loadUserSubscription() {
    if (!currentUser) return;
    
    try {
        const subscriptionSnapshot = await db.collection('subscriptions')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(1)
            .get();
        
        if (!subscriptionSnapshot.empty) {
            subscriptionData = subscriptionSnapshot.docs[0].data();
            subscriptionData.id = subscriptionSnapshot.docs[0].id;
            displayCurrentSubscription();
        } else {
            displayTrialSubscription();
        }
        
        await loadPaymentHistory();
    } catch (error) {
        console.error('Erreur chargement abonnement:', error);
        displayTrialSubscription();
    }
}

function displayCurrentSubscription() {
    const container = document.getElementById('currentSubscription');
    const now = new Date();
    const endDate = subscriptionData.endDate.toDate();
    const isActive = endDate > now;
    
    const statusClass = isActive ? 'status-active' : 'status-expired';
    const statusText = isActive ? 'Actif' : 'Expiré';
    const planName = SUBSCRIPTION_PLANS[subscriptionData.plan]?.name || 'Inconnu';
    
    container.innerHTML = `
        <div class="subscription-status ${statusClass}">
            <h3>Votre Abonnement ${planName}</h3>
            <p><strong>Statut:</strong> ${statusText}</p>
            <p><strong>Début:</strong> ${subscriptionData.startDate.toDate().toLocaleDateString('fr-FR')}</p>
            <p><strong>Fin:</strong> ${endDate.toLocaleDateString('fr-FR')}</p>
            ${isActive ? `
                <p><strong>Jours restants:</strong> ${Math.ceil((endDate - now) / (1000 * 60 * 60 * 24))}</p>
                <button class="btn btn-warning" onclick="renewSubscription()" style="margin-top: 15px;">
                    <i class="fas fa-sync"></i> Renouveler
                </button>
            ` : `
                <button class="btn btn-success" onclick="showTab('subscription')" style="margin-top: 15px;">
                    <i class="fas fa-crown"></i> Souscrire
                </button>
            `}
        </div>
    `;
}

function displayTrialSubscription() {
    const container = document.getElementById('currentSubscription');
    container.innerHTML = `
        <div class="subscription-status status-pending">
            <h3>Version d'Essai</h3>
            <p>Vous utilisez actuellement la version d'essai gratuite</p>
            <p><strong>Fonctionnalités limitées</strong></p>
            <button class="btn btn-success" onclick="showTab('subscription')" style="margin-top: 15px;">
                <i class="fas fa-crown"></i> Souscrire maintenant
            </button>
        </div>
    `;
}

async function loadPaymentHistory() {
    if (!currentUser) return;
    
    try {
        const paymentsSnapshot = await db.collection('payments')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get();
        
        const tbody = document.querySelector('#tablePaymentHistory tbody');
        const emptyState = document.getElementById('emptyPaymentHistory');
        
        if (paymentsSnapshot.empty) {
            if (emptyState) emptyState.style.display = 'block';
            tbody.innerHTML = '';
            return;
        }
        
        if (emptyState) emptyState.style.display = 'none';
        tbody.innerHTML = '';
        
        paymentsSnapshot.docs.forEach(doc => {
            const payment = doc.data();
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${payment.createdAt.toDate().toLocaleDateString('fr-FR')}</td>
                <td>${formatCurrency(payment.amount)}</td>
                <td>${payment.provider}</td>
                <td>
                    <span class="payment-status payment-${payment.status}">
                        ${getPaymentStatusText(payment.status)}
                    </span>
                </td>
                <td>${SUBSCRIPTION_PLANS[payment.plan]?.name || 'N/A'}</td>
            `;
            
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Erreur chargement historique paiements:', error);
    }
}

function selectPlan(planId) {
    if (!checkAuth()) return;
    
    currentPlan = planId;
    const plan = SUBSCRIPTION_PLANS[planId];
    
    // Pré-remplir le formulaire de paiement
    document.getElementById('paymentAmount').value = plan.price;
    document.getElementById('paymentType').value = 'subscription';
    
    // Afficher l'onglet paiement
    showTab('mobile-money');
    
    // Mettre à jour le résumé
    updatePaymentSummary();
    
    showAlert(`Plan ${plan.name} sélectionné. Veuillez procéder au paiement.`, 'info');
}

function renewSubscription() {
    if (subscriptionData) {
        currentPlan = subscriptionData.plan;
        showTab('mobile-money');
        updatePaymentSummary();
    }
}

// ==================== SYSTÈME DE PAIEMENT ====================
function updatePaymentSummary() {
    const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const phone = document.getElementById('phoneNumber').value;
    const provider = currentProvider;
    
    if (amount > 0 && phone) {
        const fees = Math.round(amount * (PROVIDER_FEES[provider] / 100));
        const total = amount + fees;
        
        document.getElementById('summaryProvider').textContent = getProviderName(provider);
        document.getElementById('summaryPhone').textContent = phone;
        document.getElementById('summaryAmount').textContent = formatCurrency(amount);
        document.getElementById('summaryFees').textContent = formatCurrency(fees);
        document.getElementById('summaryTotal').textContent = formatCurrency(total);
        
        document.getElementById('paymentSummary').style.display = 'block';
    } else {
        document.getElementById('paymentSummary').style.display = 'none';
    }
}

function getProviderName(provider) {
    const names = {
        'airtel': 'Airtel Money',
        'orange': 'Orange Money',
        'mtn': 'MTN Money'
    };
    return names[provider] || provider;
}

function getPaymentStatusText(status) {
    const statuses = {
        'pending': 'En attente',
        'processing': 'En traitement',
        'completed': 'Complété',
        'failed': 'Échoué',
        'cancelled': 'Annulé'
    };
    return statuses[status] || status;
}

async function initiatePayment() {
    if (!checkAuth()) return;
    
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const phone = document.getElementById('phoneNumber').value;
    const paymentType = document.getElementById('paymentType').value;
    const provider = currentProvider;
    
    if (!validatePaymentForm(amount, phone)) return;
    
    try {
        showLoading(true, `Initialisation du paiement ${getProviderName(provider)}...`);
        
        let paymentResult;
        
        // Traitement spécifique par opérateur
        switch(provider) {
            case 'airtel':
                paymentResult = await simulateAirtelMoneyPayment(amount, phone);
                break;
                
            case 'orange':
                paymentResult = await simulateMobileMoneyPayment(amount, phone, provider);
                break;
                
            case 'mtn':
                paymentResult = await simulateMobileMoneyPayment(amount, phone, provider);
                break;
                
            default:
                throw new Error('Opérateur non supporté');
        }
        
        if (paymentResult.success) {
            await recordPayment(paymentResult, paymentType);
            
            // Message de succès spécifique à Airtel
            if (provider === 'airtel') {
                showAlert('✅ Paiement Airtel Money effectué avec succès! Vous recevrez un SMS de confirmation.', 'success');
            } else {
                showAlert('✅ Paiement effectué avec succès!', 'success');
            }
            
            resetPaymentForm();
            
            // Mettre à jour l'abonnement si c'est un paiement d'abonnement
            if (paymentType === 'subscription' && currentPlan) {
                await activateSubscription();
            }
        } else {
            throw new Error(paymentResult.error || 'Échec du paiement');
        }
        
    } catch (error) {
        console.error('Erreur paiement:', error);
        
        // Messages d'erreur spécifiques Airtel
        if (currentProvider === 'airtel') {
            if (error.message.includes('solde')) {
                showAlert('❌ Solde Airtel Money insuffisant. Veuillez recharger votre compte.', 'danger');
            } else if (error.message.includes('numéro')) {
                showAlert('❌ Numéro Airtel Money invalide. Vérifiez le format.', 'danger');
            } else {
                showAlert(`❌ Erreur Airtel Money: ${error.message}`, 'danger');
            }
        } else {
            showAlert(`❌ ${error.message}`, 'danger');
        }
    } finally {
        showLoading(false);
    }
}

function validatePaymentForm(amount, phone) {
    if (!amount || amount < 100) {
        showAlert('Le montant minimum est de 100 FC', 'danger');
        return false;
    }
    
    if (!phone || phone.length < 9) {
        showAlert('Numéro de téléphone invalide', 'danger');
        return false;
    }
    
    return true;
}

// Simulation de paiement Airtel Money
async function simulateAirtelMoneyPayment(amount, phone) {
    return new Promise((resolve) => {
        setTimeout(() => {
            // Simulation avec un taux de succès élevé pour Airtel
            const success = Math.random() > 0.1; // 90% de succès
            
            if (success) {
                resolve({
                    success: true,
                    transactionId: 'AIRTEL_' + Date.now(),
                    amount: amount,
                    provider: 'airtel',
                    phone: phone,
                    status: 'TS', // Transaction Success
                    timestamp: new Date()
                });
            } else {
                resolve({
                    success: false,
                    error: 'Paiement refusé par Airtel Money. Vérifiez votre solde.'
                });
            }
        }, 2000); // Airtel est généralement plus rapide
    });
}

// Simulation de paiement mobile money générique
async function simulateMobileMoneyPayment(amount, phone, provider) {
    return new Promise((resolve) => {
        setTimeout(() => {
            // Simulation - dans la réalité, vous appelleriez une API
            const success = Math.random() > 0.2; // 80% de succès
            
            if (success) {
                resolve({
                    success: true,
                    transactionId: 'TX_' + provider.toUpperCase() + '_' + Date.now(),
                    amount: amount,
                    provider: provider,
                    phone: phone,
                    timestamp: new Date()
                });
            } else {
                resolve({
                    success: false,
                    error: 'Paiement refusé par le réseau mobile'
                });
            }
        }, 3000);
    });
}

async function recordPayment(paymentResult, paymentType) {
    const paymentData = {
        userId: currentUser.uid,
        userName: userData.name,
        amount: paymentResult.amount,
        provider: paymentResult.provider,
        phone: paymentResult.phone,
        transactionId: paymentResult.transactionId,
        type: paymentType,
        plan: currentPlan,
        status: 'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('payments').add(paymentData);
    await logOperation('paiement', `Paiement ${paymentType}`, paymentData);
}

async function activateSubscription() {
    if (!currentPlan) return;
    
    const plan = SUBSCRIPTION_PLANS[currentPlan];
    const startDate = new Date();
    const endDate = new Date();
    endDate.setDate(startDate.getDate() + plan.duration);
    
    const subscriptionData = {
        userId: currentUser.uid,
        userName: userData.name,
        plan: currentPlan,
        startDate: startDate,
        endDate: endDate,
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('subscriptions').add(subscriptionData);
    await logOperation('abonnement', `Abonnement ${plan.name} activé`, subscriptionData);
    
    // Recharger les données d'abonnement
    await loadUserSubscription();
}

function resetPaymentForm() {
    document.getElementById('phoneNumber').value = '';
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentSummary').style.display = 'none';
    currentPlan = null;
}

// ==================== FONCTIONS ADMIN ====================
async function manageUsers() {
    if (!checkPermission('manage_users', 'gérer les utilisateurs')) return;
    
    try {
        const usersSnapshot = await db.collection('users').get();
        const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        let userList = "👥 Gestion des utilisateurs:\n\n";
        users.forEach(user => {
            userList += `• ${user.name} (${user.email})\n`;
            userList += `  Rôle: ${user.role} | Connexions: ${user.loginCount || 0}\n`;
            userList += `  Créé: ${user.createdAt?.toDate?.().toLocaleDateString('fr-FR')}\n`;
            userList += "─".repeat(40) + "\n";
        });
        
        alert(userList);
    } catch (error) {
        console.error('Erreur gestion utilisateurs:', error);
        showAlert('❌ Erreur lors de la gestion des utilisateurs', 'danger');
    }
}

async function viewAuditLogs() {
    if (!checkPermission('view_audit_logs', 'consulter les logs')) return;
    
    try {
        const logsSnapshot = await db.collection('security_logs')
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();
            
        let logs = "📊 Logs de sécurité:\n\n";
        logsSnapshot.docs.forEach(doc => {
            const log = doc.data();
            logs += `• ${log.timestamp?.toDate?.().toLocaleString('fr-FR')}\n`;
            logs += `  ${log.type}: ${log.description}\n`;
            logs += `  ${log.userEmail}\n`;
            logs += "─".repeat(40) + "\n";
        });
        
        alert(logs);
    } catch (error) {
        console.error('Erreur consultation logs:', error);
        showAlert('❌ Erreur lors de la consultation des logs', 'danger');
    }
}

// ==================== FONCTIONS UTILITAIRES ====================
function checkAuth() {
    if (!currentUser) {
        showAlert("❌ Veuillez vous connecter pour accéder à cette fonctionnalité", "danger");
        showLogin();
        return false;
    }
    return true;
}

async function logSecurityEvent(type, description) {
    try {
        await db.collection('security_logs').add({
            type: type,
            description: description,
            user: currentUser ? currentUser.uid : 'anonymous',
            userEmail: currentUser ? currentUser.email : 'anonymous',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userAgent: navigator.userAgent,
            ip: 'localhost' // Dans une vraie app, vous récupéreriez l'IP réelle
        });
    } catch (error) {
        console.error('Erreur journalisation sécurité:', error);
    }
}

async function logOperation(type, description, details = {}) {
    try {
        await db.collection('operations').add({
            type: type,
            description: description,
            user: currentUser.uid,
            userName: userData.name,
            userRole: userRole,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            details: details
        });
    } catch (error) {
        console.error('Erreur journalisation opération:', error);
    }
}

async function uploadImage(imageData, path) {
    try {
        // Conversion de dataURL en blob
        const response = await fetch(imageData);
        const blob = await response.blob();
        
        // Création du FormData pour Cloudinary
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', 'cs_lacolombe');
        formData.append('folder', 'cs-lacolombe');
        
        // Upload vers Cloudinary
        const cloudinaryResponse = await fetch(
            `https://api.cloudinary.com/v1_1/diwn8sxtn/image/upload`,
            { 
                method: 'POST', 
                body: formData 
            }
        );
        
        if (!cloudinaryResponse.ok) {
            throw new Error(`HTTP error! status: ${cloudinaryResponse.status}`);
        }
        
        const data = await cloudinaryResponse.json();
        return data.secure_url;
        
    } catch (error) {
        console.error('Erreur upload image:', error);
        
        // Fallback: stocker dans Firebase Storage si Cloudinary échoue
        try {
            console.log('Fallback: utilisation de Firebase Storage');
            const timestamp = Date.now();
            const fileName = `article_${timestamp}.jpg`;
            const ref = storage.ref().child(`articles/${fileName}`);
            const response = await fetch(imageData);
            const blob = await response.blob();
            const snapshot = await ref.put(blob);
            return await snapshot.ref.getDownloadURL();
        } catch (fallbackError) {
            console.error('Erreur fallback:', fallbackError);
            return null;
        }
    }
}
function showTab(tabId) {
    if (!checkAuth()) return;
    
    // Cacher tous les onglets
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Désactiver tous les boutons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Afficher l'onglet sélectionné
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Activer le bouton correspondant
    const targetButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
    if (targetButton) {
        targetButton.classList.add('active');
    }
    
    // Mettre à jour les données spécifiques à l'onglet
    switch(tabId) {
        case 'stock': 
            afficherStock(); 
            break;
        case 'reports': 
            afficherRapport(); 
            afficherDepenses(); 
            break;
        case 'dashboard': 
            afficherVentesRecentes(); 
            afficherDepensesRecentes(); 
            break;
        case 'sales': 
            remplirSelecteurs(); 
            break;
        case 'reservations': 
            afficherReservations(); 
            remplirSelecteurs(); 
            break;
        case 'orders': 
            afficherCommandes(); 
            break;
        case 'archives': 
            afficherArchives(); 
            break;
        case 'subscription':
            loadUserSubscription();
            break;
        case 'mobile-money':
            updatePaymentSummary();
            break;
    }
}

function remplirSelecteurs() {
    remplirSelecteurVente();
    remplirSelecteurReservation();
}

function remplirSelecteurVente() {
    const select = document.getElementById("articleVente");
    if (!select) return;
    
    select.innerHTML = "<option value=''>Sélectionner un article</option>";
    
    articles.forEach((article, index) => {
        if (article.quantite > 0) {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = `${article.nom} (${article.quantite} dispo) - ${formatCurrency(article.prixVente)}`;
            option.setAttribute('data-prix', article.prixVente);
            select.appendChild(option);
        }
    });
}

function remplirSelecteurReservation() {
    const select = document.getElementById("articleReservation");
    if (!select) return;
    
    select.innerHTML = "<option value=''>Sélectionner un article</option>";
    
    articles.forEach((article, index) => {
        if (article.quantite > 0) {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = `${article.nom} (${article.quantite} dispo) - ${formatCurrency(article.prixVente)}`;
            option.setAttribute('data-prix', article.prixVente);
            select.appendChild(option);
        }
    });
}

function filterTable(searchId, tableId) {
    const searchInput = document.getElementById(searchId);
    const table = document.getElementById(tableId);
    
    if (!searchInput || !table) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const rows = table.querySelectorAll('tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Afficher/masquer l'état vide
    const emptyState = document.getElementById(`empty${tableId.replace('table', '')}`);
    if (emptyState) {
        emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
    }
}

function showAlert(message, type = 'success', duration = 5000) {
    const alertBox = document.getElementById('alertBox');
    if (!alertBox) return;
    
    const icons = { 
        success: '✅', 
        danger: '❌', 
        warning: '⚠️', 
        info: 'ℹ️' 
    };
    const icon = icons[type] || '💡';
    
    alertBox.innerHTML = `
        <div class="alert alert-${type} show">
            <span class="alert-icon">${icon}</span>
            ${message}
        </div>
    `;
    
    setTimeout(() => {
        alertBox.innerHTML = '';
    }, duration);
}

function showLoading(show, message = 'Chargement...') {
    let spinner = document.getElementById('loadingSpinner');
    
    if (show) {
        if (!spinner) {
            spinner = document.createElement('div');
            spinner.id = 'loadingSpinner';
            spinner.innerHTML = `
                <div class="loading-overlay">
                    <div class="spinner"></div>
                    <div class="loading-message">${message}</div>
                </div>
            `;
            document.body.appendChild(spinner);
        }
        spinner.style.display = 'flex';
    } else if (spinner) {
        spinner.style.display = 'none';
    }
}

function handleAuthError(error) {
    let message = 'Erreur d\'authentification';
    
    switch (error.code) {
        case 'auth/invalid-email': 
            message = 'Format d\'email invalide'; 
            break;
        case 'auth/user-disabled': 
            message = 'Compte désactivé'; 
            break;
        case 'auth/user-not-found': 
            message = 'Utilisateur non trouvé'; 
            break;
        case 'auth/wrong-password': 
            message = 'Mot de passe incorrect'; 
            break;
        case 'auth/email-already-in-use': 
            message = 'Email déjà utilisé'; 
            break;
        case 'auth/weak-password': 
            message = 'Mot de passe trop faible (min 6 caractères)'; 
            break;
        case 'auth/too-many-requests': 
            message = 'Trop de tentatives. Réessayez plus tard'; 
            break;
        case 'auth/network-request-failed':
            message = 'Erreur de connexion. Vérifiez votre internet';
            break;
        default: 
            message = error.message || 'Erreur inconnue';
    }
    
    showAlert(`❌ ${message}`, 'danger');
}

// ==================== EXPORT PDF ====================
function exporterPDF() {
    if (ventes.length === 0) {
        showAlert("Aucune vente à exporter aujourd'hui", "warning");
        return;
    }

    try {
        const doc = new jsPDF();
        
        // En-tête
        doc.setFontSize(20);
        doc.setTextColor(52, 152, 219);
        doc.text("TheoVêt - Rapport Journalier", 105, 20, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Date: ${today} | Généré par: ${userData.name}`, 105, 30, { align: "center" });
        
        // Données
        const tableData = ventes.map(vente => [
            vente.nom,
            formatCurrency(vente.prixUnitaire),
            vente.quantite.toString(),
            formatCurrency(vente.total),
            formatCurrency(vente.montantVerse),
            formatCurrency(vente.resteAPayer),
            vente.heure,
            vente.vendeur,
            vente.resteAPayer > 0 ? "Partiel" : "Complet"
        ]);
        
        // Tableau
        doc.autoTable({
            startY: 40,
            head: [['Article', 'Prix', 'Quantité', 'Total', 'Versé', 'Reste', 'Heure', 'Vendeur', 'Statut']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [52, 152, 219], 
                textColor: 255, 
                fontStyle: 'bold',
                fontSize: 9
            },
            styles: { 
                fontSize: 8,
                cellPadding: 3
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            }
        });
        
        // Totaux
        const totalGeneral = ventes.reduce((t, v) => t + v.total, 0);
        const totalPerçu = ventes.reduce((t, v) => t + v.montantVerse, 0);
        const totalAttente = ventes.reduce((t, v) => t + v.resteAPayer, 0);
        
        const finalY = doc.lastAutoTable.finalY + 15;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        
        doc.text("Total journalier:", 20, finalY);
        doc.text(formatCurrency(totalGeneral), 60, finalY);
        
        doc.text("Total perçu:", 20, finalY + 8);
        doc.text(formatCurrency(totalPerçu), 60, finalY + 8);
        
        doc.text("Total en attente:", 20, finalY + 16);
        doc.text(formatCurrency(totalAttente), 60, finalY + 16);
        
        // Pied de page
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Généré le ${new Date().toLocaleString('fr-FR')}`, 105, 280, { align: "center" });
        
        doc.save(`theovet_rapport_${today.replace(/\//g, '-')}.pdf`);
        showAlert("✅ Rapport PDF exporté avec succès", 'success');
    } catch (error) {
        console.error('Erreur export PDF:', error);
        showAlert('❌ Erreur lors de l\'export PDF', 'danger');
    }
}

function exporterArchivesPDF() {
    if (archives.length === 0) {
        showAlert("Aucune donnée d'archive à exporter", "warning");
        return;
    }

    try {
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.setTextColor(52, 152, 219);
        doc.text("TheoVêt - Archives", 105, 20, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Période: 30 derniers jours | Généré par: ${userData.name}`, 105, 30, { align: "center" });
        
        const tableData = archives.map(archive => [
            archive.date,
            archive.article,
            archive.quantite.toString(),
            formatCurrency(archive.prixUnitaire || 0),
            formatCurrency(archive.total || 0),
            archive.vendeur,
            archive.type === 'réservation_finalisee' ? 'Réservation' : (archive.type || 'Vente')
        ]);
        
        doc.autoTable({
            startY: 40,
            head: [['Date', 'Article', 'Quantité', 'Prix', 'Total', 'Vendeur', 'Type']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [52, 152, 219], 
                textColor: 255, 
                fontStyle: 'bold',
                fontSize: 9
            },
            styles: { 
                fontSize: 8,
                cellPadding: 3
            }
        });
        
        doc.save(`theovet_archives_${today.replace(/\//g, '-')}.pdf`);
        showAlert("✅ Archives exportées en PDF avec succès", 'success');
    } catch (error) {
        console.error('Erreur export archives PDF:', error);
        showAlert('❌ Erreur lors de l\'export des archives', 'danger');
    }
}

function genererRapportComplet() {
    if (ventes.length === 0 && depenses.length === 0) {
        showAlert("Aucune donnée à inclure dans le rapport complet", "warning");
        return;
    }

    try {
        const doc = new jsPDF();
        
        // Page 1 - Ventes
        doc.setFontSize(20);
        doc.setTextColor(52, 152, 219);
        doc.text("TheoVêt - Rapport Complet", 105, 20, { align: "center" });
        
        doc.setFontSize(16);
        doc.text("Ventes du Jour", 20, 40);
        
        if (ventes.length > 0) {
            const tableDataVentes = ventes.map(vente => [
                vente.nom,
                formatCurrency(vente.prixUnitaire),
                vente.quantite.toString(),
                formatCurrency(vente.total),
                formatCurrency(vente.montantVerse),
                formatCurrency(vente.resteAPayer),
                vente.vendeur
            ]);
            
            doc.autoTable({
                startY: 50,
                head: [['Article', 'Prix', 'Quantité', 'Total', 'Versé', 'Reste', 'Vendeur']],
                body: tableDataVentes,
                theme: 'grid'
            });
        } else {
            doc.text("Aucune vente aujourd'hui", 20, 50);
        }
        
        // Page 2 - Dépenses
        doc.addPage();
        doc.setFontSize(16);
        doc.text("Dépenses du Mois", 20, 20);
        
        if (depenses.length > 0) {
            const tableDataDepenses = depenses.map(depense => [
                depense.description,
                formatCurrency(depense.montant),
                depense.date
            ]);
            
            doc.autoTable({
                startY: 30,
                head: [['Description', 'Montant', 'Date']],
                body: tableDataDepenses,
                theme: 'grid'
            });
        } else {
            doc.text("Aucune dépense ce mois-ci", 20, 30);
        }
        
        doc.save(`theovet_rapport_complet_${today.replace(/\//g, '-')}.pdf`);
        showAlert("✅ Rapport complet exporté avec succès", 'success');
    } catch (error) {
        console.error('Erreur rapport complet:', error);
        showAlert('❌ Erreur lors de la génération du rapport complet', 'danger');
    }
}

// ==================== SÉCURITÉ ====================
function reinitialiserApplication() {
    if (!checkPermission('reset_app', 'réinitialiser l\'application')) return;
    
    document.getElementById('resetModal').style.display = 'flex';
}

function verifierMatriculeReinitialisation() {
    const matricule = document.getElementById("resetMatricule").value;
    const expected = MATRICULES[userRole];
    
    if (matricule === expected) {
        confirmerReinitialisation();
    } else {
        showAlert("❌ Matricule incorrect", "danger");
        document.getElementById("resetMatricule").value = "";
    }
}

async function confirmerReinitialisation() {
    try {
        showLoading(true, 'Réinitialisation en cours...');
        
        // Sauvegarde avant suppression
        const backupData = {
            articles: articles,
            ventes: ventes,
            depenses: depenses,
            reservations: reservations,
            orders: orders,
            archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
            archivedBy: currentUser.uid,
            archivedByName: userData.name,
            reason: 'reinitialisation_manuelle'
        };

        await db.collection('backups').add(backupData);

        // Suppression en lot
        const batch = db.batch();
        
        // Supprimer tous les articles
        articles.forEach(article => {
            const ref = db.collection('articles').doc(article.id);
            batch.delete(ref);
        });
        
        // Supprimer toutes les ventes
        ventes.forEach(vente => {
            const ref = db.collection('ventes').doc(vente.id);
            batch.delete(ref);
        });
        
        // Supprimer toutes les réservations
        reservations.forEach(reservation => {
            const ref = db.collection('reservations').doc(reservation.id);
            batch.delete(ref);
        });
        
        // Supprimer toutes les commandes
        orders.forEach(order => {
            const ref = db.collection('orders').doc(order.id);
            batch.delete(ref);
        });
        
        // Supprimer toutes les dépenses
        depenses.forEach(depense => {
            const ref = db.collection('depenses').doc(depense.id);
            batch.delete(ref);
        });
        
        await batch.commit();
        await logOperation('reinitialisation', 'Application réinitialisée', backupData);
        
        showAlert("✅ Application réinitialisée avec succès", 'success');
        await loadAllData();

    } catch (error) {
        console.error('Erreur réinitialisation:', error);
        showAlert('❌ Erreur lors de la réinitialisation', 'danger');
    } finally {
        showLoading(false);
        document.getElementById('resetModal').style.display = 'none';
        document.getElementById("resetMatricule").value = "";
    }
}

function annulerReinitialisation() {
    document.getElementById('resetModal').style.display = 'none';
    document.getElementById("resetMatricule").value = "";
}

// ==================== FONCTIONS GLOBALES ====================
// Exposer les fonctions globales
window.login = login;
window.register = register;
window.logout = logout;
window.showLogin = showLogin;
window.showRegisterAccess = showRegisterAccess;
window.verifyRegisterAccess = verifyRegisterAccess;
window.cancelRegisterAccess = cancelRegisterAccess;
window.showForgotPassword = showForgotPassword;
window.showTab = showTab;
window.ajouterArticle = ajouterArticle;
window.ajouterAuPanier = ajouterAuPanier;
window.retirerDuPanier = retirerDuPanier;
window.validerPaiement = validerPaiement;
window.creerReservation = creerReservation;
window.creerCommande = creerCommande;
window.manageOrder = manageOrder;
window.updateOrder = updateOrder;
window.enregistrerDepense = enregistrerDepense;
window.filtrerStock = filtrerStock;
window.filtrerReservations = filtrerReservations;
window.filtrerCommandes = filtrerCommandes;
window.filtrerArchives = filtrerArchives;
window.filtrerParDate = filtrerParDate;
window.finaliserReservationModal = finaliserReservationModal;
window.finaliserReservation = finaliserReservation;
window.annulerReservation = annulerReservation;
window.annulerFinalisation = annulerFinalisation;
window.supprimerArticle = supprimerArticle;
window.modifierPrix = modifierPrix;
window.reinitialiserApplication = reinitialiserApplication;
window.verifierMatriculeReinitialisation = verifierMatriculeReinitialisation;
window.annulerReinitialisation = annulerReinitialisation;
window.exporterPDF = exporterPDF;
window.exporterArchivesPDF = exporterArchivesPDF;
window.genererRapportComplet = genererRapportComplet;
window.manageUsers = manageUsers;
window.viewAuditLogs = viewAuditLogs;
window.removeImage = removeImage;
window.imprimerFacture = imprimerFacture;
window.telechargerFacture = telechargerFacture;
window.selectPlan = selectPlan;
window.initiatePayment = initiatePayment;
window.renewSubscription = renewSubscription;

console.log('✅ TheoVêt JavaScript chargé avec succès');
// Gestionnaire PWA - Installation et mises à jour
class PWAHandler {
  constructor() {
    this.deferredPrompt = null;
    this.updateAvailable = false;
    this.registration = null;
    this.init();
  }

  async init() {
    // Vérifier si le service worker est supporté
    if ('serviceWorker' in navigator) {
      try {
        // Enregistrer le service worker
        this.registration = await navigator.serviceWorker.register('sw.js');
        console.log('✅ Service Worker enregistré avec succès');

        // Écouter les mises à jour
        this.setupUpdateListener();
        
        // Vérifier la version actuelle
        await this.checkVersion();
      } catch (error) {
        console.error('❌ Erreur enregistrement Service Worker:', error);
      }
    }

    // Gestion de l'installation
    this.setupInstallPrompt();
  }

  setupInstallPrompt() {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      this.showInstallButton();
    });

    window.addEventListener('appinstalled', () => {
      console.log('✅ PWA installée avec succès');
      this.deferredPrompt = null;
      this.hideInstallButton();
      this.showAlert('✅ Application installée avec succès!', 'success');
    });
  }

  setupUpdateListener() {
    if (this.registration) {
      this.registration.addEventListener('updatefound', () => {
        const newWorker = this.registration.installing;
        
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Nouvelle version disponible
            this.updateAvailable = true;
            this.showUpdateNotification();
          }
        });
      });
    }

    // Vérifier les mises à jour périodiquement
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      console.log('🔄 Contrôleur du Service Worker changé - rechargement');
      window.location.reload();
    });
  }

  showInstallButton() {
    // Créer ou afficher le bouton d'installation
    let installBtn = document.getElementById('pwa-install-btn');
    
    if (!installBtn) {
      installBtn = document.createElement('button');
      installBtn.id = 'pwa-install-btn';
      installBtn.innerHTML = '<i class="fas fa-download"></i> Installer l\'app';
      installBtn.className = 'btn btn-success';
      installBtn.style.position = 'fixed';
      installBtn.style.bottom = '20px';
      installBtn.style.right = '20px';
      installBtn.style.zIndex = '10000';
      installBtn.onclick = () => this.installApp();
      
      document.body.appendChild(installBtn);
    }
    
    installBtn.style.display = 'block';
  }

  hideInstallButton() {
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
      installBtn.style.display = 'none';
    }
  }

  async installApp() {
    if (this.deferredPrompt) {
      this.deferredPrompt.prompt();
      const { outcome } = await this.deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('✅ Utilisateur a accepté l\'installation');
      } else {
        console.log('❌ Utilisateur a refusé l\'installation');
      }
      
      this.deferredPrompt = null;
      this.hideInstallButton();
    }
  }

  showUpdateNotification() {
    // Créer la notification de mise à jour
    const updateNotification = document.createElement('div');
    updateNotification.id = 'pwa-update-notification';
    updateNotification.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--warning);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.5s ease;
      ">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <i class="fas fa-sync-alt" style="font-size: 1.2rem;"></i>
          <strong>Mise à jour disponible</strong>
        </div>
        <p style="margin: 0 0 10px 0; font-size: 0.9rem;">
          Une nouvelle version de TheoVêt est disponible.
        </p>
        <div style="display: flex; gap: 10px;">
          <button onclick="pwaHandler.updateApp()" class="btn btn-sm btn-success">
            <i class="fas fa-download"></i> Télécharger
          </button>
          <button onclick="pwaHandler.hideUpdateNotification()" class="btn btn-sm btn-light">
            Plus tard
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(updateNotification);
  }

  hideUpdateNotification() {
    const notification = document.getElementById('pwa-update-notification');
    if (notification) {
      notification.remove();
    }
  }

  async updateApp() {
    if (this.registration && this.registration.waiting) {
      // Envoyer un message au service worker pour sauter l'attente
      this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      
      this.showAlert('🔄 Mise à jour en cours...', 'info');
      this.hideUpdateNotification();
      
      // Recharger la page après un court délai
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }
  }

  async checkVersion() {
    if (this.registration && this.registration.active) {
      this.registration.active.postMessage({ type: 'GET_VERSION' });
    }
  }

  showAlert(message, type = 'info') {
    // Utiliser votre système d'alerte existant
    if (typeof showAlert === 'function') {
      showAlert(message, type);
    } else {
      console.log(`${type.toUpperCase()}: ${message}`);
    }
  }

  // Vérifier la connexion
  checkConnection() {
    if (!navigator.onLine) {
      this.showAlert('🌐 Mode hors ligne activé', 'warning');
    }

    window.addEventListener('online', () => {
      this.showAlert('✅ Connexion rétablie', 'success');
    });

    window.addEventListener('offline', () => {
      this.showAlert('⚠️ Mode hors ligne', 'warning');
    });
  }
}

// Initialiser le gestionnaire PWA
let pwaHandler;

document.addEventListener('DOMContentLoaded', () => {
  pwaHandler = new PWAHandler();
  pwaHandler.checkConnection();
});

// ==================== STATISTIQUES GLOBALES ====================

function toggleStatsFilters() {
    const statsType = document.getElementById('statsType').value;
    const categoryFilter = document.getElementById('statsCategory');
    
    // Afficher/masquer le filtre de catégorie selon le type
    if (statsType === 'stock') {
        categoryFilter.style.display = 'block';
    } else {
        categoryFilter.style.display = 'block';
    }
}

async function genererRapportParPeriode() {
    const startDate = document.getElementById('statsStartDate').value;
    const endDate = document.getElementById('statsEndDate').value;
    const statsType = document.getElementById('statsType').value;
    const category = document.getElementById('statsCategory').value;
    
    if (!startDate || !endDate) {
        showAlert('Veuillez sélectionner une période de dates', 'warning');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);
    
    if (start > end) {
        showAlert('La date de début doit être antérieure à la date de fin', 'danger');
        return;
    }
    
    // Limiter à 90 jours maximum
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 90) {
        showAlert('La période ne peut pas dépasser 90 jours', 'warning');
        return;
    }
    
    try {
        showLoading(true, 'Génération du rapport...');
        
        let data;
        
        if (statsType === 'sales') {
            data = await genererRapportVentes(start, end, category);
        } else if (statsType === 'stock') {
            data = await genererRapportStock(start, end, category);
        } else if (statsType === 'revenue') {
            data = await genererAnalyseRevenus(start, end, category);
        }
        
        if (!data || data.length === 0) {
            showAlert('Aucune donnée trouvée pour cette période', 'info');
            document.getElementById('emptyStats').style.display = 'block';
            document.getElementById('statsTableContainer').style.display = 'none';
            document.getElementById('advancedStats').style.display = 'none';
            document.getElementById('statsExportButtons').style.display = 'none';
            document.getElementById('statsSummary').style.display = 'none';
            return;
        }
        
        currentStatsData = data;
        statsPeriod = { start: startDate, end: endDate, type: statsType, category: category };
        
        // Afficher les résultats
        afficherStatsTable(data, statsType);
        afficherStatsSummary(data, statsType, startDate, endDate);
        genererGraphique(data, statsType);
        afficherStatsAvancees(data, statsType);
        
        // Afficher les éléments
        document.getElementById('emptyStats').style.display = 'none';
        document.getElementById('statsTableContainer').style.display = 'block';
        document.getElementById('advancedStats').style.display = 'block';
        document.getElementById('statsExportButtons').style.display = 'flex';
        document.getElementById('statsSummary').style.display = 'block';
        
        showAlert(`✅ Rapport généré avec succès (${data.length} entrées)`, 'success');
        
    } catch (error) {
        console.error('Erreur génération rapport:', error);
        showAlert('❌ Erreur lors de la génération du rapport', 'danger');
    } finally {
        showLoading(false);
    }
}

async function genererRapportVentes(startDate, endDate, category = '') {
    try {
        // Charger les archives pour la période
        const archivesSnapshot = await db.collection('archives')
            .where('timestamp', '>=', startDate)
            .where('timestamp', '<=', endDate)
            .orderBy('timestamp', 'asc')
            .get();
        
        // Charger TOUS les articles pour les infos complètes
        const articlesSnapshot = await db.collection('articles').get();
        
        // Créer une map des articles par NOM
        const articlesMap = {};
        articlesSnapshot.docs.forEach(doc => {
            const data = doc.data();
            // Stocker par nom d'article (en minuscules pour éviter les problèmes de casse)
            const nomNormalise = data.nom.toLowerCase().trim();
            articlesMap[nomNormalise] = {
                id: doc.id,
                nom: data.nom, // Le nom original
                type: data.type || 'Non classé',
                prixAchat: data.prixAchat || 0,
                image: data.image || null,
                description: data.description || ''
            };
        });
        
        const ventes = [];
        
        archivesSnapshot.docs.forEach(doc => {
            const data = doc.data();
            
            // DEBUG: Afficher les données brutes pour comprendre la structure
            console.log('Données archive:', {
                id: doc.id,
                article: data.article,
                nom: data.nom, // Vérifier si c'est 'article' ou 'nom'
                type: data.type
            });
            
            // Utiliser 'article' ou 'nom' selon la structure de vos données
            const nomArticle = data.article || data.nom || 'Article inconnu';
            const nomNormalise = nomArticle.toLowerCase().trim();
            
            // Obtenir les infos de l'article
            const articleInfo = articlesMap[nomNormalise] || {
                id: null,
                nom: nomArticle,
                type: 'Non classé',
                prixAchat: 0,
                image: null,
                description: ''
            };
            
            // Filtrer par type si spécifié
            if (category && articleInfo.type !== category && category !== '') {
                return; // Ignorer cet article si le type ne correspond pas
            }
            
            // S'assurer que c'est une vente (pas une réservation)
            if (data.type && data.type === 'réservation_finalisee') {
                // C'est une réservation, pas une vente directe
                // Vous pouvez décider de l'inclure ou non
                // Pour l'instant, nous l'incluons mais avec un type spécial
                articleInfo.type = 'Réservation';
            }
            
            // Calculer les statistiques
            const quantite = parseInt(data.quantite) || 0;
            const prixUnitaire = parseFloat(data.prixUnitaire) || 0;
            const total = parseFloat(data.total) || 0;
            const montantVerse = parseFloat(data.montantVerse) || 0;
            
            // Calcul du coût d'achat
            const coutAchat = (articleInfo.prixAchat || 0) * quantite;
            const benefice = total - coutAchat;
            const marge = coutAchat > 0 ? (benefice / coutAchat * 100) : 0;
            
            // Formater la date
            let dateVente = data.date;
            if (!dateVente && data.timestamp) {
                // Si pas de date, utiliser le timestamp
                const timestamp = data.timestamp.toDate ? 
                    data.timestamp.toDate() : 
                    new Date(data.timestamp);
                dateVente = timestamp.toLocaleDateString('fr-FR');
            }
            
            ventes.push({
                id: doc.id,
                date: dateVente || today,
                article: articleInfo.nom, // Utiliser le nom de l'articleInfo
                articleId: articleInfo.id,
                type: articleInfo.type,
                image: articleInfo.image,
                description: articleInfo.description,
                quantite: quantite,
                prixUnitaire: prixUnitaire,
                total: total,
                montantVerse: montantVerse,
                resteAPayer: total - montantVerse,
                coutAchat: coutAchat,
                benefice: benefice,
                marge: marge,
                vendeur: data.vendeur || data.userName || userData?.name || 'Inconnu',
                heure: data.heure || '',
                timestamp: data.timestamp
            });
        });
        
        console.log(`📊 ${ventes.length} ventes chargées pour la période`);
        console.log('Exemple de vente:', ventes.length > 0 ? ventes[0] : 'Aucune');
        
        return ventes;
        
    } catch (error) {
        console.error('Erreur chargement ventes:', error);
        
        // Fallback: charger toutes les archives et filtrer côté client
        try {
            console.log('Tentative de méthode alternative...');
            const allArchives = await db.collection('archives')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();
            
            const ventesFallback = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            // Charger les articles pour le fallback
            const articlesSnapshot = await db.collection('articles').get();
            const articlesMapFallback = {};
            articlesSnapshot.docs.forEach(doc => {
                const data = doc.data();
                articlesMapFallback[data.nom?.toLowerCase()] = {
                    id: doc.id,
                    nom: data.nom,
                    type: data.type,
                    image: data.image,
                    prixAchat: data.prixAchat
                };
            });
            
            allArchives.docs.forEach(doc => {
                const data = doc.data();
                
                // Vérifier la date
                const venteDate = data.timestamp?.toDate ? 
                    data.timestamp.toDate() : 
                    new Date(data.timestamp || data.date);
                
                if (venteDate >= start && venteDate <= end) {
                    const nomArticle = data.article || data.nom || 'Article inconnu';
                    const articleInfo = articlesMapFallback[nomArticle?.toLowerCase()] || {
                        nom: nomArticle,
                        type: 'Non classé',
                        image: null,
                        prixAchat: 0
                    };
                    
                    ventesFallback.push({
                        id: doc.id,
                        date: data.date || venteDate.toLocaleDateString('fr-FR'),
                        article: articleInfo.nom,
                        type: articleInfo.type,
                        image: articleInfo.image,
                        quantite: data.quantite || 0,
                        prixUnitaire: data.prixUnitaire || 0,
                        total: data.total || 0,
                        vendeur: data.vendeur || 'Inconnu'
                    });
                }
            });
            
            console.log(`📊 ${ventesFallback.length} ventes chargées (méthode fallback)`);
            return ventesFallback;
            
        } catch (fallbackError) {
            console.error('Erreur méthode fallback:', fallbackError);
            return [];
        }
    }
}

// Fonction utilitaire pour debuguer la structure des données
async function debugDataStructure() {
    console.log('🔍 DEBUG: Structure des données');
    
    try {
        // Vérifier les archives
        const archiveSample = await db.collection('archives')
            .limit(3)
            .get();
        
        console.log('📁 Exemples d\'archives:');
        archiveSample.docs.forEach((doc, index) => {
            const data = doc.data();
            console.log(`Archive ${index + 1}:`, {
                id: doc.id,
                article: data.article,
                nom: data.nom,
                type: data.type,
                quantite: data.quantite,
                total: data.total,
                vendeur: data.vendeur,
                date: data.date
            });
        });
        
        // Vérifier les articles
        const articleSample = await db.collection('articles')
            .limit(3)
            .get();
        
        console.log('👕 Exemples d\'articles:');
        articleSample.docs.forEach((doc, index) => {
            const data = doc.data();
            console.log(`Article ${index + 1}:`, {
                id: doc.id,
                nom: data.nom,
                type: data.type,
                prixAchat: data.prixAchat,
                prixVente: data.prixVente,
                image: data.image ? 'Oui' : 'Non'
            });
        });
        
    } catch (error) {
        console.error('Erreur debug:', error);
    }
}

// Appelez cette fonction dans la console du navigateur pour voir vos données
// debugDataStructure();

async function genererRapportStock(startDate, endDate, category = '') {
    try {
        // Pour le stock, nous utilisons les données actuelles filtrées par catégorie
        let filteredArticles = [...articles];
        
        if (category) {
            filteredArticles = filteredArticles.filter(article => article.type === category);
        }
        
        // Calculer les statistiques de stock AVEC IMAGES
        const stats = filteredArticles.map(article => {
            const valeur = article.prixVente * article.quantite;
            const investissement = article.prixAchat * article.quantite;
            const beneficePotentiel = valeur - investissement;
            const marge = investissement > 0 ? (beneficePotentiel / investissement * 100) : 0;
            
            return {
                article: article.nom,
                articleId: article.id,
                type: article.type,
                image: article.image,
                description: article.description,
                prixAchat: article.prixAchat,
                prixVente: article.prixVente,
                quantite: article.quantite,
                valeur: valeur,
                investissement: investissement,
                beneficePotentiel: beneficePotentiel,
                marge: marge,
                statut: getStockStatus(article.quantite),
                derniereMaj: article.lastUpdated ? 
                    article.lastUpdated.toDate().toLocaleDateString('fr-FR') : 'N/A'
            };
        });
        
        return stats;
        
    } catch (error) {
        console.error('Erreur génération rapport stock:', error);
        throw error;
    }
}


async function genererAnalyseRevenus(startDate, endDate, category = '') {
    try {
        const ventes = await genererRapportVentes(startDate, endDate, category);
        
        // Grouper par jour pour l'analyse des revenus
        const revenusParJour = {};
        const ventesParArticle = {};
        
        ventes.forEach(vente => {
            // Par jour
            const jour = vente.date;
            if (!revenusParJour[jour]) {
                revenusParJour[jour] = {
                    ventes: 0,
                    revenus: 0,
                    cout: 0,
                    benefice: 0,
                    transactions: 0
                };
            }
            revenusParJour[jour].ventes += vente.quantite;
            revenusParJour[jour].revenus += vente.total;
            revenusParJour[jour].cout += vente.coutAchat;
            revenusParJour[jour].benefice += vente.benefice;
            revenusParJour[jour].transactions += 1;
            
            // Par article
            if (!ventesParArticle[vente.article]) {
                ventesParArticle[vente.article] = {
                    quantite: 0,
                    revenus: 0,
                    cout: 0,
                    benefice: 0
                };
            }
            ventesParArticle[vente.article].quantite += vente.quantite;
            ventesParArticle[vente.article].revenus += vente.total;
            ventesParArticle[vente.article].cout += vente.coutAchat;
            ventesParArticle[vente.article].benefice += vente.benefice;
        });
        
        // Préparer les données pour l'affichage
        const analyse = {
            quotidienne: Object.entries(revenusParJour).map(([jour, data]) => ({
                date: jour,
                ventes: data.ventes,
                revenus: data.revenus,
                cout: data.cout,
                benefice: data.benefice,
                transactions: data.transactions,
                panierMoyen: data.transactions > 0 ? data.revenus / data.transactions : 0,
                marge: data.cout > 0 ? (data.benefice / data.cout * 100) : 0
            })),
            parArticle: Object.entries(ventesParArticle).map(([article, data]) => ({
                article: article,
                quantite: data.quantite,
                revenus: data.revenus,
                cout: data.cout,
                benefice: data.benefice,
                marge: data.cout > 0 ? (data.benefice / data.cout * 100) : 0,
                partMarche: ventes.length > 0 ? (data.revenus / ventes.reduce((sum, v) => sum + v.total, 0) * 100) : 0
            }))
        };
        
        return analyse;
        
    } catch (error) {
        console.error('Erreur analyse revenus:', error);
        throw error;
    }
}

function afficherStatsTable(data, type) {
    const headers = document.getElementById('statsTableHeaders');
    const body = document.getElementById('statsTableBody');
    
    // Vider les tables existantes
    headers.innerHTML = '';
    body.innerHTML = '';
    
    if (type === 'sales') {
        // En-têtes pour les ventes AVEC IMAGES
        headers.innerHTML = `
            <th style="width: 80px;">Image</th>
            <th>Article</th>
            <th>Date</th>
            <th>Type</th>
            <th>Quantité</th>
            <th>Prix unitaire</th>
            <th>Total</th>
            <th>Coût</th>
            <th>Bénéfice</th>
            <th>Marge %</th>
            <th>Vendeur</th>
        `;
        
        // Corps pour les ventes AVEC IMAGES
        body.innerHTML = data.map(item => {
            const imageHTML = item.image ? 
                `<img src="${item.image}" alt="${item.article}" class="article-image-small" 
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark);"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNlY2YwZjEiLz48cGF0aCBkPSJNMzAgMzVMMjAgMjVIMzBMMzUgMzBINDBMNDUgMjVINTBMMzUgNDBaIiBmaWxsPSIjOTVhNWE2Ii8+PHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5NWE1YTYiPjx0c3BhbiBkeT0iNCI+Tm8gaW1hZ2U8L3RzcGFuPjwvdGV4dD48L3N2Zz4='">` :
                `<div class="article-image-placeholder" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--light); border-radius: 4px; border: 1px solid var(--light-dark);">
                    <i class="fas fa-tshirt" style="font-size: 24px; color: var(--gray);"></i>
                </div>`;
            
            return `
                <tr>
                    <td style="padding: 5px; text-align: center;">${imageHTML}</td>
                    <td>
                        <div style="font-weight: 600; margin-bottom: 5px;">${item.article}</div>
                        ${item.description ? `<div style="font-size: 0.8rem; color: var(--gray);">${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</div>` : ''}
                    </td>
                    <td>${item.date}<br><small style="color: var(--gray);">${item.heure || ''}</small></td>
                    <td><span class="status-badge">${item.type}</span></td>
                    <td style="text-align: center; font-weight: bold;">${item.quantite}</td>
                    <td style="text-align: right;">${formatCurrency(item.prixUnitaire)}</td>
                    <td style="text-align: right; font-weight: bold;">${formatCurrency(item.total)}</td>
                    <td style="text-align: right;">${formatCurrency(item.coutAchat)}</td>
                    <td style="text-align: right; font-weight: bold; color: ${item.benefice >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${formatCurrency(item.benefice)}
                    </td>
                    <td style="text-align: center;">
                        <span class="${item.marge >= 0 ? 'text-success' : 'text-danger'}">
                            ${item.marge.toFixed(2)}%
                        </span>
                    </td>
                    <td>${item.vendeur}</td>
                </tr>
            `;
        }).join('');
        
    } else if (type === 'stock') {
        // En-têtes pour le stock AVEC IMAGES
        headers.innerHTML = `
            <th style="width: 80px;">Image</th>
            <th>Article</th>
            <th>Type</th>
            <th>Quantité</th>
            <th>Prix Achat</th>
            <th>Prix Vente</th>
            <th>Valeur</th>
            <th>Investissement</th>
            <th>Bénéfice Potentiel</th>
            <th>Marge %</th>
            <th>Statut</th>
        `;
        
        // Corps pour le stock AVEC IMAGES
        body.innerHTML = data.map(item => {
            const imageHTML = item.image ? 
                `<img src="${item.image}" alt="${item.article}" class="article-image-small" 
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark);"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNlY2YwZjEiLz48cGF0aCBkPSJNMzAgMzVMMjAgMjVIMzBMMzUgMzBINDBMNDUgMjVINTBMMzUgNDBaIiBmaWxsPSIjOTVhNWE2Ii8+PHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5NWE1YTYiPjx0c3BhbiBkeT0iNCI+Tm8gaW1hZ2U8L3RzcGFuPjwvdGV4dD48L3N2Zz4='">` :
                `<div class="article-image-placeholder" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--light); border-radius: 4px; border: 1px solid var(--light-dark);">
                    <i class="fas fa-tshirt" style="font-size: 24px; color: var(--gray);"></i>
                </div>`;
            
            const statusClass = item.statut === 'CRITIQUE' ? 'status-danger' : 
                              item.statut === 'FAIBLE' ? 'status-warning' : 'status-success';
            
            return `
                <tr>
                    <td style="padding: 5px; text-align: center;">${imageHTML}</td>
                    <td>
                        <div style="font-weight: 600; margin-bottom: 5px;">${item.article}</div>
                        ${item.description ? `<div style="font-size: 0.8rem; color: var(--gray);">${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</div>` : ''}
                    </td>
                    <td><span class="status-badge">${item.type}</span></td>
                    <td style="text-align: center; font-weight: bold;" class="${item.quantite < 5 ? 'text-danger' : item.quantite < 15 ? 'text-warning' : ''}">
                        ${item.quantite}
                    </td>
                    <td style="text-align: right;">${formatCurrency(item.prixAchat)}</td>
                    <td style="text-align: right;">${formatCurrency(item.prixVente)}</td>
                    <td style="text-align: right; font-weight: bold;">${formatCurrency(item.valeur)}</td>
                    <td style="text-align: right;">${formatCurrency(item.investissement)}</td>
                    <td style="text-align: right; font-weight: bold; color: ${item.beneficePotentiel >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${formatCurrency(item.beneficePotentiel)}
                    </td>
                    <td style="text-align: center;">
                        <span class="${item.marge >= 0 ? 'text-success' : 'text-danger'}">
                            ${item.marge.toFixed(2)}%
                        </span>
                    </td>
                    <td><span class="status-badge ${statusClass}">${item.statut}</span></td>
                </tr>
            `;
        }).join('');
        
    } else if (type === 'revenue') {
        // En-têtes pour l'analyse des revenus (quotidienne)
        headers.innerHTML = `
            <th>Date</th>
            <th>Transactions</th>
            <th>Ventes</th>
            <th>Revenus</th>
            <th>Coût</th>
            <th>Bénéfice</th>
            <th>Panier Moyen</th>
            <th>Marge %</th>
        `;
        
        // Corps pour l'analyse des revenus
        body.innerHTML = data.quotidienne.map(item => {
            return `
                <tr>
                    <td>${item.date}</td>
                    <td style="text-align: center; font-weight: bold;">${item.transactions}</td>
                    <td style="text-align: center;">${item.ventes}</td>
                    <td style="text-align: right; font-weight: bold;">${formatCurrency(item.revenus)}</td>
                    <td style="text-align: right;">${formatCurrency(item.cout)}</td>
                    <td style="text-align: right; font-weight: bold; color: ${item.benefice >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${formatCurrency(item.benefice)}
                    </td>
                    <td style="text-align: right;">${formatCurrency(item.panierMoyen)}</td>
                    <td style="text-align: center;">
                        <span class="${item.marge >= 0 ? 'text-success' : 'text-danger'}">
                            ${item.marge.toFixed(2)}%
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }
}

function afficherStatsSummary(data, type, startDate, endDate) {
    const summaryContent = document.getElementById('statsSummaryContent');
    
    if (type === 'sales') {
        const totalVentes = data.reduce((sum, item) => sum + item.total, 0);
        const totalBenefice = data.reduce((sum, item) => sum + item.benefice, 0);
        const totalCout = data.reduce((sum, item) => sum + item.coutAchat, 0);
        const totalQuantite = data.reduce((sum, item) => sum + item.quantite, 0);
        const margeMoyenne = totalCout > 0 ? (totalBenefice / totalCout * 100) : 0;
        
        summaryContent.innerHTML = `
            <div class="grid-3">
                <div class="stats-card">
                    <h4><i class="fas fa-money-bill-wave"></i> Revenus totaux</h4>
                    <div class="stats-value">${formatCurrency(totalVentes)}</div>
                    <div class="stats-trend">Période: ${startDate} au ${endDate}</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-chart-line"></i> Bénéfice total</h4>
                    <div class="stats-value">${formatCurrency(totalBenefice)}</div>
                    <div class="stats-trend">Marge: ${margeMoyenne.toFixed(2)}%</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-shopping-cart"></i> Articles vendus</h4>
                    <div class="stats-value">${totalQuantite}</div>
                    <div class="stats-trend">${data.length} transactions</div>
                </div>
            </div>
        `;
        
    } else if (type === 'stock') {
        const totalValeur = data.reduce((sum, item) => sum + item.valeur, 0);
        const totalInvestissement = data.reduce((sum, item) => sum + item.investissement, 0);
        const totalBeneficePotentiel = data.reduce((sum, item) => sum + item.beneficePotentiel, 0);
        const totalQuantite = data.reduce((sum, item) => sum + item.quantite, 0);
        const margeMoyenne = totalInvestissement > 0 ? (totalBeneficePotentiel / totalInvestissement * 100) : 0;
        
        // Articles à faible stock
        const stockFaible = data.filter(item => item.quantite < 15).length;
        const stockCritique = data.filter(item => item.quantite < 5).length;
        
        summaryContent.innerHTML = `
            <div class="grid-3">
                <div class="stats-card">
                    <h4><i class="fas fa-boxes"></i> Valeur du stock</h4>
                    <div class="stats-value">${formatCurrency(totalValeur)}</div>
                    <div class="stats-trend">${data.length} articles</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-chart-line"></i> Bénéfice potentiel</h4>
                    <div class="stats-value">${formatCurrency(totalBeneficePotentiel)}</div>
                    <div class="stats-trend">Marge: ${margeMoyenne.toFixed(2)}%</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-exclamation-triangle"></i> Alertes stock</h4>
                    <div class="stats-value">${stockFaible}</div>
                    <div class="stats-trend">${stockCritique} critiques</div>
                </div>
            </div>
        `;
        
    } else if (type === 'revenue') {
        const revenusTotaux = data.quotidienne.reduce((sum, item) => sum + item.revenus, 0);
        const beneficeTotal = data.quotidienne.reduce((sum, item) => sum + item.benefice, 0);
        const transactionsTotales = data.quotidienne.reduce((sum, item) => sum + item.transactions, 0);
        const panierMoyenGlobal = transactionsTotales > 0 ? revenusTotaux / transactionsTotales : 0;
        
        // Meilleur jour
        const meilleurJour = data.quotidienne.reduce((max, item) => 
            item.revenus > max.revenus ? item : max, { revenus: 0, date: '' });
        
        summaryContent.innerHTML = `
            <div class="grid-3">
                <div class="stats-card">
                    <h4><i class="fas fa-money-bill-wave"></i> Revenus totaux</h4>
                    <div class="stats-value">${formatCurrency(revenusTotaux)}</div>
                    <div class="stats-trend">${data.quotidienne.length} jours</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-shopping-cart"></i> Panier moyen</h4>
                    <div class="stats-value">${formatCurrency(panierMoyenGlobal)}</div>
                    <div class="stats-trend">${transactionsTotales} transactions</div>
                </div>
                <div class="stats-card">
                    <h4><i class="fas fa-trophy"></i> Meilleur jour</h4>
                    <div class="stats-value">${formatCurrency(meilleurJour.revenus)}</div>
                    <div class="stats-trend">${meilleurJour.date}</div>
                </div>
            </div>
        `;
    }
}

function genererGraphique(data, type) {
    const ctx = document.getElementById('statsChart').getContext('2d');
    
    // Détruire le graphique existant
    if (statsChart) {
        statsChart.destroy();
    }
    
    if (type === 'sales') {
        // Graphique pour les ventes : ventes par jour
        const ventesParJour = {};
        data.forEach(item => {
            if (!ventesParJour[item.date]) {
                ventesParJour[item.date] = 0;
            }
            ventesParJour[item.date] += item.total;
        });
        
        const jours = Object.keys(ventesParJour);
        const montants = Object.values(ventesParJour);
        
        statsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: jours,
                datasets: [{
                    label: 'Revenus par jour (FC)',
                    data: montants,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Évolution des revenus par jour'
                    },
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
    } else if (type === 'stock') {
        // Graphique pour le stock : répartition par type
        const repartitionParType = {};
        data.forEach(item => {
            if (!repartitionParType[item.type]) {
                repartitionParType[item.type] = 0;
            }
            repartitionParType[item.type] += item.valeur;
        });
        
        const types = Object.keys(repartitionParType);
        const valeurs = Object.values(repartitionParType);
        const couleurs = generateColors(types.length);
        
        statsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: types,
                datasets: [{
                    label: 'Valeur du stock par type',
                    data: valeurs,
                    backgroundColor: couleurs,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Répartition du stock par type'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Ajouter la légende
        const legendContainer = document.createElement('div');
        legendContainer.className = 'chart-legend';
        types.forEach((type, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${couleurs[index]};"></div>
                <span>${type}</span>
                <span style="margin-left: auto; font-weight: bold;">${formatCurrency(valeurs[index])}</span>
            `;
            legendContainer.appendChild(legendItem);
        });
        
        // Ajouter après le canvas
        const canvasContainer = document.querySelector('.canvas-container');
        const existingLegend = canvasContainer.querySelector('.chart-legend');
        if (existingLegend) {
            existingLegend.remove();
        }
        canvasContainer.appendChild(legendContainer);
        
    } else if (type === 'revenue') {
        // Graphique pour les revenus : bénéfice par jour
        const beneficesParJour = {};
        data.quotidienne.forEach(item => {
            beneficesParJour[item.date] = item.benefice;
        });
        
        const jours = Object.keys(beneficesParJour);
        const benefices = Object.values(beneficesParJour);
        
        // Couleurs selon le bénéfice
        const backgroundColors = benefices.map(b => 
            b >= 0 ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)'
        );
        const borderColors = benefices.map(b => 
            b >= 0 ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)'
        );
        
        statsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: jours,
                datasets: [{
                    label: 'Bénéfice par jour (FC)',
                    data: benefices,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Bénéfice quotidien'
                    },
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
}

function generateColors(count) {
    const colors = [
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
        '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad',
        '#2c3e50', '#f1c40f', '#e67e22', '#7f8c8d', '#34495e'
    ];
    
    if (count <= colors.length) {
        return colors.slice(0, count);
    }
    
    // Générer des couleurs si on en a besoin plus
    const generatedColors = [];
    for (let i = 0; i < count; i++) {
        const hue = (i * 137.508) % 360; // Utiliser l'angle d'or
        generatedColors.push(`hsl(${hue}, 70%, 65%)`);
    }
    return generatedColors;
}

function afficherStatsAvancees(data, type) {
    const advancedStatsContent = document.getElementById('advancedStatsContent');
    
    if (type === 'sales') {
        // Calculs avancés pour les ventes AVEC IMAGES
        const top5Articles = [...data]
            .sort((a, b) => b.quantite - a.quantite)
            .slice(0, 5);
        
        const top5Revenus = [...data]
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);
        
        const meilleursVendeurs = {};
        data.forEach(item => {
            if (!meilleursVendeurs[item.vendeur]) {
                meilleursVendeurs[item.vendeur] = {
                    total: 0,
                    transactions: 0,
                    articles: new Set()
                };
            }
            meilleursVendeurs[item.vendeur].total += item.total;
            meilleursVendeurs[item.vendeur].transactions += 1;
            meilleursVendeurs[item.vendeur].articles.add(item.article);
        });
        
        const top3Vendeurs = Object.entries(meilleursVendeurs)
            .sort((a, b) => b[1].total - a[1].total)
            .slice(0, 3);
        
        // Articles par type
        const articlesParType = {};
        data.forEach(item => {
            if (!articlesParType[item.type]) {
                articlesParType[item.type] = {
                    quantite: 0,
                    total: 0,
                    benefice: 0
                };
            }
            articlesParType[item.type].quantite += item.quantite;
            articlesParType[item.type].total += item.total;
            articlesParType[item.type].benefice += item.benefice;
        });
        
        const meilleursTypes = Object.entries(articlesParType)
            .sort((a, b) => b[1].total - a[1].total)
            .slice(0, 3);
        
        advancedStatsContent.innerHTML = `
            <div class="stats-card">
                <h4><i class="fas fa-medal"></i> Top 5 articles (ventes)</h4>
                <div style="margin-top: 15px;">
                    ${top5Articles.map((item, index) => {
                        const imageHTML = item.image ? 
                            `<img src="${item.image}" alt="${item.article}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark); margin-right: 10px;"
                                 onerror="this.style.display='none'">` :
                            `<div style="width: 40px; height: 40px; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--gray);">
                                <i class="fas fa-tshirt"></i>
                            </div>`;
                        
                        const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#3498db', '#2ecc71'];
                        const medalColor = medalColors[index] || '#95a5a6';
                        
                        return `
                            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${medalColor};">
                                <span style="font-weight: bold; margin-right: 10px; color: ${medalColor}; min-width: 20px; text-align: center;">${index + 1}</span>
                                ${imageHTML}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">${item.article}</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <span style="color: #666;">${item.quantite} unités</span>
                                        <span style="color: var(--primary); font-weight: bold;">${formatCurrency(item.total)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-money-bill-wave"></i> Top 5 articles (revenus)</h4>
                <div style="margin-top: 15px;">
                    ${top5Revenus.map((item, index) => {
                        const imageHTML = item.image ? 
                            `<img src="${item.image}" alt="${item.article}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark); margin-right: 10px;"
                                 onerror="this.style.display='none'">` :
                            `<div style="width: 40px; height: 40px; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--gray);">
                                <i class="fas fa-tshirt"></i>
                            </div>`;
                        
                        const margeColor = item.marge > 30 ? 'var(--success)' : 
                                         item.marge > 10 ? 'var(--warning)' : 'var(--danger)';
                        
                        return `
                            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <span style="font-weight: bold; margin-right: 10px; color: var(--success); min-width: 20px; text-align: center;">${index + 1}</span>
                                ${imageHTML}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">${item.article}</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <span style="color: #666;">${formatCurrency(item.total)}</span>
                                        <span style="color: ${margeColor}; font-weight: bold;">${item.marge.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-user-tie"></i> Top 3 vendeurs</h4>
                <div style="margin-top: 15px;">
                    ${top3Vendeurs.map(([vendeur, stats], index) => {
                        const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                        const articlesCount = stats.articles.size;
                        
                        return `
                            <div style="margin-bottom: 10px; padding: 12px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${medalColors[index]};">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 30px; height: 30px; background: ${medalColors[index]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; font-weight: bold; font-size: 0.9rem;">
                                        ${index + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 1rem;">${vendeur}</div>
                                        <div style="font-size: 0.8rem; color: #666;">
                                            ${stats.transactions} transactions • ${articlesCount} articles
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding-top: 8px; border-top: 1px dashed #ddd;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                        ${formatCurrency(stats.total)}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666;">Chiffre d'affaires</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    ${meilleursTypes.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h5 style="margin: 0 0 10px 0; color: var(--secondary); font-size: 0.9rem;">
                                <i class="fas fa-tags"></i> Catégories populaires
                            </h5>
                            ${meilleursTypes.map(([type, stats]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px 0;">
                                    <span style="font-weight: 600; font-size: 0.9rem;">${type}</span>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: var(--primary);">${formatCurrency(stats.total)}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${stats.quantite} ventes</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
    } else if (type === 'stock') {
        // Calculs avancés pour le stock AVEC IMAGES
        const articlesRentables = [...data]
            .filter(item => item.marge > 20)
            .sort((a, b) => b.marge - a.marge)
            .slice(0, 5);
        
        const articlesFaibleStock = [...data]
            .filter(item => item.quantite < 15)
            .sort((a, b) => a.quantite - b.quantite)
            .slice(0, 5);
        
        const articlesValeur = [...data]
            .sort((a, b) => b.valeur - a.valeur)
            .slice(0, 5);
        
        // Analyse par type
        const stockParType = {};
        data.forEach(item => {
            if (!stockParType[item.type]) {
                stockParType[item.type] = {
                    quantite: 0,
                    valeur: 0,
                    articles: 0,
                    faibleStock: 0
                };
            }
            stockParType[item.type].quantite += item.quantite;
            stockParType[item.type].valeur += item.valeur;
            stockParType[item.type].articles += 1;
            if (item.quantite < 15) {
                stockParType[item.type].faibleStock += 1;
            }
        });
        
        const typesTendance = Object.entries(stockParType)
            .sort((a, b) => b[1].valeur - a[1].valeur)
            .slice(0, 3);
        
        advancedStatsContent.innerHTML = `
            <div class="stats-card">
                <h4><i class="fas fa-chart-line"></i> Top 5 marges</h4>
                <div style="margin-top: 15px;">
                    ${articlesRentables.map((item, index) => {
                        const imageHTML = item.image ? 
                            `<img src="${item.image}" alt="${item.article}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark); margin-right: 10px;"
                                 onerror="this.style.display='none'">` :
                            `<div style="width: 40px; height: 40px; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--gray);">
                                <i class="fas fa-tshirt"></i>
                            </div>`;
                        
                        const margeColor = item.marge > 50 ? 'var(--success)' : 
                                         item.marge > 30 ? '#27ae60' : 
                                         item.marge > 20 ? '#f39c12' : '#e74c3c';
                        
                        return `
                            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${margeColor};">
                                <span style="font-weight: bold; margin-right: 10px; color: ${margeColor}; min-width: 20px; text-align: center;">${index + 1}</span>
                                ${imageHTML}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">${item.article}</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <span style="color: #666;">${item.type}</span>
                                        <span style="color: ${margeColor}; font-weight: bold;">${item.marge.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-exclamation-triangle"></i> Stock faible</h4>
                <div style="margin-top: 15px;">
                    ${articlesFaibleStock.map((item, index) => {
                        const imageHTML = item.image ? 
                            `<img src="${item.image}" alt="${item.article}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark); margin-right: 10px;"
                                 onerror="this.style.display='none'">` :
                            `<div style="width: 40px; height: 40px; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--gray);">
                                <i class="fas fa-tshirt"></i>
                            </div>`;
                        
                        const quantiteColor = item.quantite < 5 ? '#e74c3c' : 
                                            item.quantite < 10 ? '#f39c12' : '#f1c40f';
                        const statutText = item.quantite < 5 ? 'CRITIQUE' : 
                                         item.quantite < 10 ? 'FAIBLE' : 'MOYEN';
                        
                        return `
                            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${quantiteColor};">
                                <span style="font-weight: bold; margin-right: 10px; color: ${quantiteColor}; min-width: 20px; text-align: center;">${index + 1}</span>
                                ${imageHTML}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">${item.article}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                        <span style="color: #666;">${item.type}</span>
                                        <div>
                                            <span style="color: ${quantiteColor}; font-weight: bold; margin-right: 5px;">
                                                ${item.quantite} unités
                                            </span>
                                            <span style="background: ${quantiteColor}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                                                ${statutText}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    ${typesTendance.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h5 style="margin: 0 0 10px 0; color: var(--secondary); font-size: 0.9rem;">
                                <i class="fas fa-chart-pie"></i> Stock par type
                            </h5>
                            ${typesTendance.map(([type, stats]) => {
                                const pourcentageFaible = stats.articles > 0 ? 
                                    (stats.faibleStock / stats.articles * 100).toFixed(1) : 0;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px 0;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.9rem;">${type}</div>
                                            <div style="font-size: 0.8rem; color: #666;">
                                                ${stats.articles} articles • ${pourcentageFaible}% faible
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: bold; color: var(--primary);">${formatCurrency(stats.valeur)}</div>
                                            <div style="font-size: 0.8rem; color: #666;">${stats.quantite} unités</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-gem"></i> Articles de valeur</h4>
                <div style="margin-top: 15px;">
                    ${articlesValeur.map((item, index) => {
                        const imageHTML = item.image ? 
                            `<img src="${item.image}" alt="${item.article}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--light-dark); margin-right: 10px;"
                                 onerror="this.style.display='none'">` :
                            `<div style="width: 40px; height: 40px; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--gray);">
                                <i class="fas fa-tshirt"></i>
                            </div>`;
                        
                        const valeurParUnite = item.quantite > 0 ? item.valeur / item.quantite : 0;
                        
                        return `
                            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <span style="font-weight: bold; margin-right: 10px; color: var(--primary); min-width: 20px; text-align: center;">${index + 1}</span>
                                ${imageHTML}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">${item.article}</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <div>
                                            <div style="color: #666;">${item.type}</div>
                                            <div style="color: #666; font-size: 0.75rem;">
                                                ${item.quantite} × ${formatCurrency(valeurParUnite)}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: bold; color: var(--primary); font-size: 1rem;">
                                                ${formatCurrency(item.valeur)}
                                            </div>
                                            <div style="color: #666; font-size: 0.75rem;">
                                                Valeur totale
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div style="margin-top: 15px; padding: 10px; background: linear-gradient(135deg, var(--primary-light), var(--info-light)); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: var(--primary);">Valeur totale du stock</div>
                                <div style="font-size: 0.8rem; color: var(--gray-dark);">${data.length} articles analysés</div>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                ${formatCurrency(data.reduce((sum, item) => sum + item.valeur, 0))}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } else if (type === 'revenue') {
        // Calculs avancés pour l'analyse des revenus
        const meilleursArticles = [...data.parArticle]
            .sort((a, b) => b.revenus - a.revenus)
            .slice(0, 5);
        
        const meilleuresMarges = [...data.parArticle]
            .filter(item => item.cout > 0)
            .sort((a, b) => b.marge - a.marge)
            .slice(0, 5);
        
        const joursSemaine = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const revenusParJour = {};
        data.quotidienne.forEach(item => {
            const date = new Date(item.date.split('/').reverse().join('-'));
            const jour = joursSemaine[date.getDay()];
            if (!revenusParJour[jour]) {
                revenusParJour[jour] = { 
                    total: 0, 
                    count: 0,
                    transactions: 0,
                    benefice: 0 
                };
            }
            revenusParJour[jour].total += item.revenus;
            revenusParJour[jour].count += 1;
            revenusParJour[jour].transactions += item.transactions;
            revenusParJour[jour].benefice += item.benefice;
        });
        
        const meilleursJours = Object.entries(revenusParJour)
            .map(([jour, stats]) => ({
                jour,
                moyenne: stats.total / stats.count,
                transactionsMoyenne: stats.transactions / stats.count,
                beneficeMoyen: stats.benefice / stats.count
            }))
            .sort((a, b) => b.moyenne - a.moyenne)
            .slice(0, 3);
        
        // Tendances (meilleur jour vs pire jour)
        const meilleurJourPerf = data.quotidienne.reduce((max, item) => 
            item.revenus > max.revenus ? item : max, { revenus: 0, date: '' });
        
        const pireJourPerf = data.quotidienne.reduce((min, item) => 
            item.revenus < min.revenus ? item : min, { revenus: Infinity, date: '' });
        
        advancedStatsContent.innerHTML = `
            <div class="stats-card">
                <h4><i class="fas fa-chart-bar"></i> Top 5 revenus articles</h4>
                <div style="margin-top: 15px;">
                    ${meilleursArticles.map((item, index) => {
                        const partMarcheColor = item.partMarche > 20 ? 'var(--success)' : 
                                              item.partMarche > 10 ? 'var(--warning)' : 'var(--gray)';
                        
                        return `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <div style="display: flex; align-items: center;">
                                        <span style="font-weight: bold; margin-right: 10px; color: var(--primary); min-width: 20px; text-align: center;">${index + 1}</span>
                                        <div style="font-weight: 600; font-size: 0.9rem;">${item.article}</div>
                                    </div>
                                    <span style="background: ${partMarcheColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                                        ${item.partMarche.toFixed(1)}%
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                                    <div>
                                        <div style="color: #666;">${item.quantite} unités vendues</div>
                                        <div style="color: var(--success); font-weight: bold;">${formatCurrency(item.benefice)} bénéfice</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: var(--primary);">${formatCurrency(item.revenus)}</div>
                                        <div style="color: #666; font-size: 0.8rem;">${item.marge.toFixed(1)}% marge</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-percentage"></i> Top 5 marges articles</h4>
                <div style="margin-top: 15px;">
                    ${meilleuresMarges.map((item, index) => {
                        const margeColor = item.marge > 50 ? 'var(--success)' : 
                                         item.marge > 30 ? '#27ae60' : 
                                         item.marge > 20 ? '#f39c12' : '#e74c3c';
                        
                        return `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${margeColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <div style="display: flex; align-items: center;">
                                        <span style="font-weight: bold; margin-right: 10px; color: ${margeColor}; min-width: 20px; text-align: center;">${index + 1}</span>
                                        <div style="font-weight: 600; font-size: 0.9rem;">${item.article}</div>
                                    </div>
                                    <span style="background: ${margeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                                        ${item.marge.toFixed(1)}%
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                                    <div>
                                        <div style="color: #666;">${item.quantite} unités</div>
                                        <div style="color: ${margeColor}; font-weight: bold;">${formatCurrency(item.benefice)} bénéfice</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: var(--primary);">${formatCurrency(item.revenus)}</div>
                                        <div style="color: #666; font-size: 0.8rem;">CA</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="stats-card">
                <h4><i class="fas fa-calendar-day"></i> Analyse par jour</h4>
                <div style="margin-top: 15px;">
                    ${meilleursJours.map((item, index) => {
                        const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                        
                        return `
                            <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${medalColors[index]};">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="width: 30px; height: 30px; background: ${medalColors[index]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; font-weight: bold;">
                                        ${index + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 1rem;">${item.jour}</div>
                                        <div style="font-size: 0.8rem; color: #666;">
                                            ${item.transactionsMoyenne.toFixed(1)} transactions moyennes
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--primary);">
                                            ${formatCurrency(item.moyenne)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #666;">CA moyen</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--success);">
                                            ${formatCurrency(item.beneficeMoyen)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #666;">Bénéfice moyen</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, var(--info-light), var(--primary-light)); border-radius: 4px;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">🎯 Performance extrême</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 4px; border: 1px solid var(--success);">
                                <div style="font-weight: bold; color: var(--success); font-size: 0.9rem;">Meilleur jour</div>
                                <div style="font-size: 1rem; font-weight: bold;">${formatCurrency(meilleurJourPerf.revenus)}</div>
                                <div style="font-size: 0.8rem; color: #666;">${meilleurJourPerf.date}</div>
                            </div>
                            <div style="background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 4px; border: 1px solid var(--danger);">
                                <div style="font-weight: bold; color: var(--danger); font-size: 0.9rem;">Plus bas</div>
                                <div style="font-size: 1rem; font-weight: bold;">${formatCurrency(pireJourPerf.revenus)}</div>
                                <div style="font-size: 0.8rem; color: #666;">${pireJourPerf.date}</div>
                            </div>
                        </div>
                        ${meilleurJourPerf.revenus > 0 && pireJourPerf.revenus > 0 ? `
                            <div style="margin-top: 10px; text-align: center; font-size: 0.85rem; color: var(--gray-dark);">
                                Écart: ${formatCurrency(meilleurJourPerf.revenus - pireJourPerf.revenus)} 
                                (${((meilleurJourPerf.revenus / pireJourPerf.revenus - 1) * 100).toFixed(0)}%)
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }
}
async function exporterRapportPDF() {
    if (!currentStatsData || !statsPeriod) {
        showAlert('❌ Aucune donnée à exporter', 'warning');
        return;
    }
    
    try {
        showLoading(true, 'Génération du PDF...');
        
        const doc = new jsPDF('landscape');
        const type = statsPeriod.type;
        const start = statsPeriod.start;
        const end = statsPeriod.end;
        const category = statsPeriod.category || 'Toutes catégories';
        
        // En-tête
        doc.setFontSize(24);
        doc.setTextColor(52, 152, 219);
        doc.text("📊 RAPPORT DÉTAILLÉ - TheoVêt", 148, 20, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Période: ${start} au ${end} | Catégorie: ${category}`, 148, 30, { align: "center" });
        doc.text(`Type: ${getTypeName(type)} | Généré par: ${userData.name}`, 148, 36, { align: "center" });
        
        // Résumé
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text("📈 RÉSUMÉ", 20, 50);
        
        doc.setFontSize(10);
        doc.text(`Date de génération: ${new Date().toLocaleString('fr-FR')}`, 20, 58);
        doc.text(`Nombre d'entrées: ${getDataCount(currentStatsData, type)}`, 20, 64);
        
        // Tableau principal
        let startY = 75;
        
        if (type === 'sales') {
            const tableData = currentStatsData.map(item => [
                item.date,
                item.article.substring(0, 20),
                item.type,
                item.quantite.toString(),
                formatCurrency(item.prixUnitaire),
                formatCurrency(item.total),
                formatCurrency(item.benefice),
                `${item.marge.toFixed(1)}%`
            ]);
            
            doc.autoTable({
                startY: startY,
                head: [['Date', 'Article', 'Type', 'Qty', 'Prix Unit', 'Total', 'Bénéfice', 'Marge']],
                body: tableData,
                theme: 'grid',
                headStyles: { 
                    fillColor: [52, 152, 219], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 9
                },
                styles: { 
                    fontSize: 8,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 20 }
                }
            });
            
        } else if (type === 'stock') {
            const tableData = currentStatsData.map(item => [
                item.article.substring(0, 20),
                item.type,
                item.quantite.toString(),
                formatCurrency(item.prixAchat),
                formatCurrency(item.prixVente),
                formatCurrency(item.valeur),
                formatCurrency(item.beneficePotentiel),
                `${item.marge.toFixed(1)}%`
            ]);
            
            doc.autoTable({
                startY: startY,
                head: [['Article', 'Type', 'Qty', 'Prix Achat', 'Prix Vente', 'Valeur', 'Bénéfice Pot.', 'Marge']],
                body: tableData,
                theme: 'grid',
                headStyles: { 
                    fillColor: [46, 204, 113], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 9
                },
                styles: { 
                    fontSize: 8,
                    cellPadding: 3
                }
            });
            
        } else if (type === 'revenue') {
            const tableData = currentStatsData.quotidienne.map(item => [
                item.date,
                item.transactions.toString(),
                item.ventes.toString(),
                formatCurrency(item.revenus),
                formatCurrency(item.cout),
                formatCurrency(item.benefice),
                formatCurrency(item.panierMoyen),
                `${item.marge.toFixed(1)}%`
            ]);
            
            doc.autoTable({
                startY: startY,
                head: [['Date', 'Trans.', 'Ventes', 'Revenus', 'Coût', 'Bénéfice', 'Panier Moyen', 'Marge']],
                body: tableData,
                theme: 'grid',
                headStyles: { 
                    fillColor: [155, 89, 182], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 9
                },
                styles: { 
                    fontSize: 8,
                    cellPadding: 3
                }
            });
        }
        
        // Statistiques de synthèse
        const finalY = doc.lastAutoTable.finalY + 15;
        
        doc.setFontSize(12);
        doc.setTextColor(52, 152, 219);
        doc.text("📊 SYNTHÈSE", 20, finalY);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        const stats = getStatsSummary(currentStatsData, type);
        stats.forEach((stat, index) => {
            doc.text(stat, 20, finalY + 10 + (index * 6));
        });
        
        // Pied de page
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text("TheoVêt - Système de gestion avancé", 148, 190, { align: "center" });
        doc.text("www.theovet.com | contact@theovet.com", 148, 195, { align: "center" });
        
        const fileName = `rapport_${type}_${start}_${end}.pdf`.replace(/\//g, '-');
        doc.save(fileName);
        
        showAlert(`✅ Rapport PDF exporté: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erreur export PDF:', error);
        showAlert('❌ Erreur lors de l\'export PDF', 'danger');
    } finally {
        showLoading(false);
    }
}

async function exporterRapportExcel() {
    if (!currentStatsData || !statsPeriod) {
        showAlert('❌ Aucune donnée à exporter', 'warning');
        return;
    }
    
    try {
        showLoading(true, 'Génération du fichier Excel...');
        
        const type = statsPeriod.type;
        const start = statsPeriod.start;
        const end = statsPeriod.end;
        const category = statsPeriod.category || 'Toutes catégories';
        
        // Créer le workbook
        const wb = XLSX.utils.book_new();
        
        // Feuille de données principales
        let ws_data = [];
        
        // En-tête du rapport
        ws_data.push(['RAPPORT DÉTAILLÉ - TheoVêt']);
        ws_data.push([`Période: ${start} au ${end}`]);
        ws_data.push([`Catégorie: ${category}`]);
        ws_data.push([`Type: ${getTypeName(type)}`]);
        ws_data.push([`Généré par: ${userData.name}`]);
        ws_data.push([`Date de génération: ${new Date().toLocaleString('fr-FR')}`]);
        ws_data.push([]); // Ligne vide
        
        if (type === 'sales') {
            ws_data.push(['Date', 'Article', 'Type', 'Quantité', 'Prix Unitaire', 'Total', 'Coût', 'Bénéfice', 'Marge %', 'Vendeur']);
            
            currentStatsData.forEach(item => {
                ws_data.push([
                    item.date,
                    item.article,
                    item.type,
                    item.quantite,
                    item.prixUnitaire,
                    item.total,
                    item.coutAchat,
                    item.benefice,
                    item.marge.toFixed(2) + '%',
                    item.vendeur
                ]);
            });
            
        } else if (type === 'stock') {
            ws_data.push(['Article', 'Type', 'Quantité', 'Prix Achat', 'Prix Vente', 'Valeur', 'Investissement', 'Bénéfice Potentiel', 'Marge %', 'Statut']);
            
            currentStatsData.forEach(item => {
                ws_data.push([
                    item.article,
                    item.type,
                    item.quantite,
                    item.prixAchat,
                    item.prixVente,
                    item.valeur,
                    item.investissement,
                    item.beneficePotentiel,
                    item.marge.toFixed(2) + '%',
                    item.statut
                ]);
            });
            
        } else if (type === 'revenue') {
            ws_data.push(['Date', 'Transactions', 'Ventes', 'Revenus', 'Coût', 'Bénéfice', 'Panier Moyen', 'Marge %']);
            
            currentStatsData.quotidienne.forEach(item => {
                ws_data.push([
                    item.date,
                    item.transactions,
                    item.ventes,
                    item.revenus,
                    item.cout,
                    item.benefice,
                    item.panierMoyen,
                    item.marge.toFixed(2) + '%'
                ]);
            });
        }
        
        // Ajouter les totaux
        ws_data.push([]);
        ws_data.push(['STATISTIQUES DE SYNTHÈSE']);
        
        const stats = getStatsSummary(currentStatsData, type);
        stats.forEach(stat => {
            ws_data.push([stat]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // Ajuster la largeur des colonnes
        const colWidths = [];
        for (let i = 0; i < ws_data[7].length; i++) {
            colWidths.push({ wch: 20 });
        }
        ws['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, 'Rapport');
        
        // Générer et télécharger
        const fileName = `rapport_${type}_${start}_${end}.xlsx`.replace(/\//g, '-');
        XLSX.writeFile(wb, fileName);
        
        showAlert(`✅ Rapport Excel exporté: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erreur export Excel:', error);
        showAlert('❌ Erreur lors de l\'export Excel', 'danger');
    } finally {
        showLoading(false);
    }
}

function imprimerRapport() {
    if (!currentStatsData || !statsPeriod) {
        showAlert('❌ Aucune donnée à imprimer', 'warning');
        return;
    }
    
    // Créer une fenêtre d'impression
    const printWindow = window.open('', '_blank');
    
    const type = statsPeriod.type;
    const start = statsPeriod.start;
    const end = statsPeriod.end;
    const category = statsPeriod.category || 'Toutes catégories';
    
    let content = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Rapport TheoVêt - ${start} au ${end}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #3498db;
                    margin: 0;
                }
                .info {
                    color: #666;
                    font-size: 14px;
                    margin: 5px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                th {
                    background: #3498db;
                    color: white;
                    padding: 10px;
                    text-align: left;
                    font-weight: bold;
                }
                td {
                    padding: 8px;
                    border-bottom: 1px solid #ddd;
                }
                tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .summary {
                    margin-top: 30px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 5px;
                }
                .summary h3 {
                    color: #2c3e50;
                    margin-top: 0;
                }
                .footer {
                    text-align: center;
                    margin-top: 40px;
                    color: #95a5a6;
                    font-size: 12px;
                }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>📊 RAPPORT DÉTAILLÉ - TheoVêt</h1>
                <div class="info">Période: ${start} au ${end}</div>
                <div class="info">Catégorie: ${category}</div>
                <div class="info">Type: ${getTypeName(type)}</div>
                <div class="info">Généré par: ${userData.name}</div>
                <div class="info">Date de génération: ${new Date().toLocaleString('fr-FR')}</div>
            </div>
    `;
    
    if (type === 'sales') {
        content += `
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Article</th>
                        <th>Type</th>
                        <th>Quantité</th>
                        <th>Prix Unitaire</th>
                        <th>Total</th>
                        <th>Coût</th>
                        <th>Bénéfice</th>
                        <th>Marge %</th>
                        <th>Vendeur</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        currentStatsData.forEach(item => {
            content += `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.article}</td>
                    <td>${item.type}</td>
                    <td>${item.quantite}</td>
                    <td>${formatCurrency(item.prixUnitaire)}</td>
                    <td>${formatCurrency(item.total)}</td>
                    <td>${formatCurrency(item.coutAchat)}</td>
                    <td style="color: ${item.benefice >= 0 ? '#27ae60' : '#e74c3c'}">
                        ${formatCurrency(item.benefice)}
                    </td>
                    <td>${item.marge.toFixed(2)}%</td>
                    <td>${item.vendeur}</td>
                </tr>
            `;
        });
        
        content += `
                </tbody>
            </table>
        `;
        
    } else if (type === 'stock') {
        content += `
            <table>
                <thead>
                    <tr>
                        <th>Article</th>
                        <th>Type</th>
                        <th>Quantité</th>
                        <th>Prix Achat</th>
                        <th>Prix Vente</th>
                        <th>Valeur</th>
                        <th>Investissement</th>
                        <th>Bénéfice Potentiel</th>
                        <th>Marge %</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        currentStatsData.forEach(item => {
            const statusColor = item.statut === 'CRITIQUE' ? '#e74c3c' : 
                               item.statut === 'FAIBLE' ? '#f39c12' : '#27ae60';
            
            content += `
                <tr>
                    <td>${item.article}</td>
                    <td>${item.type}</td>
                    <td>${item.quantite}</td>
                    <td>${formatCurrency(item.prixAchat)}</td>
                    <td>${formatCurrency(item.prixVente)}</td>
                    <td>${formatCurrency(item.valeur)}</td>
                    <td>${formatCurrency(item.investissement)}</td>
                    <td style="color: ${item.beneficePotentiel >= 0 ? '#27ae60' : '#e74c3c'}">
                        ${formatCurrency(item.beneficePotentiel)}
                    </td>
                    <td>${item.marge.toFixed(2)}%</td>
                    <td style="color: ${statusColor}">${item.statut}</td>
                </tr>
            `;
        });
        
        content += `
                </tbody>
            </table>
        `;
        
    } else if (type === 'revenue') {
        content += `
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Transactions</th>
                        <th>Ventes</th>
                        <th>Revenus</th>
                        <th>Coût</th>
                        <th>Bénéfice</th>
                        <th>Panier Moyen</th>
                        <th>Marge %</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        currentStatsData.quotidienne.forEach(item => {
            content += `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.transactions}</td>
                    <td>${item.ventes}</td>
                    <td>${formatCurrency(item.revenus)}</td>
                    <td>${formatCurrency(item.cout)}</td>
                    <td style="color: ${item.benefice >= 0 ? '#27ae60' : '#e74c3c'}">
                        ${formatCurrency(item.benefice)}
                    </td>
                    <td>${formatCurrency(item.panierMoyen)}</td>
                    <td>${item.marge.toFixed(2)}%</td>
                </tr>
            `;
        });
        
        content += `
                </tbody>
            </table>
        `;
    }
    
    // Ajouter le résumé
    content += `
        <div class="summary">
            <h3>📈 SYNTHÈSE</h3>
    `;
    
    const stats = getStatsSummary(currentStatsData, type);
    stats.forEach(stat => {
        content += `<p>${stat}</p>`;
    });
    
    content += `
        </div>
        
        <div class="footer">
            <p>TheoVêt - Système de gestion avancé</p>
            <p>www.theovet.com | contact@theovet.com</p>
        </div>
        
        <div class="no-print" style="text-align: center; margin-top: 30px;">
            <button onclick="window.print()" style="
                padding: 10px 20px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">
                🖨️ Imprimer le rapport
            </button>
            <button onclick="window.close()" style="
                padding: 10px 20px;
                background: #95a5a6;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-left: 10px;
            ">
                ✕ Fermer
            </button>
        </div>
    `;
    
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    
    // Démarrer l'impression après un court délai
    setTimeout(() => {
        printWindow.print();
    }, 500);
}

// Fonctions utilitaires pour les statistiques
function getTypeName(type) {
    const names = {
        'sales': 'Rapport des ventes',
        'stock': 'Rapport du stock',
        'revenue': 'Analyse des revenus'
    };
    return names[type] || type;
}

function getDataCount(data, type) {
    if (type === 'revenue') {
        return data.quotidienne ? data.quotidienne.length : 0;
    }
    return Array.isArray(data) ? data.length : 0;
}

function getStatsSummary(data, type) {
    const stats = [];
    
    if (type === 'sales') {
        const totalVentes = data.reduce((sum, item) => sum + item.total, 0);
        const totalBenefice = data.reduce((sum, item) => sum + item.benefice, 0);
        const totalQuantite = data.reduce((sum, item) => sum + item.quantite, 0);
        const margeMoyenne = totalVentes > 0 ? (totalBenefice / totalVentes * 100) : 0;
        
        stats.push(`📊 Total des ventes: ${formatCurrency(totalVentes)}`);
        stats.push(`💰 Bénéfice total: ${formatCurrency(totalBenefice)}`);
        stats.push(`📦 Articles vendus: ${totalQuantite}`);
        stats.push(`📈 Marge moyenne: ${margeMoyenne.toFixed(2)}%`);
        stats.push(`📋 Nombre de transactions: ${data.length}`);
        
    } else if (type === 'stock') {
        const totalValeur = data.reduce((sum, item) => sum + item.valeur, 0);
        const totalBeneficePotentiel = data.reduce((sum, item) => sum + item.beneficePotentiel, 0);
        const totalQuantite = data.reduce((sum, item) => sum + item.quantite, 0);
        const stockFaible = data.filter(item => item.quantite < 15).length;
        const stockCritique = data.filter(item => item.quantite < 5).length;
        
        stats.push(`📦 Valeur totale du stock: ${formatCurrency(totalValeur)}`);
        stats.push(`💰 Bénéfice potentiel: ${formatCurrency(totalBeneficePotentiel)}`);
        stats.push(`🔢 Nombre total d'articles: ${totalQuantite}`);
        stats.push(`⚠️ Articles en stock faible: ${stockFaible}`);
        stats.push(`🚨 Articles en stock critique: ${stockCritique}`);
        
    } else if (type === 'revenue') {
        const totalRevenus = data.quotidienne.reduce((sum, item) => sum + item.revenus, 0);
        const totalBenefice = data.quotidienne.reduce((sum, item) => sum + item.benefice, 0);
        const totalTransactions = data.quotidienne.reduce((sum, item) => sum + item.transactions, 0);
        const panierMoyen = totalTransactions > 0 ? totalRevenus / totalTransactions : 0;
        const margeMoyenne = totalRevenus > 0 ? (totalBenefice / totalRevenus * 100) : 0;
        
        stats.push(`📊 Revenus totaux: ${formatCurrency(totalRevenus)}`);
        stats.push(`💰 Bénéfice total: ${formatCurrency(totalBenefice)}`);
        stats.push(`🛒 Panier moyen: ${formatCurrency(panierMoyen)}`);
        stats.push(`📈 Marge moyenne: ${margeMoyenne.toFixed(2)}%`);
        stats.push(`📋 Nombre de jours: ${data.quotidienne.length}`);
    }
    
    return stats;
}

// Fonction pour obtenir le statut du stock
function getStockStatus(quantity) {
    if (quantity === 0) return 'RUPTURE';
    if (quantity < 5) return 'CRITIQUE';
    if (quantity < 15) return 'FAIBLE';
    if (quantity < 30) return 'MOYEN';
    return 'BON';
}

// Exposer les fonctions globales
window.genererRapportParPeriode = genererRapportParPeriode;
window.toggleStatsFilters = toggleStatsFilters;
window.exporterRapportPDF = exporterRapportPDF;
window.exporterRapportExcel = exporterRapportExcel;
window.imprimerRapport = imprimerRapport;

  </script>
</body>
</html>   ´
